{% extends "base.html" %}

{% block title %}Solana Performance{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .page-container { padding: 20px; }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #f9fafb;
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: #9ca3af;
        font-size: 1rem;
    }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: none; }
    .btn-secondary { background: #374151; color: #e5e7eb; }
    .btn-secondary:hover { background: #4b5563; }

    /* Key Metrics Cards */
    .metrics-hero {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .metric-card {
        background: linear-gradient(145deg, #1f2937, #111827);
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }

    .metric-card.highlight {
        border-top: 3px solid #8b5cf6;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #f9fafb;
    }

    .metric-sub {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 4px;
    }

    .positive { color: #10b981 !important; }
    .negative { color: #ef4444 !important; }

    /* Chart Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .chart-card {
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 20px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #f9fafb;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-container {
        position: relative;
        height: 280px;
    }

    /* Top Performers Section */
    .performers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .performer-card {
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 20px;
    }

    .performer-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #f9fafb;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .performer-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .performer-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #374151;
        transition: background 0.2s;
    }

    .performer-item:last-child { border-bottom: none; }
    .performer-item:hover { background: rgba(139, 92, 246, 0.1); }

    .performer-rank {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
        margin-right: 12px;
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #d97706); color: #1f2937; }
    .rank-2 { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #1f2937; }
    .rank-3 { background: linear-gradient(135deg, #a78bfa, #7c3aed); color: white; }
    .rank-default { background: #374151; color: #9ca3af; }

    .performer-token {
        flex-grow: 1;
    }

    .performer-name {
        font-weight: 600;
        color: #f9fafb;
        font-size: 0.95rem;
    }

    .performer-strategy {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .performer-pnl {
        font-weight: 700;
        font-size: 1rem;
    }

    /* Strategy Comparison */
    .strategy-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .strategy-card {
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 20px;
        position: relative;
    }

    .strategy-card.pumpfun { border-left: 4px solid #14f195; }
    .strategy-card.jupiter { border-left: 4px solid #fbbf24; }
    .strategy-card.drift { border-left: 4px solid #ec4899; }

    .strategy-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .strategy-name {
        font-weight: 600;
        color: #f9fafb;
        font-size: 1.1rem;
    }

    .strategy-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-pumpfun { background: rgba(20, 241, 149, 0.2); color: #14f195; }
    .badge-jupiter { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .badge-drift { background: rgba(236, 72, 153, 0.2); color: #ec4899; }

    .strategy-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .strategy-stat {
        background: #111827;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
    }

    .strategy-stat-label {
        font-size: 0.7rem;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .strategy-stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #f9fafb;
    }

    /* Risk Metrics */
    .risk-metrics-card {
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .risk-metrics-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #f9fafb;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .risk-metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
    }

    .risk-metric-item {
        background: #111827;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }

    .risk-metric-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .risk-metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #f9fafb;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i>
                Solana Performance Analytics
            </h1>
            <p class="page-subtitle">Comprehensive performance metrics for all Solana strategies</p>
        </div>
        <button class="btn btn-secondary" onclick="loadPerformance()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <!-- Key Metrics Hero -->
    <div class="metrics-hero">
        <div class="metric-card highlight">
            <div class="metric-label">Total P&L</div>
            <div class="metric-value" id="total-pnl">0.0000 SOL</div>
            <div class="metric-sub" id="total-pnl-usd">$0.00</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Trades</div>
            <div class="metric-value" id="total-trades">0</div>
            <div class="metric-sub" id="trades-breakdown">0 wins / 0 losses</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Win Rate</div>
            <div class="metric-value" id="win-rate">0%</div>
            <div class="metric-sub" id="win-streak">Best streak: 0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Profit Factor</div>
            <div class="metric-value" id="profit-factor">0.00</div>
            <div class="metric-sub" id="profit-factor-desc">Gross profit / Gross loss</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Win / Avg Loss</div>
            <div class="metric-value"><span class="positive" id="avg-win">+0%</span> / <span class="negative" id="avg-loss">-0%</span></div>
            <div class="metric-sub" id="expectancy">Expectancy: 0%</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Max Drawdown</div>
            <div class="metric-value negative" id="max-drawdown">0%</div>
            <div class="metric-sub" id="drawdown-date">-</div>
        </div>
    </div>

    <!-- Risk Metrics -->
    <div class="risk-metrics-card">
        <div class="risk-metrics-title">
            <i class="fas fa-shield-alt"></i>
            Risk Metrics
        </div>
        <div class="risk-metrics-grid">
            <div class="risk-metric-item">
                <div class="risk-metric-label">Sharpe Ratio</div>
                <div class="risk-metric-value" id="sharpe-ratio">0.00</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Sortino Ratio</div>
                <div class="risk-metric-value" id="sortino-ratio">0.00</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Calmar Ratio</div>
                <div class="risk-metric-value" id="calmar-ratio">0.00</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Avg Hold Time</div>
                <div class="risk-metric-value" id="avg-hold-time">0m</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Longest Win Streak</div>
                <div class="risk-metric-value positive" id="longest-win">0</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Longest Loss Streak</div>
                <div class="risk-metric-value negative" id="longest-loss">0</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Best Trade</div>
                <div class="risk-metric-value positive" id="best-trade">+0%</div>
            </div>
            <div class="risk-metric-item">
                <div class="risk-metric-label">Worst Trade</div>
                <div class="risk-metric-value negative" id="worst-trade">-0%</div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-area"></i>
                Equity Curve
            </div>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                Daily P&L
            </div>
            <div class="chart-container">
                <canvas id="dailyPnlChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-pie"></i>
                P&L Distribution
            </div>
            <div class="chart-container">
                <canvas id="pnlDistChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-clock"></i>
                Trade Time Distribution
            </div>
            <div class="chart-container">
                <canvas id="timeDistChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Performers -->
    <div class="performers-grid">
        <div class="performer-card">
            <div class="performer-title">
                <i class="fas fa-trophy" style="color: #fbbf24;"></i>
                Best Performing Tokens
            </div>
            <ul class="performer-list" id="best-tokens">
                <li class="performer-item empty-state">No data available</li>
            </ul>
        </div>
        <div class="performer-card">
            <div class="performer-title">
                <i class="fas fa-skull-crossbones" style="color: #ef4444;"></i>
                Worst Performing Tokens
            </div>
            <ul class="performer-list" id="worst-tokens">
                <li class="performer-item empty-state">No data available</li>
            </ul>
        </div>
    </div>

    <!-- Strategy Comparison -->
    <div class="strategy-grid" id="strategy-grid">
        <!-- Dynamically populated -->
    </div>
</div>

<script>
let equityChart = null;
let dailyPnlChart = null;
let pnlDistChart = null;
let timeDistChart = null;

async function loadPerformance() {
    try {
        const response = await fetch('/api/solana/trades?limit=10000');
        const result = await response.json();
        const trades = (result.trades || []).filter(t => t.type === 'CLOSE');

        if (trades.length === 0) {
            showEmptyState();
            return;
        }

        // Calculate all metrics
        const metrics = calculateMetrics(trades);

        // Update UI
        updateMetricsDisplay(metrics);
        buildEquityCurve(trades);
        buildDailyPnlChart(trades);
        buildPnlDistribution(trades);
        buildTimeDistribution(trades);
        buildTopPerformers(trades);
        buildStrategyComparison(trades);

    } catch (e) {
        console.error('Failed to load performance:', e);
    }
}

function calculateMetrics(trades) {
    const wins = trades.filter(t => (t.pnl_sol || 0) > 0);
    const losses = trades.filter(t => (t.pnl_sol || 0) <= 0);

    let totalPnl = 0, grossProfit = 0, grossLoss = 0;
    let winPcts = [], lossPcts = [], allPcts = [];
    let bestTrade = -Infinity, worstTrade = Infinity;
    let holdTimes = [];

    trades.forEach(t => {
        const pnl = t.pnl_sol || 0;
        const pct = t.pnl_pct || t.pnl_percent || 0;
        totalPnl += pnl;
        allPcts.push(pct);

        if (pnl > 0) {
            grossProfit += pnl;
            winPcts.push(pct);
        } else {
            grossLoss += Math.abs(pnl);
            lossPcts.push(Math.abs(pct));
        }

        if (pct > bestTrade) bestTrade = pct;
        if (pct < worstTrade) worstTrade = pct;

        if (t.duration_seconds) holdTimes.push(t.duration_seconds);
    });

    // Win/Loss streaks
    let currentWinStreak = 0, currentLossStreak = 0;
    let maxWinStreak = 0, maxLossStreak = 0;
    trades.forEach(t => {
        if ((t.pnl_sol || 0) > 0) {
            currentWinStreak++;
            currentLossStreak = 0;
            maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
        } else {
            currentLossStreak++;
            currentWinStreak = 0;
            maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
        }
    });

    // Max Drawdown
    let peak = 0, maxDrawdown = 0, cumPnl = 0;
    trades.forEach(t => {
        cumPnl += (t.pnl_sol || 0);
        peak = Math.max(peak, cumPnl);
        const drawdown = peak > 0 ? ((peak - cumPnl) / peak) * 100 : 0;
        maxDrawdown = Math.max(maxDrawdown, drawdown);
    });

    // Risk-adjusted returns
    const avgReturn = allPcts.length > 0 ? allPcts.reduce((a,b) => a+b, 0) / allPcts.length : 0;
    const stdDev = allPcts.length > 1 ? Math.sqrt(allPcts.map(x => Math.pow(x - avgReturn, 2)).reduce((a,b) => a+b, 0) / (allPcts.length - 1)) : 1;
    const sharpe = stdDev > 0 ? avgReturn / stdDev : 0;

    const negReturns = allPcts.filter(x => x < 0);
    const downDev = negReturns.length > 1 ? Math.sqrt(negReturns.map(x => x*x).reduce((a,b) => a+b, 0) / negReturns.length) : 1;
    const sortino = downDev > 0 ? avgReturn / downDev : 0;

    const annualizedReturn = avgReturn * 365;
    const calmar = maxDrawdown > 0 ? annualizedReturn / maxDrawdown : 0;

    // Averages
    const avgWin = winPcts.length > 0 ? winPcts.reduce((a,b) => a+b, 0) / winPcts.length : 0;
    const avgLoss = lossPcts.length > 0 ? lossPcts.reduce((a,b) => a+b, 0) / lossPcts.length : 0;
    const winRate = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
    const expectancy = (winRate/100 * avgWin) - ((100-winRate)/100 * avgLoss);

    const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? Infinity : 0);
    const avgHoldTime = holdTimes.length > 0 ? holdTimes.reduce((a,b) => a+b, 0) / holdTimes.length : 0;

    return {
        totalTrades: trades.length,
        wins: wins.length,
        losses: losses.length,
        totalPnl,
        winRate,
        profitFactor,
        avgWin,
        avgLoss,
        expectancy,
        maxDrawdown,
        bestTrade,
        worstTrade,
        maxWinStreak,
        maxLossStreak,
        sharpe,
        sortino,
        calmar,
        avgHoldTime
    };
}

function updateMetricsDisplay(m) {
    const solPrice = 200; // Approximate

    // Main metrics
    const pnlEl = document.getElementById('total-pnl');
    pnlEl.textContent = `${m.totalPnl >= 0 ? '+' : ''}${m.totalPnl.toFixed(4)} SOL`;
    pnlEl.className = 'metric-value ' + (m.totalPnl >= 0 ? 'positive' : 'negative');
    document.getElementById('total-pnl-usd').textContent = `$${(m.totalPnl * solPrice).toFixed(2)}`;

    document.getElementById('total-trades').textContent = m.totalTrades;
    document.getElementById('trades-breakdown').textContent = `${m.wins} wins / ${m.losses} losses`;

    document.getElementById('win-rate').textContent = `${m.winRate.toFixed(1)}%`;
    document.getElementById('win-streak').textContent = `Best streak: ${m.maxWinStreak}`;

    document.getElementById('profit-factor').textContent = m.profitFactor === Infinity ? '∞' : m.profitFactor.toFixed(2);

    document.getElementById('avg-win').textContent = `+${m.avgWin.toFixed(1)}%`;
    document.getElementById('avg-loss').textContent = `-${m.avgLoss.toFixed(1)}%`;
    document.getElementById('expectancy').textContent = `Expectancy: ${m.expectancy >= 0 ? '+' : ''}${m.expectancy.toFixed(2)}%`;

    document.getElementById('max-drawdown').textContent = `-${m.maxDrawdown.toFixed(1)}%`;

    // Risk metrics
    document.getElementById('sharpe-ratio').textContent = m.sharpe.toFixed(2);
    document.getElementById('sortino-ratio').textContent = m.sortino.toFixed(2);
    document.getElementById('calmar-ratio').textContent = m.calmar.toFixed(2);
    document.getElementById('avg-hold-time').textContent = formatDuration(m.avgHoldTime);
    document.getElementById('longest-win').textContent = m.maxWinStreak;
    document.getElementById('longest-loss').textContent = m.maxLossStreak;
    document.getElementById('best-trade').textContent = `+${m.bestTrade.toFixed(1)}%`;
    document.getElementById('worst-trade').textContent = `${m.worstTrade.toFixed(1)}%`;
}

function formatDuration(seconds) {
    if (!seconds) return '0m';
    if (seconds < 60) return `${Math.round(seconds)}s`;
    if (seconds < 3600) return `${Math.round(seconds/60)}m`;
    return `${(seconds/3600).toFixed(1)}h`;
}

function buildEquityCurve(trades) {
    const sorted = [...trades].sort((a, b) => new Date(a.timestamp || a.closed_at) - new Date(b.timestamp || b.closed_at));
    let cumPnl = 0;
    const labels = ['Start'], data = [0];

    sorted.forEach((t, i) => {
        cumPnl += (t.pnl_sol || 0);
        labels.push(`#${i+1}`);
        data.push(cumPnl);
    });

    if (equityChart) equityChart.destroy();
    equityChart = new Chart(document.getElementById('equityChart').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Cumulative P&L (SOL)',
                data,
                borderColor: cumPnl >= 0 ? '#10b981' : '#ef4444',
                backgroundColor: cumPnl >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f9fafb' } } },
            scales: {
                y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af', maxTicksLimit: 10 } }
            }
        }
    });
}

function buildDailyPnlChart(trades) {
    const dailyPnl = {};
    trades.forEach(t => {
        const date = (t.timestamp || t.closed_at || '').split('T')[0];
        if (date) {
            dailyPnl[date] = (dailyPnl[date] || 0) + (t.pnl_sol || 0);
        }
    });

    const sorted = Object.entries(dailyPnl).sort((a, b) => a[0].localeCompare(b[0]));
    const labels = sorted.map(x => x[0]);
    const data = sorted.map(x => x[1]);
    const colors = data.map(v => v >= 0 ? '#10b981' : '#ef4444');

    if (dailyPnlChart) dailyPnlChart.destroy();
    dailyPnlChart = new Chart(document.getElementById('dailyPnlChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Daily P&L (SOL)',
                data,
                backgroundColor: colors,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                x: { grid: { display: false }, ticks: { color: '#9ca3af', maxRotation: 45 } }
            }
        }
    });
}

function buildPnlDistribution(trades) {
    const pcts = trades.map(t => t.pnl_pct || t.pnl_percent || 0);
    const bins = {};
    const binSize = 10;

    pcts.forEach(p => {
        const bin = Math.floor(p / binSize) * binSize;
        const key = `${bin}% to ${bin + binSize}%`;
        bins[key] = (bins[key] || 0) + 1;
    });

    const sorted = Object.entries(bins).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
    const labels = sorted.map(x => x[0]);
    const data = sorted.map(x => x[1]);
    const colors = sorted.map(x => parseInt(x[0]) >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)');

    if (pnlDistChart) pnlDistChart.destroy();
    pnlDistChart = new Chart(document.getElementById('pnlDistChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{ label: 'Trades', data, backgroundColor: colors, borderRadius: 4 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af', stepSize: 1 } },
                x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
            }
        }
    });
}

function buildTimeDistribution(trades) {
    const hours = Array(24).fill(0);
    trades.forEach(t => {
        const ts = t.timestamp || t.closed_at || t.entry_time;
        if (ts) {
            const hour = new Date(ts).getHours();
            hours[hour]++;
        }
    });

    const labels = hours.map((_, i) => `${i}:00`);

    if (timeDistChart) timeDistChart.destroy();
    timeDistChart = new Chart(document.getElementById('timeDistChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Trades',
                data: hours,
                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af', stepSize: 1 } },
                x: { grid: { display: false }, ticks: { color: '#9ca3af', maxRotation: 45 } }
            }
        }
    });
}

function buildTopPerformers(trades) {
    // Group by token
    const tokenStats = {};
    trades.forEach(t => {
        const token = t.token_symbol || t.token || 'Unknown';
        if (!tokenStats[token]) {
            tokenStats[token] = { pnl: 0, trades: 0, strategy: t.strategy || '' };
        }
        tokenStats[token].pnl += (t.pnl_sol || 0);
        tokenStats[token].trades++;
    });

    const sorted = Object.entries(tokenStats).sort((a, b) => b[1].pnl - a[1].pnl);
    const best = sorted.slice(0, 5);
    const worst = sorted.slice(-5).reverse();

    // Best tokens
    const bestList = document.getElementById('best-tokens');
    bestList.innerHTML = best.length === 0 ? '<li class="empty-state">No data</li>' :
        best.map((item, i) => `
            <li class="performer-item">
                <span class="performer-rank ${i < 3 ? 'rank-' + (i+1) : 'rank-default'}">${i+1}</span>
                <div class="performer-token">
                    <div class="performer-name">${item[0]}</div>
                    <div class="performer-strategy">${item[1].trades} trades • ${item[1].strategy}</div>
                </div>
                <span class="performer-pnl positive">+${item[1].pnl.toFixed(4)} SOL</span>
            </li>
        `).join('');

    // Worst tokens
    const worstList = document.getElementById('worst-tokens');
    worstList.innerHTML = worst.length === 0 ? '<li class="empty-state">No data</li>' :
        worst.map((item, i) => `
            <li class="performer-item">
                <span class="performer-rank rank-default">${sorted.length - worst.length + i + 1}</span>
                <div class="performer-token">
                    <div class="performer-name">${item[0]}</div>
                    <div class="performer-strategy">${item[1].trades} trades • ${item[1].strategy}</div>
                </div>
                <span class="performer-pnl negative">${item[1].pnl.toFixed(4)} SOL</span>
            </li>
        `).join('');
}

function buildStrategyComparison(trades) {
    const strategies = {};
    trades.forEach(t => {
        const s = (t.strategy || 'unknown').toLowerCase();
        if (!strategies[s]) {
            strategies[s] = { trades: 0, wins: 0, pnl: 0, pcts: [] };
        }
        strategies[s].trades++;
        if ((t.pnl_sol || 0) > 0) strategies[s].wins++;
        strategies[s].pnl += (t.pnl_sol || 0);
        if (t.pnl_pct) strategies[s].pcts.push(t.pnl_pct);
    });

    const grid = document.getElementById('strategy-grid');
    grid.innerHTML = '';

    Object.entries(strategies).forEach(([name, data]) => {
        const winRate = data.trades > 0 ? (data.wins / data.trades * 100) : 0;
        const avgPnl = data.pcts.length > 0 ? data.pcts.reduce((a,b) => a+b, 0) / data.pcts.length : 0;

        const card = document.createElement('div');
        card.className = `strategy-card ${name}`;
        card.innerHTML = `
            <div class="strategy-header">
                <span class="strategy-name">${name.toUpperCase()}</span>
                <span class="strategy-badge badge-${name}">${name}</span>
            </div>
            <div class="strategy-stats">
                <div class="strategy-stat">
                    <div class="strategy-stat-label">Trades</div>
                    <div class="strategy-stat-value">${data.trades}</div>
                </div>
                <div class="strategy-stat">
                    <div class="strategy-stat-label">Win Rate</div>
                    <div class="strategy-stat-value">${winRate.toFixed(1)}%</div>
                </div>
                <div class="strategy-stat">
                    <div class="strategy-stat-label">Total P&L</div>
                    <div class="strategy-stat-value ${data.pnl >= 0 ? 'positive' : 'negative'}">${data.pnl >= 0 ? '+' : ''}${data.pnl.toFixed(4)} SOL</div>
                </div>
                <div class="strategy-stat">
                    <div class="strategy-stat-label">Avg P&L</div>
                    <div class="strategy-stat-value ${avgPnl >= 0 ? 'positive' : 'negative'}">${avgPnl >= 0 ? '+' : ''}${avgPnl.toFixed(1)}%</div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

function showEmptyState() {
    document.getElementById('total-trades').textContent = '0';
    document.getElementById('total-pnl').textContent = '0.0000 SOL';
}

document.addEventListener('DOMContentLoaded', loadPerformance);
setInterval(loadPerformance, 30000);
</script>
{% endblock %}
