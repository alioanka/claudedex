{% extends "base.html" %}

{% block title %}Trades - DexScreener Trading Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Trade History</h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="exportTrades()">
            <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-secondary" onclick="refreshTrades()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="grid grid-4">
    <div class="stat-card">
        <i class="fas fa-list stat-icon"></i>
        <div class="stat-label">Total Trades</div>
        <div class="stat-value" id="totalTradesCount">0</div>
    </div>
    
    <div class="stat-card success">
        <i class="fas fa-check-circle stat-icon"></i>
        <div class="stat-label">Winning Trades</div>
        <div class="stat-value" id="winningTradesCount">0</div>
    </div>
    
    <div class="stat-card danger">
        <i class="fas fa-times-circle stat-icon"></i>
        <div class="stat-label">Losing Trades</div>
        <div class="stat-value" id="losingTradesCount">0</div>
    </div>
    
    <div class="stat-card">
        <i class="fas fa-percentage stat-icon"></i>
        <div class="stat-label">Win Rate</div>
        <div class="stat-value" id="winRateValue">0%</div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-body">
        <div class="grid grid-4">
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="filterStatus" class="form-control">
                    <option value="all">All</option>
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Side</label>
                <select id="filterSide" class="form-control">
                    <option value="all">All</option>
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" id="filterStartDate" class="form-control" placeholder="dd.mm.yyyy">
            </div>
            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" id="filterEndDate" class="form-control" placeholder="dd.mm.yyyy">
            </div>
        </div>
        <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fas fa-filter"></i> Apply Filters
        </button>
    </div>
</div>

<!-- Trades Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Trades</h3>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table id="tradesTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Token</th>
                        <th>Side</th>
                        <th>Amount</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>P&L</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <tr>
                        <td colspan="9" class="text-center">Loading trades...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allTrades = [];

async function loadTrades() {
    try {
        const response = await apiGet('/api/trades/history?limit=1000');
        
        if (response.success && response.data) {
            allTrades = response.data;
            updateTradeSummary(allTrades);
            displayTrades(allTrades);
        } else {
            console.error('Failed to load trades:', response.error);
            document.getElementById('tradesTableBody').innerHTML = 
                '<tr><td colspan="9" class="text-center text-danger">Failed to load trades</td></tr>';
        }
    } catch (error) {
        console.error('Error loading trades:', error);
        document.getElementById('tradesTableBody').innerHTML = 
            '<tr><td colspan="9" class="text-center text-danger">Error loading trades</td></tr>';
    }
}

function updateTradeSummary(trades) {
    const closedTrades = trades.filter(t => t.status === 'closed');
    const winningTrades = closedTrades.filter(t => parseFloat(t.profit_loss || 0) > 0);
    const losingTrades = closedTrades.filter(t => parseFloat(t.profit_loss || 0) < 0);
    
    document.getElementById('totalTradesCount').textContent = trades.length;
    document.getElementById('winningTradesCount').textContent = winningTrades.length;
    document.getElementById('losingTradesCount').textContent = losingTrades.length;
    
    const winRate = closedTrades.length > 0 
        ? (winningTrades.length / closedTrades.length * 100).toFixed(1) 
        : 0;
    document.getElementById('winRateValue').textContent = `${winRate}%`;
}

function displayTrades(trades) {
    const tbody = document.getElementById('tradesTableBody');
    
    if (trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No trades found</td></tr>';
        return;
    }
    
    tbody.innerHTML = trades.map(trade => {
        const pnl = parseFloat(trade.profit_loss || 0);
        const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
        const statusBadge = trade.status === 'open' ? 'badge-success' : 'badge-neutral';
        
        return `
            <tr>
                <td>${formatTime(trade.entry_timestamp)}</td>
                <td>${trade.token_symbol || 'Unknown'}</td>
                <td>
                    <span class="badge badge-${trade.side === 'buy' ? 'success' : 'danger'}">
                        ${(trade.side || 'unknown').toUpperCase()}
                    </span>
                </td>
                <td>${formatNumber(trade.amount || 0, 4)}</td>
                <td>${formatCurrency(trade.entry_price || 0)}</td>
                <td>${formatCurrency((trade.amount || 0) * (trade.entry_price || 0))}</td>
                <td><span class="badge ${statusBadge}">${trade.status || 'unknown'}</span></td>
                <td class="${pnlClass}">
                    ${trade.status === 'closed' ? formatCurrency(pnl) : '-'}
                </td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="viewTradeDetails('${trade.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function applyFilters() {
    const status = document.getElementById('filterStatus').value;
    const side = document.getElementById('filterSide').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    
    let filtered = allTrades;
    
    if (status !== 'all') {
        filtered = filtered.filter(t => t.status === status);
    }
    
    if (side !== 'all') {
        filtered = filtered.filter(t => t.side === side);
    }
    
    if (startDate) {
        const start = new Date(startDate);
        filtered = filtered.filter(t => new Date(t.entry_timestamp) >= start);
    }
    
    if (endDate) {
        const end = new Date(endDate);
        end.setHours(23, 59, 59);
        filtered = filtered.filter(t => new Date(t.entry_timestamp) <= end);
    }
    
    displayTrades(filtered);
}

function refreshTrades() {
    loadTrades();
}

function exportTrades() {
    exportData('csv', '/api/trades/export');
}

function viewTradeDetails(tradeId) {
    const trade = allTrades.find(t => t.id === tradeId);
    if (trade) {
        showToast('info', `Trade: ${trade.token_symbol} - ${trade.side}`);
    }
}

// Load on page ready
document.addEventListener('DOMContentLoaded', loadTrades);

// Refresh every 10 seconds
setInterval(loadTrades, 10000);
</script>
{% endblock %}