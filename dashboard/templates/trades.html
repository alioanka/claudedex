{% extends "base.html" %}

{% block title %}Trades - DexScreener Trading Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Trade History</h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="exportTrades('csv')">
            <i class="fas fa-file-csv"></i> Export CSV
        </button>
        <button class="btn btn-secondary" onclick="exportTrades('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-secondary" onclick="refreshTrades()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="grid grid-4">
    <div class="stat-card">
        <i class="fas fa-list stat-icon"></i>
        <div class="stat-label">Total Trades</div>
        <div class="stat-value" id="totalTradesCount">0</div>
    </div>
    
    <div class="stat-card success">
        <i class="fas fa-check-circle stat-icon"></i>
        <div class="stat-label">Winning Trades</div>
        <div class="stat-value" id="winningTradesCount">0</div>
    </div>
    
    <div class="stat-card danger">
        <i class="fas fa-times-circle stat-icon"></i>
        <div class="stat-label">Losing Trades</div>
        <div class="stat-value" id="losingTradesCount">0</div>
    </div>
    
    <div class="stat-card">
        <i class="fas fa-percentage stat-icon"></i>
        <div class="stat-label">Win Rate</div>
        <div class="stat-value" id="winRateValue">0%</div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-body">
        <div class="grid grid-4">
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="filterStatus" class="form-control">
                    <option value="all">All</option>
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Side</label>
                <select id="filterSide" class="form-control">
                    <option value="all">All</option>
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Network</label>
                <select id="filterNetwork" class="form-control">
                    <option value="all">All</option>
                    <option value="ethereum">Ethereum</option>
                    <option value="bsc">BSC</option>
                    <option value="base">Base</option>
                    <option value="arbitrum">Arbitrum</option>
                    <option value="polygon">Polygon</option>
                    <option value="solana">Solana</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" id="filterStartDate" class="form-control" placeholder="dd.mm.yyyy">
            </div>
            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" id="filterEndDate" class="form-control" placeholder="dd.mm.yyyy">
            </div>
        </div>
        <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fas fa-filter"></i> Apply Filters
        </button>
    </div>
</div>

<!-- Trades Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Trades</h3>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table id="tradesTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Token</th>
                        <th>Side</th>
                        <th>Amount</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>P&L</th>
                        <th>Network</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <tr>
                        <td colspan="10" class="text-center">Loading trades...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allTrades = [];

async function loadTrades() {
    try {
        // ✅ Try recent trades first, then history
        let response = await apiGet('/api/trades/recent?limit=1000');
        
        if (!response.success || !response.data || response.data.length === 0) {
            // Fallback to history endpoint
            response = await apiGet('/api/trades/history?limit=1000');
        }
        
        if (response.success && response.data) {
            allTrades = response.data;
            updateTradeSummary(allTrades);
            displayTrades(allTrades);
        } else {
            console.error('Failed to load trades:', response.error);
            document.getElementById('tradesTableBody').innerHTML = 
                '<tr><td colspan="9" class="text-center text-danger">Failed to load trades</td></tr>';
        }
    } catch (error) {
        console.error('Error loading trades:', error);
        document.getElementById('tradesTableBody').innerHTML = 
            '<tr><td colspan="9" class="text-center text-danger">Error loading trades</td></tr>';
    }
}

function updateTradeSummary(trades) {
    const closedTrades = trades.filter(t => t.status === 'closed');
    const winningTrades = closedTrades.filter(t => parseFloat(t.profit_loss || 0) > 0);
    const losingTrades = closedTrades.filter(t => parseFloat(t.profit_loss || 0) < 0);
    
    document.getElementById('totalTradesCount').textContent = trades.length;
    document.getElementById('winningTradesCount').textContent = winningTrades.length;
    document.getElementById('losingTradesCount').textContent = losingTrades.length;
    
    const winRate = closedTrades.length > 0 
        ? (winningTrades.length / closedTrades.length * 100).toFixed(1) 
        : 0;
    document.getElementById('winRateValue').textContent = `${winRate}%`;
}

function displayTrades(trades) {
    const tbody = document.getElementById('tradesTableBody');
    
    if (trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No trades found</td></tr>';
        return;
    }
    
    tbody.innerHTML = trades.map(trade => {
    const pnl = parseFloat(trade.profit_loss || 0);
    const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
    const statusBadge = trade.status === 'open' ? 'badge-success' : 'badge-neutral';
    
    // ✅ Get network from trade data
    const network = trade.network || trade.chain || 'unknown';
    const networkDisplay = network.toUpperCase();
    
    return `
        <tr>
            <td>${formatTime(trade.entry_timestamp)}</td>
            <td>${trade.token_symbol || 'Unknown'}</td>
            <td>
                <span class="badge badge-${trade.side === 'buy' ? 'success' : 'danger'}">
                    ${(trade.side || 'unknown').toUpperCase()}
                </span>
            </td>
            <td>${formatNumber(trade.amount || 0, 4)}</td>
            <td>${formatCurrency(trade.entry_price || 0)}</td>
            <td>${formatCurrency((trade.amount || 0) * (trade.entry_price || 0))}</td>
            <td><span class="badge ${statusBadge}">${trade.status || 'unknown'}</span></td>
            <td class="${pnlClass}">
                ${trade.status === 'closed' ? formatCurrency(pnl) : '-'}
            </td>
            <td><span class="badge badge-info">${networkDisplay}</span></td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="viewTradeDetails('${trade.id || trade.trade_id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `;
}).join('');
}

function applyFilters() {
    const status = document.getElementById('filterStatus').value;
    const side = document.getElementById('filterSide').value;
    const network = document.getElementById('filterNetwork').value; // ✅ ADD THIS
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    
    let filtered = allTrades;
    
    if (status !== 'all') {
        filtered = filtered.filter(t => t.status === status);
    }
    
    if (side !== 'all') {
        filtered = filtered.filter(t => t.side === side);
    }
    
    // ✅ ADD NETWORK FILTER
    if (network !== 'all') {
        filtered = filtered.filter(t => {
            const tradeNetwork = (t.network || t.chain || '').toLowerCase();
            return tradeNetwork === network.toLowerCase();
        });
    }
    
    // ✅ FIX DATE FILTERING - Handle both entry_timestamp and exit_timestamp
    if (startDate) {
        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0);
        filtered = filtered.filter(t => {
            const tradeDate = new Date(t.exit_timestamp || t.entry_timestamp);
            return tradeDate >= start;
        });
    }
    
    if (endDate) {
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        filtered = filtered.filter(t => {
            const tradeDate = new Date(t.exit_timestamp || t.entry_timestamp);
            return tradeDate <= end;
        });
    }
    
    displayTrades(filtered);
    
    // Show filter results
    showToast('info', `Showing ${filtered.length} of ${allTrades.length} trades`);
}

function refreshTrades() {
    loadTrades();
}

function exportTrades(format) {
    exportData(format, `/api/trades/export/${format}`);
}

function viewTradeDetails(tradeId) {
    const trade = allTrades.find(t => 
    t.id === tradeId || 
    t.trade_id === tradeId ||
    String(t.id) === String(tradeId) ||
    String(t.trade_id) === String(tradeId)
);
    if (!trade) {
        console.error('Trade not found:', tradeId);
        console.log('First 3 trades:', allTrades.slice(0, 3).map(t => ({id: t.id, trade_id: t.trade_id})));
        showToast('error', 'Trade not found');
        return;
    }
    
    // Create details modal
    const pnl = parseFloat(trade.profit_loss || 0);
    const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
    
    const modalHtml = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trade Details: ${trade.token_symbol}</h3>
                <button class="btn btn-icon" onclick="closeTradeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="grid grid-2">
                    <div>
                        <strong>Token:</strong> ${trade.token_symbol}<br>
                        <strong>Network:</strong> ${(trade.network || trade.chain || 'unknown').toUpperCase()}<br>
                        <strong>Side:</strong> ${(trade.side || 'unknown').toUpperCase()}<br>
                        <strong>Status:</strong> ${trade.status || 'unknown'}
                    </div>
                    <div>
                        <strong>Entry Price:</strong> ${formatCurrency(trade.entry_price)}<br>
                        <strong>Exit Price:</strong> ${trade.exit_price ? formatCurrency(trade.exit_price) : 'N/A'}<br>
                        <strong>Amount:</strong> ${formatNumber(trade.amount, 4)}<br>
                        <strong class="${pnlClass}">P&L:</strong> <span class="${pnlClass}">${formatCurrency(pnl)}</span>
                    </div>
                </div>
                <hr>
                <div>
                    <strong>Entry Time:</strong> ${formatDateTime(trade.entry_timestamp)}<br>
                    <strong>Exit Time:</strong> ${trade.exit_timestamp ? formatDateTime(trade.exit_timestamp) : 'Still Open'}<br>
                    <strong>Contract:</strong> <code>${trade.token_address}</code>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTradeModal()">Close</button>
            </div>
        </div>
    `;
    
    const modal = document.createElement('div');
    modal.id = 'tradeDetailsModal';
    modal.className = 'modal active';
    modal.innerHTML = modalHtml;
    
    const overlay = document.getElementById('modalOverlay');
    overlay.classList.add('active');
    document.body.appendChild(modal);
}

function formatDateTime(timestamp) {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return date.toLocaleString();
}

function closeTradeModal() {
    const modal = document.getElementById('tradeDetailsModal');
    const overlay = document.getElementById('modalOverlay');
    
    if (modal) modal.remove();
    if (overlay) overlay.classList.remove('active');
}

// Load on page ready
document.addEventListener('DOMContentLoaded', loadTrades);

// Refresh every 10 seconds
setInterval(loadTrades, 300000);
</script>
{% endblock %}