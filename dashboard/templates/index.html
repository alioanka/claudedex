{% extends "base.html" %}

{% block title %}Main Dashboard - Trading Bot{% endblock %}

{% block extra_css %}
<style>
    /* Main Dashboard Container */
    .dashboard-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .dashboard-header {
        margin-bottom: 30px;
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: #e8eaed;
        margin-bottom: 8px;
    }

    .dashboard-subtitle {
        color: #9aa0a6;
        font-size: 1rem;
    }

    /* Bot Control Section - Dark Blue Box */
    .control-section {
        background: #1a1f2e;
        border: 1px solid #2d3548;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .control-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }

    /* Bot Control Buttons - FIXED with explicit colors */
    .control-btn {
        padding: 14px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .btn-start {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: #ffffff !important;
    }

    .btn-stop {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        color: #ffffff !important;
    }

    .btn-restart {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: #ffffff !important;
    }

    .btn-emergency {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
        color: #ffffff !important;
    }

    /* Summary Stats Cards - Dark Blue Box */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: #1a1f2e;
        border: 1px solid #2d3548;
        border-radius: 12px;
        padding: 24px;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }

    .summary-label {
        font-size: 0.875rem;
        color: #9aa0a6;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: #e8eaed;
        margin-bottom: 4px;
    }

    .summary-change {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .positive {
        color: #10b981 !important;
    }

    .negative {
        color: #ef4444 !important;
    }

    /* Section Cards - Dark Blue Box */
    .section-card {
        background: #1a1f2e;
        border: 1px solid #2d3548;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #e8eaed;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 12px;
        border-bottom: 1px solid #2d3548;
    }

    .section-title i {
        color: #3b82f6;
    }

    /* Module Cards */
    .modules-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .module-card {
        background: #242b3d;
        border: 2px solid #2d3548;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
    }

    .module-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    .module-card.active {
        border-color: #10b981;
    }

    .module-card.inactive {
        opacity: 0.7;
        border-color: #6b7280;
    }

    .module-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #e8eaed;
        margin-bottom: 8px;
    }

    .module-status {
        font-size: 0.75rem;
        margin-bottom: 16px;
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-running {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-enabled {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    .status-stopped {
        background: rgba(107, 114, 128, 0.2);
        color: #9aa0a6;
    }

    .module-card.enabled {
        border-color: rgba(245, 158, 11, 0.5);
    }

    .module-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .metric-box {
        text-align: center;
        padding: 12px;
        background: #1a1f2e;
        border-radius: 8px;
        border: 1px solid #2d3548;
    }

    .metric-label {
        font-size: 0.75rem;
        color: #9aa0a6;
        margin-bottom: 4px;
        text-transform: uppercase;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #e8eaed;
    }

    .module-action {
        margin-top: 16px;
        text-align: center;
    }

    /* View Module Buttons - FIXED cursor and styling */
    .view-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff !important;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .view-btn:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        color: #ffffff !important;
    }

    /* Charts - FIXED minimum height */
    .chart-container {
        position: relative;
        height: 350px;
        min-height: 300px;
        margin-top: 20px;
        width: 100%;
    }

    .chart-container canvas {
        max-width: 100% !important;
        height: 100% !important;
    }

    /* Wallet Grid - Dark Blue Boxes */
    .wallet-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }

    .wallet-card {
        background: #242b3d;
        border: 1px solid #2d3548;
        border-radius: 10px;
        padding: 16px;
        transition: all 0.3s;
    }

    .wallet-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .wallet-chain {
        font-size: 0.75rem;
        color: #9aa0a6;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .wallet-balance {
        font-size: 1.35rem;
        font-weight: 700;
        color: #e8eaed;
    }

    .wallet-pnl {
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 4px;
    }

    .wallet-pnl.positive {
        color: #10b981;
    }

    .wallet-pnl.negative {
        color: #ef4444;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }

        .summary-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .modules-comparison {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-line"></i>
            Main Dashboard
        </h1>
        <p class="dashboard-subtitle">Overview of all trading modules and performance</p>
    </div>

    <!-- Bot Control Section -->
    <div class="control-section">
        <div class="section-title">
            <i class="fas fa-sliders-h"></i>
            Bot Control
        </div>
        <div class="control-buttons">
            <button class="control-btn btn-start" onclick="startBot()">
                <i class="fas fa-play"></i>
                Start Bot
            </button>
            <button class="control-btn btn-stop" onclick="stopBot()">
                <i class="fas fa-stop"></i>
                Stop Bot
            </button>
            <button class="control-btn btn-restart" onclick="restartBot()">
                <i class="fas fa-redo"></i>
                Restart Bot
            </button>
            <button class="control-btn btn-emergency" onclick="emergencyExit()">
                <i class="fas fa-exclamation-triangle"></i>
                Emergency Exit
            </button>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Total Portfolio Value</div>
            <div class="summary-value" id="totalPortfolio">$0.00</div>
            <div class="summary-change" id="portfolioChange">+0.00%</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total P&L</div>
            <div class="summary-value positive" id="totalPnl">$0.00</div>
            <div class="summary-change" id="pnlChange">0.00% ROI</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Active Positions</div>
            <div class="summary-value" id="totalPositions">0</div>
            <div class="summary-change" id="positionsBreakdown">Across all modules</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total Trades</div>
            <div class="summary-value" id="totalTrades">0</div>
            <div class="summary-change" id="winRate">Win Rate: 0%</div>
        </div>
    </div>

    <!-- Modules Comparison -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-cubes"></i>
            Trading Modules Overview
        </div>
        <div class="modules-comparison" id="modulesComparison">
            <!-- DEX Module -->
            <div class="module-card active" id="dex-module">
                <div class="module-name">DEX Trading</div>
                <span class="module-status status-running" id="dex-status">RUNNING</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value" id="dex-capital">$500</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value" id="dex-pnl">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value" id="dex-positions">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="dex-winrate">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/dex/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View DEX Module
                    </button>
                </div>
            </div>

            <!-- Futures Module -->
            <div class="module-card inactive" id="futures-module">
                <div class="module-name">Futures Trading</div>
                <span class="module-status status-stopped" id="futures-status">DISABLED</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value" id="futures-capital">$300</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value" id="futures-pnl">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value" id="futures-positions">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="futures-winrate">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/futures/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View Futures Module
                    </button>
                </div>
            </div>

            <!-- Solana Module -->
            <div class="module-card inactive" id="solana-module">
                <div class="module-name">Solana Strategies</div>
                <span class="module-status status-stopped" id="solana-status">DISABLED</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value" id="solana-capital">$400</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value" id="solana-pnl">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value" id="solana-positions">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="solana-winrate">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/solana/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View Solana Module
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- P&L Comparison Chart -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            Module P&L Comparison
        </div>
        <div class="chart-container">
            <canvas id="pnlComparisonChart"></canvas>
        </div>
    </div>

    <!-- Win Rate Comparison Chart -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-trophy"></i>
            Win Rate Comparison
        </div>
        <div class="chart-container">
            <canvas id="winRateChart"></canvas>
        </div>
    </div>

    <!-- Wallet Balances -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-wallet"></i>
            DEX Wallet Balances
        </div>
        <div class="wallet-grid" id="dex-wallets">
            <div class="wallet-card" data-chain="ETHEREUM">
                <div class="wallet-chain">Ethereum</div>
                <div class="wallet-balance" id="bal-ethereum">$0.00</div>
                <div class="wallet-pnl" id="pnl-ethereum"></div>
            </div>
            <div class="wallet-card" data-chain="BSC">
                <div class="wallet-chain">BSC</div>
                <div class="wallet-balance" id="bal-bsc">$0.00</div>
                <div class="wallet-pnl" id="pnl-bsc"></div>
            </div>
            <div class="wallet-card" data-chain="POLYGON">
                <div class="wallet-chain">Polygon</div>
                <div class="wallet-balance" id="bal-polygon">$0.00</div>
                <div class="wallet-pnl" id="pnl-polygon"></div>
            </div>
            <div class="wallet-card" data-chain="ARBITRUM">
                <div class="wallet-chain">Arbitrum</div>
                <div class="wallet-balance" id="bal-arbitrum">$0.00</div>
                <div class="wallet-pnl" id="pnl-arbitrum"></div>
            </div>
            <div class="wallet-card" data-chain="BASE">
                <div class="wallet-chain">Base</div>
                <div class="wallet-balance" id="bal-base">$0.00</div>
                <div class="wallet-pnl" id="pnl-base"></div>
            </div>
        </div>
    </div>

    <!-- Solana Wallet Balances (2 Wallets) -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-sun" style="color: #14f195;"></i>
            Solana Wallet Balances
        </div>
        <div class="wallet-grid">
            <!-- Wallet 1: DEX Module Solana Wallet -->
            <div class="wallet-card" data-chain="SOLANA" style="border-color: #14f195;">
                <div class="wallet-chain" style="color: #14f195;">DEX Module (125QX...)</div>
                <div class="wallet-balance" id="bal-solana">0.00 SOL</div>
                <div class="wallet-balance" id="bal-solana-usd" style="font-size: 0.9rem; color: #9aa0a6;">$0.00</div>
            </div>
            <!-- Wallet 2: Solana Strategies Module Wallet -->
            <div class="wallet-card" data-chain="SOLANA_MODULE" style="border-color: #9945ff;">
                <div class="wallet-chain" style="color: #9945ff;">Solana Module (237Uh...)</div>
                <div class="wallet-balance" id="bal-solana-module">0.00 SOL</div>
                <div class="wallet-balance" id="bal-solana-module-usd" style="font-size: 0.9rem; color: #9aa0a6;">$0.00</div>
            </div>
            <!-- Combined Total -->
            <div class="wallet-card" style="border-color: #14f195; background: linear-gradient(135deg, rgba(20, 241, 149, 0.1), rgba(153, 69, 255, 0.1));">
                <div class="wallet-chain" style="color: #e8eaed;">Total Solana</div>
                <div class="wallet-balance" id="bal-solana-total">0.00 SOL</div>
                <div class="wallet-balance" id="bal-solana-total-usd" style="font-size: 0.9rem; color: #9aa0a6;">$0.00</div>
            </div>
        </div>
    </div>

    <!-- Exchange Balances (Futures + Spot) -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-exchange-alt" style="color: #8b5cf6;"></i>
            Exchange Balances (Binance)
        </div>
        <!-- Futures Section -->
        <div style="margin-bottom: 16px;">
            <div style="font-size: 0.9rem; color: #9aa0a6; margin-bottom: 8px; font-weight: 600;">
                <i class="fas fa-chart-line" style="color: #8b5cf6;"></i> Futures Account
            </div>
            <div class="wallet-grid" id="futures-wallets">
                <div class="wallet-card" style="border-color: #8b5cf6;">
                    <div class="wallet-chain" style="color: #8b5cf6;">USDT Balance</div>
                    <div class="wallet-balance" id="bal-futures-usdt">$0.00</div>
                </div>
                <div class="wallet-card">
                    <div class="wallet-chain">Margin Used</div>
                    <div class="wallet-balance" id="bal-futures-margin">$0.00</div>
                </div>
                <div class="wallet-card">
                    <div class="wallet-chain">Unrealized P&L</div>
                    <div class="wallet-balance" id="bal-futures-pnl">$0.00</div>
                </div>
                <div class="wallet-card">
                    <div class="wallet-chain">Available</div>
                    <div class="wallet-balance" id="bal-futures-available">$0.00</div>
                </div>
            </div>
        </div>
        <!-- Spot Section -->
        <div>
            <div style="font-size: 0.9rem; color: #9aa0a6; margin-bottom: 8px; font-weight: 600;">
                <i class="fas fa-wallet" style="color: #f59e0b;"></i> Spot Account
            </div>
            <div class="wallet-grid" id="spot-wallets">
                <div class="wallet-card" style="border-color: #f59e0b;">
                    <div class="wallet-chain" style="color: #f59e0b;">Total Spot Value</div>
                    <div class="wallet-balance" id="bal-spot-total">$0.00</div>
                </div>
                <div class="wallet-card" id="spot-assets-card" style="grid-column: span 3;">
                    <div class="wallet-chain">Assets</div>
                    <div class="wallet-balance" id="bal-spot-assets" style="font-size: 0.85rem;">-</div>
                </div>
            </div>
        </div>
        <!-- Exchange Total -->
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #2d3548;">
            <div class="wallet-grid">
                <div class="wallet-card" style="border-color: #10b981; background: rgba(16, 185, 129, 0.1);">
                    <div class="wallet-chain" style="color: #10b981;">Total Exchange Balance</div>
                    <div class="wallet-balance" id="bal-exchange-total">$0.00</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store chart instances for updates
let pnlChart = null;
let winRateChart = null;

// ========================================
// DEDICATED WALLET BALANCE LOADING
// ========================================
async function loadWalletBalances() {
    try {
        const response = await fetch('/api/wallets/balances');
        const result = await response.json();

        console.log('Wallet API response:', result);

        if (result.status === 'success' && result.balances) {
            const balances = result.balances;

            // Update DEX wallet balances
            const chains = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE'];
            chains.forEach(chain => {
                const bal = balances[chain];
                if (bal) {
                    const balElem = document.getElementById('bal-' + chain.toLowerCase());
                    const pnlElem = document.getElementById('pnl-' + chain.toLowerCase());

                    if (balElem) {
                        balElem.textContent = '$' + (bal.balance || 0).toFixed(2);
                    }
                    if (pnlElem) {
                        const nativeBalance = bal.native_balance || 0;
                        const symbol = bal.native_symbol || '';
                        if (nativeBalance > 0) {
                            pnlElem.textContent = nativeBalance.toFixed(4) + ' ' + symbol;
                            pnlElem.className = 'wallet-pnl';
                        } else {
                            pnlElem.textContent = '0 ' + symbol;
                            pnlElem.className = 'wallet-pnl';
                        }
                    }
                }
            });

            // Update Solana balances
            let totalSolNative = 0;
            let totalSolUsd = 0;

            if (balances.SOLANA) {
                const solBal = balances.SOLANA;
                const nativeSol = solBal.native_balance || 0;
                const usdSol = solBal.balance || 0;
                const balSolana = document.getElementById('bal-solana');
                const balSolanaUsd = document.getElementById('bal-solana-usd');
                if (balSolana) balSolana.textContent = nativeSol.toFixed(4) + ' SOL';
                if (balSolanaUsd) balSolanaUsd.textContent = '$' + usdSol.toFixed(2);
                totalSolNative += nativeSol;
                totalSolUsd += usdSol;
            }

            if (balances.SOLANA_MODULE) {
                const solModBal = balances.SOLANA_MODULE;
                const nativeSolMod = solModBal.native_balance || 0;
                const usdSolMod = solModBal.balance || 0;
                const balSolMod = document.getElementById('bal-solana-module');
                const balSolModUsd = document.getElementById('bal-solana-module-usd');
                if (balSolMod) balSolMod.textContent = nativeSolMod.toFixed(4) + ' SOL';
                if (balSolModUsd) balSolModUsd.textContent = '$' + usdSolMod.toFixed(2);
                totalSolNative += nativeSolMod;
                totalSolUsd += usdSolMod;
            }

            // Update Total Solana
            const balSolTotal = document.getElementById('bal-solana-total');
            const balSolTotalUsd = document.getElementById('bal-solana-total-usd');
            if (balSolTotal) balSolTotal.textContent = totalSolNative.toFixed(4) + ' SOL';
            if (balSolTotalUsd) balSolTotalUsd.textContent = '$' + totalSolUsd.toFixed(2);

            // Update Futures balance
            if (balances.FUTURES) {
                const fut = balances.FUTURES;
                const balFutUsdt = document.getElementById('bal-futures-usdt');
                const balFutMargin = document.getElementById('bal-futures-margin');
                const balFutPnl = document.getElementById('bal-futures-pnl');
                const balFutAvail = document.getElementById('bal-futures-available');
                if (balFutUsdt) balFutUsdt.textContent = '$' + (fut.total_balance || 0).toFixed(2);
                if (balFutMargin) balFutMargin.textContent = '$' + (fut.margin_used || 0).toFixed(2);
                if (balFutPnl) balFutPnl.textContent = '$' + (fut.unrealized_pnl || 0).toFixed(2);
                if (balFutAvail) balFutAvail.textContent = '$' + (fut.available || 0).toFixed(2);
            }

            // Update Spot balance
            if (balances.SPOT) {
                const spot = balances.SPOT;
                const balSpotTotal = document.getElementById('bal-spot-total');
                const balSpotAssets = document.getElementById('bal-spot-assets');
                if (balSpotTotal) balSpotTotal.textContent = '$' + (spot.total_balance || 0).toFixed(2);
                if (balSpotAssets && spot.assets && spot.assets.length > 0) {
                    const assetsStr = spot.assets
                        .sort((a, b) => b.usd_value - a.usd_value)
                        .slice(0, 5)
                        .map(a => a.asset + ': $' + a.usd_value.toFixed(2))
                        .join(' | ');
                    balSpotAssets.textContent = assetsStr;
                } else if (balSpotAssets) {
                    balSpotAssets.textContent = 'No assets';
                }
            }

            // Update Exchange Total
            if (balances.EXCHANGE_TOTAL) {
                const balExchTotal = document.getElementById('bal-exchange-total');
                if (balExchTotal) balExchTotal.textContent = '$' + (balances.EXCHANGE_TOTAL.total || 0).toFixed(2);
            }

            // Update total portfolio value and summary stats
            if (balances.TOTAL) {
                const totalPortfolio = document.getElementById('totalPortfolio');
                if (totalPortfolio) totalPortfolio.textContent = '$' + (balances.TOTAL.balance || 0).toFixed(2);

                // Update Active Positions count
                const totalPositions = document.getElementById('totalPositions');
                if (totalPositions) totalPositions.textContent = balances.TOTAL.positions || 0;

                // Update Total P&L from wallet balances
                const totalPnl = document.getElementById('totalPnl');
                const pnlChange = document.getElementById('pnlChange');
                if (totalPnl) {
                    const pnl = balances.TOTAL.pnl || 0;
                    totalPnl.textContent = '$' + pnl.toFixed(2);
                    totalPnl.className = pnl >= 0 ? 'summary-value positive' : 'summary-value negative';

                    // Calculate ROI
                    const portfolioValue = balances.TOTAL.balance || 0;
                    const costBasis = portfolioValue - pnl;
                    const roi = costBasis > 0 ? (pnl / costBasis) * 100 : 0;
                    if (pnlChange) pnlChange.textContent = roi.toFixed(2) + '% ROI';
                }
            }

            // Calculate total P&L from all chains
            let totalChainPnl = 0;
            const chainList = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE', 'SOLANA'];
            chainList.forEach(chain => {
                if (balances[chain] && balances[chain].pnl) {
                    totalChainPnl += balances[chain].pnl;
                }
            });

            // Update Total P&L display with chain P&L if available
            if (Math.abs(totalChainPnl) > 0.01) {
                const totalPnl = document.getElementById('totalPnl');
                const pnlChange = document.getElementById('pnlChange');
                if (totalPnl) {
                    totalPnl.textContent = '$' + totalChainPnl.toFixed(2);
                    totalPnl.className = totalChainPnl >= 0 ? 'summary-value positive' : 'summary-value negative';

                    const portfolioValue = balances.TOTAL?.balance || 0;
                    const costBasis = portfolioValue - totalChainPnl;
                    const roi = costBasis > 0 ? (totalChainPnl / costBasis) * 100 : 0;
                    if (pnlChange) pnlChange.textContent = roi.toFixed(2) + '% ROI';
                }
            }
        }
    } catch (e) {
        console.error('Error loading wallet balances:', e);
    }
}

// ========================================
// FETCH PERFORMANCE METRICS (Total Trades, Win Rate)
// ========================================
async function loadPerformanceMetrics() {
    try {
        const response = await fetch('/api/performance/metrics');
        const result = await response.json();

        if (result.success && result.data) {
            const hist = result.data.historical || result.data || {};

            // Update Total Trades
            const totalTradesEl = document.getElementById('totalTrades');
            if (totalTradesEl) {
                totalTradesEl.textContent = hist.total_trades || 0;
            }

            // Update Win Rate
            const winRateEl = document.getElementById('winRate');
            if (winRateEl) {
                const winRate = hist.win_rate || 0;
                winRateEl.textContent = 'Win Rate: ' + winRate.toFixed(1) + '%';
            }

            // If we have historical P&L, use it for Total P&L
            if (hist.total_pnl && Math.abs(hist.total_pnl) > 0.01) {
                const totalPnlEl = document.getElementById('totalPnl');
                const pnlChangeEl = document.getElementById('pnlChange');
                if (totalPnlEl) {
                    totalPnlEl.textContent = '$' + hist.total_pnl.toFixed(2);
                    totalPnlEl.className = hist.total_pnl >= 0 ? 'summary-value positive' : 'summary-value negative';
                }
                if (pnlChangeEl) {
                    const roi = hist.roi || 0;
                    pnlChangeEl.textContent = roi.toFixed(2) + '% ROI';
                }
            }
        }
    } catch (e) {
        console.error('Error loading performance metrics:', e);
    }
}

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Load wallet balances immediately
    loadWalletBalances();

    // Load performance metrics (trades, win rate)
    loadPerformanceMetrics();

    // Auto-refresh wallet balances every 15 seconds
    setInterval(loadWalletBalances, 15000);

    // Auto-refresh performance metrics every 30 seconds
    setInterval(loadPerformanceMetrics, 30000);

    // P&L Comparison Chart
    const pnlCtx = document.getElementById('pnlComparisonChart').getContext('2d');
    pnlChart = new Chart(pnlCtx, {
        type: 'bar',
        data: {
            labels: ['DEX Trading', 'Futures Trading', 'Solana Strategies'],
            datasets: [{
                label: 'P&L ($)',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(139, 92, 246)',
                    'rgb(16, 185, 129)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Win Rate Chart - Changed to BAR chart for better win rate visualization
    const winRateCtx = document.getElementById('winRateChart').getContext('2d');
    winRateChart = new Chart(winRateCtx, {
        type: 'bar',
        data: {
            labels: ['DEX Trading', 'Futures Trading', 'Solana Strategies'],
            datasets: [{
                label: 'Win Rate (%)',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(139, 92, 246)',
                    'rgb(16, 185, 129)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // Initial data load
    loadDashboardData();

    // Auto-refresh data every 10 seconds
    setInterval(loadDashboardData, 10000);
});

// Load dashboard summary data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard/summary');
        const result = await response.json();

        if (result.success && result.data) {
            const data = result.data;

            // Update portfolio value
            const portfolioValue = data.portfolio_value || data.total_value || 0;
            document.getElementById('totalPortfolio').textContent = '$' + portfolioValue.toFixed(2);

            // Update P&L
            const totalPnl = data.total_pnl || data.net_profit || 0;
            const pnlElem = document.getElementById('totalPnl');
            pnlElem.textContent = '$' + totalPnl.toFixed(2);
            pnlElem.className = totalPnl >= 0 ? 'summary-value positive' : 'summary-value negative';

            // Calculate ROI
            const roi = portfolioValue > 0 ? ((totalPnl / (portfolioValue - totalPnl)) * 100) : 0;
            document.getElementById('pnlChange').textContent = roi.toFixed(2) + '% ROI';

            // Update positions
            const openPositions = data.open_positions || 0;
            document.getElementById('totalPositions').textContent = openPositions;

            // Update win rate
            const winRate = data.win_rate || 0;
            document.getElementById('winRate').textContent = 'Win Rate: ' + winRate.toFixed(1) + '%';
        }
    } catch (e) {
        console.error('Error fetching dashboard data:', e);
    }

    // Load module-specific data
    try {
        const modResponse = await fetch('/api/modules');
        const modResult = await modResponse.json();

        if (modResult.success && modResult.data && modResult.data.modules) {
            const modules = modResult.data.modules;

            // Update module cards with status
            updateModuleCard('dex', modules.dex_trading);
            updateModuleCard('futures', modules.futures_trading);
            updateModuleCard('solana', modules.solana_strategies);

            // Update total trades from module data
            let totalTrades = 0;
            Object.values(modules).forEach(m => {
                if (m && m.metrics) {
                    totalTrades += m.metrics.total_trades || 0;
                }
            });
            document.getElementById('totalTrades').textContent = totalTrades;

            // Log module data for debugging
            console.log('Modules API response:', modules);

            // Update P&L Comparison Chart
            if (pnlChart) {
                const dexPnl = modules.dex_trading?.metrics?.pnl || 0;
                const futuresPnl = modules.futures_trading?.metrics?.pnl || 0;
                const solanaPnl = modules.solana_strategies?.metrics?.pnl || 0;
                pnlChart.data.datasets[0].data = [dexPnl, futuresPnl, solanaPnl];
                pnlChart.update();
                console.log('P&L Chart updated:', {dex: dexPnl, futures: futuresPnl, solana: solanaPnl});
            }

            // Update Win Rate Chart (now a bar chart showing actual percentages)
            if (winRateChart) {
                const dexWinRate = modules.dex_trading?.metrics?.win_rate || 0;
                const futuresWinRate = modules.futures_trading?.metrics?.win_rate || 0;
                const solanaWinRate = modules.solana_strategies?.metrics?.win_rate || 0;
                winRateChart.data.datasets[0].data = [dexWinRate, futuresWinRate, solanaWinRate];
                winRateChart.update();
                console.log('Win Rate Chart updated:', {dex: dexWinRate, futures: futuresWinRate, solana: solanaWinRate});
            }
        }
    } catch (e) {
        console.error('Error fetching module data:', e);
    }

    // Wallet balances are handled by dedicated loadWalletBalances() function
}

function updateModuleCard(prefix, moduleData) {
    if (!moduleData) return;

    const card = document.getElementById(prefix + '-module');
    if (!card) return;

    // Update status badge - handle RUNNING, ENABLED, and DISABLED states
    const status = moduleData.status || (moduleData.enabled ? 'RUNNING' : 'DISABLED');
    const statusEl = document.getElementById(prefix + '-status');
    if (statusEl) {
        statusEl.textContent = status;
        // Map status to CSS class: RUNNING → running, ENABLED → enabled (yellow), DISABLED → stopped
        let statusClass = 'stopped';
        if (status === 'RUNNING') {
            statusClass = 'running';
        } else if (status === 'ENABLED') {
            statusClass = 'enabled';  // Module enabled but not running
        }
        statusEl.className = 'module-status status-' + statusClass;
    }

    // Update card style based on enabled status and running state
    const isRunning = status === 'RUNNING';
    const isEnabled = moduleData.enabled || status === 'ENABLED';
    card.className = 'module-card ' + (isRunning ? 'active' : (isEnabled ? 'enabled' : 'inactive'));

    // Update Capital
    const capitalEl = document.getElementById(prefix + '-capital');
    if (capitalEl) {
        capitalEl.textContent = '$' + (moduleData.capital || 0).toFixed(0);
    }

    // Update P&L
    const pnlEl = document.getElementById(prefix + '-pnl');
    if (pnlEl && moduleData.metrics) {
        const pnl = moduleData.metrics.pnl || 0;
        pnlEl.textContent = '$' + pnl.toFixed(2);
        pnlEl.className = 'metric-value ' + (pnl >= 0 ? 'positive' : 'negative');
    }

    // Update Positions
    const posEl = document.getElementById(prefix + '-positions');
    if (posEl && moduleData.metrics) {
        posEl.textContent = moduleData.metrics.positions || 0;
    }

    // Update Win Rate
    const winrateEl = document.getElementById(prefix + '-winrate');
    if (winrateEl && moduleData.metrics) {
        winrateEl.textContent = (moduleData.metrics.win_rate || 0).toFixed(1) + '%';
    }

    console.log(`Updated ${prefix} module:`, moduleData);
}

// Bot Control Functions
function startBot() {
    if (confirm('Start the trading bot?')) {
        fetch('/api/bot/start', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot started');
                loadDashboardData();
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

function stopBot() {
    if (confirm('Stop the trading bot?')) {
        fetch('/api/bot/stop', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot stopped');
                loadDashboardData();
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

function restartBot() {
    if (confirm('Restart the trading bot?')) {
        fetch('/api/bot/restart', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot restarting...');
                setTimeout(loadDashboardData, 2000);
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

function emergencyExit() {
    if (confirm('EMERGENCY EXIT: Close all positions immediately?')) {
        fetch('/api/bot/emergency-exit', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Emergency exit initiated');
                loadDashboardData();
            })
            .catch(e => alert('Error: ' + e.message));
    }
}
</script>
{% endblock %}
