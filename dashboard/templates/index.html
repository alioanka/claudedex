{% extends "base.html" %}

{% block title %}Main Dashboard - Trading Bot{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-container {
        padding: 20px;
    }

    .dashboard-header {
        margin-bottom: 30px;
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .dashboard-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    /* Bot Control Section */
    .control-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .control-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .control-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-start {
        background: #10b981;
        color: white;
    }

    .btn-stop {
        background: #ef4444;
        color: white;
    }

    .btn-restart {
        background: #3b82f6;
        color: white;
    }

    .btn-emergency {
        background: #dc2626;
        color: white;
    }

    /* Summary Stats */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
    }

    .summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .summary-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 500;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .summary-change {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .positive {
        color: #10b981 !important;
    }

    .negative {
        color: #ef4444 !important;
    }

    /* Module Comparison Section */
    .section-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modules-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .module-card {
        background: var(--bg-tertiary);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s;
    }

    .module-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .module-card.active {
        border-color: #10b981;
    }

    .module-card.inactive {
        opacity: 0.6;
        border-color: #6b7280;
    }

    .module-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .module-status {
        font-size: 0.875rem;
        margin-bottom: 16px;
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
    }

    .status-running {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-stopped {
        background: rgba(107, 114, 128, 0.2);
        color: var(--text-secondary);
    }

    .module-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .metric-box {
        text-align: center;
        padding: 10px;
        background: var(--bg-secondary);
        border-radius: 8px;
    }

    .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .module-action {
        margin-top: 16px;
        text-align: center;
    }

    .view-btn {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .view-btn:hover {
        background: #2563eb;
        color: white;
    }

    /* Charts */
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }

    .wallet-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .wallet-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
    }

    .wallet-chain {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .wallet-balance {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-line"></i>
            Main Dashboard
        </h1>
        <p class="dashboard-subtitle">Overview of all trading modules and performance</p>
    </div>

    <!-- Bot Control Section -->
    <div class="control-section">
        <div class="section-title">
            <i class="fas fa-sliders-h"></i>
            Bot Control
        </div>
        <div class="control-buttons">
            <button class="control-btn btn-start" onclick="startBot()">
                <i class="fas fa-play"></i>
                Start Bot
            </button>
            <button class="control-btn btn-stop" onclick="stopBot()">
                <i class="fas fa-stop"></i>
                Stop Bot
            </button>
            <button class="control-btn btn-restart" onclick="restartBot()">
                <i class="fas fa-redo"></i>
                Restart Bot
            </button>
            <button class="control-btn btn-emergency" onclick="emergencyExit()">
                <i class="fas fa-exclamation-triangle"></i>
                Emergency Exit
            </button>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Total Portfolio Value</div>
            <div class="summary-value" id="totalPortfolio">$0.00</div>
            <div class="summary-change" id="portfolioChange">+0.00%</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total P&L</div>
            <div class="summary-value positive" id="totalPnl">$0.00</div>
            <div class="summary-change" id="pnlChange">0.00% ROI</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Active Positions</div>
            <div class="summary-value" id="totalPositions">0</div>
            <div class="summary-change" id="positionsBreakdown">Across all modules</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total Trades</div>
            <div class="summary-value" id="totalTrades">0</div>
            <div class="summary-change" id="winRate">Win Rate: 0%</div>
        </div>
    </div>

    <!-- Modules Comparison -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-cubes"></i>
            Trading Modules Overview
        </div>
        <div class="modules-comparison" id="modulesComparison">
            <!-- DEX Module -->
            <div class="module-card active">
                <div class="module-name">DEX Trading</div>
                <span class="module-status status-running">RUNNING</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value">$500</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value positive">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/dex/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View DEX Module
                    </button>
                </div>
            </div>

            <!-- Futures Module -->
            <div class="module-card inactive">
                <div class="module-name">Futures Trading</div>
                <span class="module-status status-stopped">DISABLED</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value">$300</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/futures/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View Futures Module
                    </button>
                </div>
            </div>

            <!-- Solana Module -->
            <div class="module-card active">
                <div class="module-name">Solana Strategies</div>
                <span class="module-status status-running">RUNNING</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value">$400</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/solana/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View Solana Module
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- P&L Comparison Chart -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            Module P&L Comparison
        </div>
        <div class="chart-container">
            <canvas id="pnlComparisonChart"></canvas>
        </div>
    </div>

    <!-- Win Rate Comparison Chart -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-trophy"></i>
            Win Rate Comparison
        </div>
        <div class="chart-container">
            <canvas id="winRateChart"></canvas>
        </div>
    </div>

    <!-- Wallet Balances -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-wallet"></i>
            Wallet Balances
        </div>
        <div class="wallet-grid">
            <div class="wallet-card">
                <div class="wallet-chain">Ethereum</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">BSC</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Polygon</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Arbitrum</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Base</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Solana</div>
                <div class="wallet-balance">$0.00</div>
            </div>
        </div>
    </div>
</div>

<script>
// Store chart instances for updates
let pnlChart = null;
let winRateChart = null;

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // P&L Comparison Chart
    const pnlCtx = document.getElementById('pnlComparisonChart').getContext('2d');
    pnlChart = new Chart(pnlCtx, {
        type: 'bar',
        data: {
            labels: ['DEX Trading', 'Futures Trading', 'Solana Strategies'],
            datasets: [{
                label: 'P&L ($)',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(139, 92, 246)',
                    'rgb(16, 185, 129)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Win Rate Chart
    const winRateCtx = document.getElementById('winRateChart').getContext('2d');
    winRateChart = new Chart(winRateCtx, {
        type: 'doughnut',
        data: {
            labels: ['DEX Trading', 'Futures Trading', 'Solana Strategies'],
            datasets: [{
                data: [33, 33, 34],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Initial data load
    loadDashboardData();

    // Auto-refresh data every 10 seconds
    setInterval(loadDashboardData, 10000);
});

// Load dashboard summary data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard/summary');
        const result = await response.json();

        if (result.success && result.data) {
            const data = result.data;

            // Update portfolio value
            const portfolioValue = data.portfolio_value || data.total_value || 0;
            document.getElementById('totalPortfolio').textContent = '$' + portfolioValue.toFixed(2);

            // Update P&L
            const totalPnl = data.total_pnl || data.net_profit || 0;
            const pnlElem = document.getElementById('totalPnl');
            pnlElem.textContent = '$' + totalPnl.toFixed(2);
            pnlElem.className = totalPnl >= 0 ? 'summary-value positive' : 'summary-value negative';

            // Calculate ROI
            const roi = portfolioValue > 0 ? ((totalPnl / (portfolioValue - totalPnl)) * 100) : 0;
            document.getElementById('pnlChange').textContent = roi.toFixed(2) + '% ROI';

            // Update positions
            const openPositions = data.open_positions || 0;
            document.getElementById('totalPositions').textContent = openPositions;

            // Update win rate
            const winRate = data.win_rate || 0;
            document.getElementById('winRate').textContent = 'Win Rate: ' + winRate.toFixed(1) + '%';
        }
    } catch (e) {
        console.error('Error fetching dashboard data:', e);
    }

    // Load module-specific data
    try {
        const modResponse = await fetch('/api/modules');
        const modResult = await modResponse.json();

        if (modResult.success && modResult.data && modResult.data.modules) {
            const modules = modResult.data.modules;

            // Update module cards with status
            updateModuleCard('dex', modules.dex_trading);
            updateModuleCard('futures', modules.futures_trading);
            updateModuleCard('solana', modules.solana_strategies);

            // Update total trades from module data
            let totalTrades = 0;
            Object.values(modules).forEach(m => {
                if (m && m.metrics) {
                    totalTrades += m.metrics.total_trades || 0;
                }
            });
            document.getElementById('totalTrades').textContent = totalTrades;
        }
    } catch (e) {
        console.error('Error fetching module data:', e);
    }
}

function updateModuleCard(prefix, moduleData) {
    const card = document.querySelector(`.module-card[id="${prefix}-module"]`) ||
                 document.querySelectorAll('.module-card')[prefix === 'dex' ? 0 : prefix === 'futures' ? 1 : 2];

    if (!card || !moduleData) return;

    // Update status badge
    const statusBadge = card.querySelector('.module-status');
    if (statusBadge) {
        const status = moduleData.status || (moduleData.enabled ? 'RUNNING' : 'DISABLED');
        statusBadge.textContent = status;
        statusBadge.className = 'module-status status-' + (status === 'RUNNING' ? 'running' : 'stopped');
    }

    // Update card style
    card.className = 'module-card ' + (moduleData.enabled ? 'active' : 'inactive');
}

// Bot Control Functions
function startBot() {
    if (confirm('Start the trading bot?')) {
        fetch('/api/bot/start', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot started');
                loadDashboardData();
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

function stopBot() {
    if (confirm('Stop the trading bot?')) {
        fetch('/api/bot/stop', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot stopped');
                loadDashboardData();
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

function restartBot() {
    if (confirm('Restart the trading bot?')) {
        fetch('/api/bot/restart', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot restarting...');
                setTimeout(loadDashboardData, 2000);
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

function emergencyExit() {
    if (confirm('EMERGENCY EXIT: Close all positions immediately?')) {
        fetch('/api/bot/emergency-exit', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Emergency exit initiated');
                loadDashboardData();
            })
            .catch(e => alert('Error: ' + e.message));
    }
}
</script>
{% endblock %}
