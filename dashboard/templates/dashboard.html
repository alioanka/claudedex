{% extends "base.html" %}

{% block title %}Dashboard - DexScreener Trading Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard Overview</h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="refreshDashboard()">
            <i class="fas fa-sync"></i> Refresh
        </button>
        <button class="btn btn-primary" onclick="window.location.href='/reports'">
            <i class="fas fa-file-download"></i> Generate Report
        </button>
    </div>
</div>

<!-- Key Metrics -->
<div class="grid grid-4">
    <div class="stat-card">
        <i class="fas fa-wallet stat-icon"></i>
        <div class="stat-label">Portfolio Value</div>
        <div class="stat-value" id="portfolioValueStat">$0.00</div>
        <div class="stat-change positive" id="portfolioChange">
            <i class="fas fa-arrow-up"></i> 0.00%
        </div>
    </div>
    
    <div class="stat-card success">
        <i class="fas fa-chart-line stat-icon"></i>
        <div class="stat-label">Total P&L</div>
        <div class="stat-value" id="totalPnlStat">$0.00</div>
        <div class="stat-change positive" id="pnlChange">
            <i class="fas fa-arrow-up"></i> 0.00%
        </div>
    </div>
    
    <div class="stat-card">
        <i class="fas fa-exchange-alt stat-icon"></i>
        <div class="stat-label">Open Positions</div>
        <div class="stat-value" id="openPositionsStat">0</div>
        <div class="stat-change" id="positionsChange">
            Active trades
        </div>
    </div>
    
    <div class="stat-card warning">
        <i class="fas fa-percentage stat-icon"></i>
        <div class="stat-label">Win Rate</div>
        <div class="stat-value" id="winRateStat">0%</div>
        <div class="stat-change" id="winRateChange">
            From trades
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-2">
    <!-- Portfolio Value Chart -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-area"></i>
                Portfolio Value
            </h3>
            <div class="card-actions">
                <select id="portfolioTimeframe" class="form-control" style="width: auto;">
                    <option value="1h">1 Hour</option>
                    <option value="24h" selected>24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <canvas id="portfolioChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- P&L Chart -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                Profit & Loss
            </h3>
            <div class="card-actions">
                <select id="pnlTimeframe" class="form-control" style="width: auto;">
                    <option value="1h">1 Hour</option>
                    <option value="24h" selected>24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <canvas id="pnlChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Recent Positions & Orders -->
<div class="grid grid-1">
    <!-- Recent Positions -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-wallet"></i>
                Open Positions
            </h3>
            <div class="card-actions">
                <a href="/positions" class="btn btn-sm btn-secondary">View All</a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table id="positionsTable">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>Amount</th>
                            <th>P&L</th>
                            <th>Status</th>
                            <th>Network</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                Loading positions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Recent Orders -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-list"></i>
                Recent Orders
            </h3>
            <div class="card-actions">
                <a href="/trades" class="btn btn-sm btn-secondary">View All</a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Side</th>
                            <th>Type</th>
                            <th>Price</th>
                            <th>Amount</th>
                            <th>P&L</th>
                            <th>Status</th>
                            <th>Network</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                Loading orders...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="grid grid-3">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie"></i>
                Win Rate
            </h3>
        </div>
        <div class="card-body">
            <canvas id="winRateChart" height="200"></canvas>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-tachometer-alt"></i>
                Risk Metrics
            </h3>
        </div>
        <div class="card-body">
            <div class="metric-row">
                <span class="metric-label">Sharpe Ratio</span>
                <span class="metric-value" id="sharpeRatio">0.00</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Max Drawdown</span>
                <span class="metric-value text-danger" id="maxDrawdown">0.00%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">VaR (95%)</span>
                <span class="metric-value" id="var95">$0.00</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Portfolio Beta</span>
                <span class="metric-value" id="portfolioBeta">0.00</span>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-bar"></i>
                Trading Stats
            </h3>
        </div>
        <div class="card-body">
            <div class="metric-row">
                <span class="metric-label">Total Trades</span>
                <span class="metric-value" id="totalTrades">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Win Rate</span>
                <span class="metric-value text-success" id="winRate">0%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Avg Win</span>
                <span class="metric-value text-success" id="avgWin">$0.00</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Avg Loss</span>
                <span class="metric-value text-danger" id="avgLoss">$0.00</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
}

.page-actions {
    display: flex;
    gap: var(--spacing-md);
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--border-color);
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.metric-value {
    font-weight: 600;
    font-size: 1rem;
}

.notification-item {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background-color: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-sm);
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.notification-icon.info {
    background-color: rgba(6, 182, 212, 0.2);
    color: var(--accent-info);
}

.notification-icon.warning {
    background-color: rgba(245, 158, 11, 0.2);
    color: var(--accent-warning);
}

.notification-icon.error {
    background-color: rgba(239, 68, 68, 0.2);
    color: var(--accent-danger);
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
}

.notification-message {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xs);
}

.notification-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard-specific JavaScript
async function refreshDashboard() {
    showToast('info', 'Refreshing dashboard...');
    await loadDashboardData();
    await loadCharts();
    showToast('success', 'Dashboard refreshed');
}

async function loadCharts() {
    // Load portfolio chart
    loadPortfolioChart();
    
    // Load P&L chart
    loadPnLChart();
    
    // Load win rate chart
    loadWinRateChart();
}

async function loadPortfolioChart() {
    const timeframe = document.getElementById('portfolioTimeframe').value;
    
    try {
        const response = await apiGet(`/api/performance/charts?timeframe=${timeframe}`);
        
        if (response.success && response.data.portfolio_history && response.data.portfolio_history.length > 0) {
            const data = response.data.portfolio_history;
            
            // ✅ Format labels based on timeframe
            const formatLabel = (timestamp) => {
                const date = new Date(timestamp);
                if (timeframe === '7d' || timeframe === '30d') {
                    return date.toLocaleDateString(); // Show date for longer timeframes
                } else {
                    return date.toLocaleTimeString(); // Show time for 1h/24h
                }
            };
            
            createChart('portfolioChart', {
                type: 'line',
                data: {
                    labels: data.map(d => formatLabel(d.timestamp)),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: data.map(d => d.value),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { callback: value => formatCurrency(value) }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading portfolio chart:', error);
    }
}

async function loadPnLChart() {
    const timeframe = document.getElementById('pnlTimeframe').value;
    
    try {
        const response = await apiGet(`/api/performance/charts?timeframe=${timeframe}`);
        
        if (response.success && response.data.pnl_history && response.data.pnl_history.length > 0) {
            const data = response.data.pnl_history;
            
            createChart('pnlChart', {
                type: 'bar',
                data: {
                    labels: data.map(d => formatDate(d.timestamp)),
                    datasets: [{
                        label: 'P&L',
                        data: data.map(d => d.value),
                        backgroundColor: data.map(d => d.value >= 0 ? 
                            'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        } else {
            // ✅ Show "No data" message
            const canvas = document.getElementById('pnlChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No data available for this timeframe', canvas.width / 2, canvas.height / 2);
            }
        }
    } catch (error) {
        console.error('Error loading P&L chart:', error);
    }
}

async function loadWinRateChart() {
    try {
        const response = await apiGet('/api/performance/metrics');
        
        if (response.success && response.data) {
            const historical = response.data.historical || {};
            const winRate = (historical.win_rate || 0) / 100;
            const lossRate = 1 - winRate;
            
            // Update stats
            document.getElementById('totalTrades').textContent = historical.total_trades || 0;
            document.getElementById('winRate').textContent = `${(historical.win_rate || 0).toFixed(2)}%`;
            document.getElementById('avgWin').textContent = formatCurrency(historical.avg_win || 0);
            document.getElementById('avgLoss').textContent = formatCurrency(historical.avg_loss || 0);
            document.getElementById('totalPnlStat').textContent = formatCurrency(historical.total_pnl || 0);
            document.getElementById('winRateStat').textContent = `${(historical.win_rate || 0).toFixed(1)}%`;
            
            // ✅ Destroy existing chart first
            const ctx = document.getElementById('winRateChart');
            if (!ctx) return;
            
            // Get existing chart instance
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // Create new chart
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses'],
                    datasets: [{
                        data: [historical.winning_trades || 0, historical.losing_trades || 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label}: ${data.datasets[0].data[i]}`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading win rate chart:', error);
    }
}

// ✅ ADD these new functions (don't remove your existing code)

// Load historical stats ONCE on page load
async function loadHistoricalStats() {
    try {
        const response = await apiGet('/api/performance/metrics');
        
        if (response.success && response.data) {
            const hist = response.data.historical || {};
            const portfolio = response.data || {};
            
            // Update Trading Stats
            document.getElementById('totalTrades').textContent = hist.total_trades || 0;
            document.getElementById('winRate').textContent = `${(hist.win_rate || 0).toFixed(2)}%`;
            document.getElementById('avgWin').textContent = formatCurrency(hist.avg_win || 0);
            document.getElementById('avgLoss').textContent = formatCurrency(hist.avg_loss || 0);
            
            // ✅ Update Portfolio Value and Total P&L with percentages
            const totalPnl = hist.total_pnl || 0;
            const startingBalance = 10000;
            const portfolioValue = startingBalance + totalPnl;
            const pnlPercent = (totalPnl / startingBalance) * 100;
            
            document.getElementById('portfolioValueStat').textContent = formatCurrency(portfolioValue);
            document.getElementById('totalPnlStat').textContent = formatCurrency(totalPnl);
            document.getElementById('winRateStat').textContent = `${(hist.win_rate || 0).toFixed(1)}%`;
            
            // ✅ Update percentage indicators
            const portfolioChange = document.getElementById('portfolioChange');
            if (portfolioChange) {
                portfolioChange.className = `stat-change ${pnlPercent >= 0 ? 'positive' : 'negative'}`;
                portfolioChange.innerHTML = `<i class="fas fa-arrow-${pnlPercent >= 0 ? 'up' : 'down'}"></i> ${Math.abs(pnlPercent).toFixed(2)}%`;
            }
            
            const pnlChange = document.getElementById('pnlChange');
            if (pnlChange) {
                pnlChange.className = `stat-change ${pnlPercent >= 0 ? 'positive' : 'negative'}`;
                pnlChange.innerHTML = `<i class="fas fa-arrow-${pnlPercent >= 0 ? 'up' : 'down'}"></i> ${Math.abs(pnlPercent).toFixed(2)}%`;
            }
            
            // Update Risk Metrics
            const sharpeRatio = document.getElementById('sharpeRatio');
            if (sharpeRatio) sharpeRatio.textContent = (hist.sharpe_ratio || 0).toFixed(2);
            
            const maxDrawdown = document.getElementById('maxDrawdown');
            if (maxDrawdown) maxDrawdown.textContent = `${Math.abs(hist.max_drawdown || 0).toFixed(2)}%`;
            
            const var95 = document.getElementById('var95');
            if (var95) var95.textContent = formatCurrency(portfolioValue * 0.05);
        }
    } catch (error) {
        console.error('Error loading historical stats:', error);
    }
}

// Load recent trades (handle errors gracefully)
async function loadOrders() {
    try {
        const response = await apiGet('/api/trades/recent?limit=10');
        if (response && response.success && response.data) {
            updateOrdersTable(response.data);
        } else {
            showEmptyOrders();
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        showEmptyOrders();
    }
}

// Load and update open positions count
async function updatePositionsCount() {
    try {
        const response = await apiGet('/api/positions/open');
        if (response && response.success && response.data) {
            const openPositionsStat = document.getElementById('openPositionsStat');
            if (openPositionsStat) {
                openPositionsStat.textContent = response.data.length;
            }
        }
    } catch (error) {
        console.error('Error updating positions count:', error);
    }
}

// Call it when loading positions
async function loadPositions() {
    try {
        const response = await apiGet('/api/positions/open');
        if (response && response.success && response.data) {
            updatePositionsTable(response.data);
            // ✅ Update count
            const openPositionsStat = document.getElementById('openPositionsStat');
            if (openPositionsStat) {
                openPositionsStat.textContent = response.data.length;
            }
        } else {
            showEmptyPositions();
        }
    } catch (error) {
        console.error('Error loading positions:', error);
        showEmptyPositions();
    }
}

// Helper functions
function showEmptyPositions() {
    const tbody = document.querySelector('#positionsTable tbody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No open positions</td></tr>';
    }
}

function showEmptyOrders() {
    const tbody = document.querySelector('#ordersTable tbody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No recent trades</td></tr>';
    }
}

// Update positions table
function updatePositionsTable(positions) {
    const tbody = document.querySelector('#positionsTable tbody');
    if (!tbody) return;
    
    if (!positions || positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No open positions</td></tr>';
        return;
    }
    
    tbody.innerHTML = positions.map(pos => {
        // ✅ Calculate P&L if not provided
        const entryPrice = pos.entry_price || 0;
        const currentPrice = pos.current_price || entryPrice;
        const amount = pos.amount || 0;
        const entryValue = pos.entry_value || (entryPrice * amount);
        
        // Calculate unrealized P&L
        let unrealizedPnl = pos.unrealized_pnl || 0;
        if (unrealizedPnl === 0 && entryPrice > 0) {
            unrealizedPnl = (currentPrice - entryPrice) * amount;
        }
        
        // Calculate P&L percentage
        const pnlPercent = entryValue > 0 ? ((unrealizedPnl / entryValue) * 100) : 0;
        
        return `
            <tr>
                <td>${pos.token_symbol || 'Unknown'}</td>
                <td>$${entryPrice.toFixed(8)}</td>
                <td>$${currentPrice.toFixed(8)}</td>
                <td>${amount.toFixed(2)}</td>
                <td class="${unrealizedPnl >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(unrealizedPnl)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)
                </td>
                <td><span class="badge badge-success">${pos.status || 'open'}</span></td>
                <td><span class="badge badge-info">${pos.chain ? pos.chain.toUpperCase() : 'N/A'}</span></td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="closePosition('${pos.id}')">
                        Close
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}


async function closePosition(positionId) {
    if (!confirm('Are you sure you want to close this position?')) {
        return;
    }
    
    try {
        showToast('info', 'Closing position...');
        
        const response = await apiPost('/api/position/close', { 
            position_id: positionId 
        });
        
        console.log('Close response:', response);
        
        if (response && response.success) {
            showToast('success', response.message || 'Position closed successfully');
            // Reload positions after 1 second
            setTimeout(async () => {
                await loadPositions();
            }, 1000);
        } else {
            showToast('error', response.error || 'Failed to close position');
        }
    } catch (error) {
        console.error('Error closing position:', error);
        showToast('error', 'Failed to close position: ' + error.message);
    }
}

window.closePosition = closePosition;

// Update orders table  
function updateOrdersTable(orders) {
    const tbody = document.querySelector('#ordersTable tbody');
    if (!tbody) return;
    
    if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No recent orders</td></tr>';
        return;
    }
    
    tbody.innerHTML = orders.slice(0, 5).map(order => {
        let tokenSymbol = 'Unknown';
        try {
            if (order.metadata) {
                const metadata = typeof order.metadata === 'string' 
                    ? JSON.parse(order.metadata) 
                    : order.metadata;
                tokenSymbol = metadata.token_symbol || tokenSymbol;
            }
        } catch (e) {}
        
        // ✅ Calculate P&L
        const pnl = order.profit_loss || 0;
        const pnlPercent = order.profit_loss_percentage || 0;
        const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
        const pnlDisplay = order.status === 'closed' 
            ? `${formatCurrency(pnl)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)`
            : '-';
        
        return `
            <tr>
                <td>${tokenSymbol}</td>
                <td><span class="badge badge-${order.side === 'buy' ? 'success' : 'danger'}">${(order.side || 'N/A').toUpperCase()}</span></td>
                <td>Market</td>
                <td>$${(order.entry_price || 0).toFixed(8)}</td>
                <td>${(order.amount || 0).toFixed(2)}</td>
                <td class="${pnlClass}">${pnlDisplay}</td>
                <td><span class="badge badge-${order.status === 'open' ? 'info' : order.status === 'closed' ? 'success' : 'secondary'}">${order.status || 'N/A'}</span></td>
                <td><span class="badge badge-info">${order.chain ? order.chain.toUpperCase() : 'N/A'}</span></td>
                <td>${timeAgo(order.entry_timestamp || Date.now())}</td>
            </tr>
        `;
    }).join('');
}

// ✅ MODIFY your existing DOMContentLoaded to call these functions
document.addEventListener('DOMContentLoaded', function() {
    // ✅ Load everything ONCE on page load
    loadHistoricalStats();
    loadCharts();
    loadPositions();
    loadOrders();
    
    // Add timeframe change listeners (these will reload specific charts)
    document.getElementById('portfolioTimeframe').addEventListener('change', loadPortfolioChart);
    document.getElementById('pnlTimeframe').addEventListener('change', loadPnLChart);
    
    // Initialize WebSocket
    if (typeof initWebSocket === 'function') {
        initWebSocket();
    }
    
    // ✅ DON'T call loadCharts() repeatedly - only load once!
    // ✅ Auto-refresh positions and orders every 5 seconds
    // Positions/Orders refresh every 5 seconds
    setInterval(async () => {
        await loadPositions();
        await loadOrders();
    }, 5000);

    // Charts refresh every 15 minutes
    setInterval(async () => {
        await loadPortfolioChart();
        await loadPnLChart();
    }, 900000);  // 15 minutes = 900,000 ms
});
</script>
{% endblock %}