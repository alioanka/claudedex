{% extends "base.html" %}

{% block title %}Main Dashboard - Trading Bot{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-container {
        padding: 20px;
    }

    .dashboard-header {
        margin-bottom: 30px;
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .dashboard-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    /* Bot Control Section */
    .control-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .control-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .control-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-start {
        background: #10b981;
        color: white;
    }

    .btn-stop {
        background: #ef4444;
        color: white;
    }

    .btn-restart {
        background: #3b82f6;
        color: white;
    }

    .btn-emergency {
        background: #dc2626;
        color: white;
    }

    /* Summary Stats */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
    }

    .summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .summary-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 500;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .summary-change {
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    .positive {
        color: #10b981;
    }

    .negative {
        color: #ef4444;
    }

    /* Module Comparison Section */
    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modules-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .module-card {
        background: var(--metric-bg);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s;
    }

    .module-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .module-card.active {
        border-color: #10b981;
    }

    .module-card.inactive {
        opacity: 0.6;
        border-color: #6b7280;
    }

    .module-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .module-status {
        font-size: 0.875rem;
        margin-bottom: 16px;
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
    }

    .status-running {
        background: #d1fae5;
        color: #065f46;
    }

    .status-stopped {
        background: #e5e7eb;
        color: #374151;
    }

    .module-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .metric-box {
        text-align: center;
        padding: 10px;
        background: var(--card-bg);
        border-radius: 8px;
    }

    .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .module-action {
        margin-top: 16px;
        text-align: center;
    }

    .view-btn {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .view-btn:hover {
        background: #2563eb;
    }

    /* Charts */
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }

    .wallet-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .wallet-card {
        background: var(--metric-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
    }

    .wallet-chain {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .wallet-balance {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-tertiary: #9ca3af;
        --metric-bg: #111827;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-line"></i>
            Main Dashboard
        </h1>
        <p class="dashboard-subtitle">Overview of all trading modules and performance</p>
    </div>

    <!-- Bot Control Section -->
    <div class="control-section">
        <div class="section-title">
            <i class="fas fa-sliders-h"></i>
            Bot Control
        </div>
        <div class="control-buttons">
            <button class="control-btn btn-start" onclick="startBot()">
                <i class="fas fa-play"></i>
                Start Bot
            </button>
            <button class="control-btn btn-stop" onclick="stopBot()">
                <i class="fas fa-stop"></i>
                Stop Bot
            </button>
            <button class="control-btn btn-restart" onclick="restartBot()">
                <i class="fas fa-redo"></i>
                Restart Bot
            </button>
            <button class="control-btn btn-emergency" onclick="emergencyExit()">
                <i class="fas fa-exclamation-triangle"></i>
                Emergency Exit
            </button>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Total Portfolio Value</div>
            <div class="summary-value" id="totalPortfolio">$0.00</div>
            <div class="summary-change" id="portfolioChange">+0.00%</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total P&L</div>
            <div class="summary-value positive" id="totalPnl">$0.00</div>
            <div class="summary-change" id="pnlChange">0.00% ROI</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Active Positions</div>
            <div class="summary-value" id="totalPositions">0</div>
            <div class="summary-change" id="positionsBreakdown">Across all modules</div>
        </div>

        <div class="summary-card">
            <div class="summary-label">Total Trades</div>
            <div class="summary-value" id="totalTrades">0</div>
            <div class="summary-change" id="winRate">Win Rate: 0%</div>
        </div>
    </div>

    <!-- Modules Comparison -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-cubes"></i>
            Trading Modules Overview
        </div>
        <div class="modules-comparison" id="modulesComparison">
            <!-- DEX Module -->
            <div class="module-card active">
                <div class="module-name">DEX Trading</div>
                <span class="module-status status-running">RUNNING</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value">$500</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value positive">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/dex/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View DEX Module
                    </button>
                </div>
            </div>

            <!-- Futures Module -->
            <div class="module-card inactive">
                <div class="module-name">Futures Trading</div>
                <span class="module-status status-stopped">DISABLED</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value">$300</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/futures/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View Futures Module
                    </button>
                </div>
            </div>

            <!-- Solana Module -->
            <div class="module-card active">
                <div class="module-name">Solana Strategies</div>
                <span class="module-status status-running">RUNNING</span>
                <div class="module-metrics">
                    <div class="metric-box">
                        <div class="metric-label">Capital</div>
                        <div class="metric-value">$400</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value">$0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Positions</div>
                        <div class="metric-value">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">0%</div>
                    </div>
                </div>
                <div class="module-action">
                    <button class="view-btn" onclick="location.href='/solana/dashboard'">
                        <i class="fas fa-arrow-right"></i>
                        View Solana Module
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- P&L Comparison Chart -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            Module P&L Comparison
        </div>
        <div class="chart-container">
            <canvas id="pnlComparisonChart"></canvas>
        </div>
    </div>

    <!-- Win Rate Comparison Chart -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-trophy"></i>
            Win Rate Comparison
        </div>
        <div class="chart-container">
            <canvas id="winRateChart"></canvas>
        </div>
    </div>

    <!-- Wallet Balances -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-wallet"></i>
            Wallet Balances
        </div>
        <div class="wallet-grid">
            <div class="wallet-card">
                <div class="wallet-chain">Ethereum</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">BSC</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Polygon</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Arbitrum</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Base</div>
                <div class="wallet-balance">$0.00</div>
            </div>
            <div class="wallet-card">
                <div class="wallet-chain">Solana</div>
                <div class="wallet-balance">$0.00</div>
            </div>
        </div>
    </div>
</div>

<script>
// P&L Comparison Chart
const pnlCtx = document.getElementById('pnlComparisonChart').getContext('2d');
new Chart(pnlCtx, {
    type: 'bar',
    data: {
        labels: ['DEX Trading', 'Futures Trading', 'Solana Strategies'],
        datasets: [{
            label: 'P&L ($)',
            data: [0, 0, 0],
            backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)'
            ],
            borderColor: [
                'rgb(59, 130, 246)',
                'rgb(139, 92, 246)',
                'rgb(16, 185, 129)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Win Rate Chart
const winRateCtx = document.getElementById('winRateChart').getContext('2d');
new Chart(winRateCtx, {
    type: 'doughnut',
    data: {
        labels: ['DEX Trading', 'Futures Trading', 'Solana Strategies'],
        datasets: [{
            data: [33, 33, 34],
            backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Bot Control Functions
function startBot() {
    if (confirm('Start the trading bot?')) {
        fetch('/api/bot/start', { method: 'POST' })
            .then(r => r.json())
            .then(data => alert(data.message || 'Bot started'))
            .catch(e => alert('Error: ' + e.message));
    }
}

function stopBot() {
    if (confirm('Stop the trading bot?')) {
        fetch('/api/bot/stop', { method: 'POST' })
            .then(r => r.json())
            .then(data => alert(data.message || 'Bot stopped'))
            .catch(e => alert('Error: ' + e.message));
    }
}

function restartBot() {
    if (confirm('Restart the trading bot?')) {
        fetch('/api/bot/restart', { method: 'POST' })
            .then(r => r.json())
            .then(data => alert(data.message || 'Bot restarting...'))
            .catch(e => alert('Error: ' + e.message));
    }
}

function emergencyExit() {
    if (confirm('EMERGENCY EXIT: Close all positions immediately?')) {
        fetch('/api/bot/emergency-exit', { method: 'POST' })
            .then(r => r.json())
            .then(data => alert(data.message || 'Emergency exit initiated'))
            .catch(e => alert('Error: ' + e.message));
    }
}

// Auto-refresh data every 10 seconds
setInterval(() => {
    fetch('/api/dashboard/summary')
        .then(r => r.json())
        .then(data => {
            // Update summary stats
            if (data.portfolio) {
                document.getElementById('totalPortfolio').textContent = '$' + data.portfolio.total.toFixed(2);
            }
            if (data.pnl) {
                document.getElementById('totalPnl').textContent = '$' + data.pnl.total.toFixed(2);
                document.getElementById('totalPnl').className = data.pnl.total >= 0 ? 'summary-value positive' : 'summary-value negative';
            }
            if (data.positions) {
                document.getElementById('totalPositions').textContent = data.positions.total;
            }
            if (data.trades) {
                document.getElementById('totalTrades').textContent = data.trades.total;
                document.getElementById('winRate').textContent = 'Win Rate: ' + data.trades.winRate + '%';
            }
        })
        .catch(e => console.error('Error fetching dashboard data:', e));
}, 10000);
</script>
{% endblock %}
