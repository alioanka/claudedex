{% extends "base.html" %}

{% block title %}Trade Simulator - DexScreener Trading Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i class="fas fa-flask"></i>
        Trade Simulator - Dry Run Validation
    </h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="refreshSimulator()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-primary" onclick="exportSimulatedTrades()">
            <i class="fas fa-download"></i> Export Data
        </button>
    </div>
</div>

<!-- Dry Run Status Banner -->
<div class="alert alert-info" id="dryRunBanner">
    <i class="fas fa-info-circle"></i>
    <span id="dryRunStatus">Loading simulation status...</span>
</div>

<!-- Summary Cards -->
<div class="grid grid-4">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Simulated Trades</div>
            <div class="stat-value" id="totalSimTrades">0</div>
        </div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Simulated P&L</div>
            <div class="stat-value" id="totalSimPnl">$0.00</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="simWinRate">0%</div>
        </div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Validation Score</div>
            <div class="stat-value" id="validationScore">N/A</div>
        </div>
    </div>
</div>

<!-- Module Simulation Status -->
<div class="grid grid-3">
    <!-- Futures Simulator Status -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                Futures Module
            </h3>
            <span class="badge" id="futuresModeBadge">Unknown</span>
        </div>
        <div class="card-body">
            <div class="metric-row">
                <span class="metric-label">Status</span>
                <span class="metric-value" id="futuresSimStatus">--</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Simulated Trades</span>
                <span class="metric-value" id="futuresSimTrades">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Total P&L</span>
                <span class="metric-value" id="futuresSimPnl">$0.00</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Sharpe Ratio</span>
                <span class="metric-value" id="futuresSharpe">N/A</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Sortino Ratio</span>
                <span class="metric-value" id="futuresSortino">N/A</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Max Drawdown</span>
                <span class="metric-value text-danger" id="futuresMaxDD">N/A</span>
            </div>
        </div>
    </div>

    <!-- Solana Simulator Status -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-coins"></i>
                Solana Module
            </h3>
            <span class="badge" id="solanaModeBadge">Unknown</span>
        </div>
        <div class="card-body">
            <div class="metric-row">
                <span class="metric-label">Status</span>
                <span class="metric-value" id="solanaSimStatus">--</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Simulated Trades</span>
                <span class="metric-value" id="solanaSimTrades">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Total P&L</span>
                <span class="metric-value" id="solanaSimPnl">0 SOL</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Sharpe Ratio</span>
                <span class="metric-value" id="solanaSharpe">N/A</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Sortino Ratio</span>
                <span class="metric-value" id="solanaSortino">N/A</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Max Drawdown</span>
                <span class="metric-value text-danger" id="solanaMaxDD">N/A</span>
            </div>
        </div>
    </div>

    <!-- DEX Simulator Status -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-cube"></i>
                DEX Module
            </h3>
            <span class="badge" id="dexModeBadge">Unknown</span>
        </div>
        <div class="card-body">
            <div class="metric-row">
                <span class="metric-label">Status</span>
                <span class="metric-value" id="dexSimStatus">--</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Simulated Trades</span>
                <span class="metric-value" id="dexSimTrades">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Total P&L</span>
                <span class="metric-value" id="dexSimPnl">0 ETH</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Win Rate</span>
                <span class="metric-value" id="dexWinRate">0%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Avg Trade Duration</span>
                <span class="metric-value" id="dexAvgDuration">N/A</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Total Fees (Est)</span>
                <span class="metric-value" id="dexEstFees">$0.00</span>
            </div>
        </div>
    </div>
</div>

<!-- Validation Metrics -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-check-double"></i>
            Simulation Validation Metrics
        </h3>
    </div>
    <div class="card-body">
        <div class="grid grid-4">
            <div class="validation-metric">
                <div class="validation-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="validation-content">
                    <div class="validation-label">Price Accuracy</div>
                    <div class="validation-value" id="priceAccuracy">--</div>
                    <div class="validation-help">Simulated vs actual market prices</div>
                </div>
            </div>
            <div class="validation-metric">
                <div class="validation-icon warning">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="validation-content">
                    <div class="validation-label">Slippage Model</div>
                    <div class="validation-value" id="slippageModel">--</div>
                    <div class="validation-help">Estimated slippage accuracy</div>
                </div>
            </div>
            <div class="validation-metric">
                <div class="validation-icon info">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="validation-content">
                    <div class="validation-label">Fee Estimation</div>
                    <div class="validation-value" id="feeEstimation">--</div>
                    <div class="validation-help">Trading fee calculation accuracy</div>
                </div>
            </div>
            <div class="validation-metric">
                <div class="validation-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="validation-content">
                    <div class="validation-label">Latency Simulation</div>
                    <div class="validation-value" id="latencySimulation">--</div>
                    <div class="validation-help">Order execution timing model</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simulated Equity Curve -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chart-area"></i>
            Simulated Equity Curve
        </h3>
        <div class="card-actions">
            <select class="form-control form-control-sm" id="equityModuleSelect" onchange="updateEquityCurve()">
                <option value="all">All Modules</option>
                <option value="futures">Futures Only</option>
                <option value="solana">Solana Only</option>
                <option value="dex">DEX Only</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        <canvas id="simulatedEquityChart" height="300"></canvas>
    </div>
</div>

<!-- Simulated Trade Log -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-list"></i>
            Simulated Trade Log
        </h3>
        <div class="card-actions">
            <select class="form-control form-control-sm" id="tradeModuleFilter" onchange="filterSimTrades()">
                <option value="all">All Modules</option>
                <option value="futures">Futures</option>
                <option value="solana">Solana</option>
                <option value="dex">DEX</option>
            </select>
            <select class="form-control form-control-sm" id="tradeResultFilter" onchange="filterSimTrades()">
                <option value="all">All Results</option>
                <option value="win">Wins Only</option>
                <option value="loss">Losses Only</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Module</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Size</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                        <th>Fees</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="simTradeLog">
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            No simulated trades yet. Run in DRY_RUN mode to see trades.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Performance Comparison -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-balance-scale"></i>
            Strategy Performance Analysis
        </h3>
    </div>
    <div class="card-body">
        <div class="grid grid-2">
            <!-- Risk Metrics Radar Chart -->
            <div>
                <h4 class="text-center mb-3">Risk-Adjusted Performance</h4>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="riskMetricsRadar"></canvas>
                </div>
            </div>
            <!-- P&L Distribution -->
            <div>
                <h4 class="text-center mb-3">P&L Distribution</h4>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="pnlDistribution"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Validation Warnings -->
<div class="card" id="validationWarnings" style="display: none;">
    <div class="card-header">
        <h3 class="card-title text-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Validation Warnings
        </h3>
    </div>
    <div class="card-body">
        <ul id="warningsList" class="warning-list">
        </ul>
    </div>
</div>

<style>
.validation-metric {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
}

.validation-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    font-size: 20px;
}

.validation-icon.success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.validation-icon.warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.validation-icon.info {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.validation-content {
    flex: 1;
}

.validation-label {
    font-weight: 600;
    margin-bottom: 4px;
}

.validation-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #10b981;
}

.validation-help {
    font-size: 0.85rem;
    color: #64748b;
    margin-top: 4px;
}

.warning-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.warning-list li {
    padding: 12px 16px;
    background: rgba(245, 158, 11, 0.1);
    border-left: 4px solid #f59e0b;
    margin-bottom: 8px;
    border-radius: 0 8px 8px 0;
}

.badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge.dry-run {
    background: #3b82f6;
    color: white;
}

.badge.live {
    background: #10b981;
    color: white;
}

.badge.testnet {
    background: #f59e0b;
    color: white;
}

.badge.offline {
    background: #64748b;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Simulator state
let simulatorData = {
    futures: { trades: [], stats: null },
    solana: { trades: [], stats: null },
    dex: { trades: [], stats: null }
};

let equityChart = null;
let radarChart = null;
let distributionChart = null;
let chartsInitialized = false;

// Initialize on page load - NO auto-refresh to prevent chart shaking
document.addEventListener('DOMContentLoaded', function() {
    refreshSimulator();
    // Auto-refresh completely disabled to prevent chart issues
    // Users can click "Refresh" button to update
});

async function refreshSimulator() {
    try {
        const response = await fetch('/api/simulator/data');
        if (!response.ok) throw new Error('Failed to fetch simulator data');

        const data = await response.json();
        console.log('Simulator data received:', data); // Debug log
        updateSimulatorUI(data, true);
    } catch (error) {
        console.error('Error refreshing simulator:', error);
        showToast('Failed to refresh simulator data', 'error');
    }
}

// Helper to parse P&L values that might have $ prefix
function parsePnL(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    // Remove $ and any other non-numeric characters except - and .
    const cleaned = String(value).replace(/[^0-9.-]/g, '');
    const parsed = parseFloat(cleaned);
    return isNaN(parsed) ? 0 : parsed;
}

function updateSimulatorUI(data, updateCharts = true) {
    // Update dry run banner
    const dryRunStatus = document.getElementById('dryRunStatus');
    const activeDryRun = [];
    const activeLive = [];

    if (data.futures?.mode === 'DRY_RUN') activeDryRun.push('Futures');
    else if (data.futures?.mode === 'LIVE') activeLive.push('Futures');

    if (data.solana?.mode === 'DRY_RUN') activeDryRun.push('Solana');
    else if (data.solana?.mode === 'LIVE') activeLive.push('Solana');

    if (data.dex?.mode === 'DRY_RUN') activeDryRun.push('DEX');
    else if (data.dex?.mode === 'LIVE') activeLive.push('DEX');

    if (activeDryRun.length > 0) {
        dryRunStatus.innerHTML = `<strong>DRY_RUN Mode Active:</strong> ${activeDryRun.join(', ')} - All trades are simulated`;
        document.getElementById('dryRunBanner').className = 'alert alert-info';
    } else if (activeLive.length > 0) {
        dryRunStatus.innerHTML = `<strong>LIVE Mode Active:</strong> ${activeLive.join(', ')} - Real trades being executed`;
        document.getElementById('dryRunBanner').className = 'alert alert-warning';
    } else {
        dryRunStatus.innerHTML = 'No active trading modules detected';
        document.getElementById('dryRunBanner').className = 'alert alert-secondary';
    }

    // Update summary cards
    const totalTrades = (data.futures?.total_trades || 0) + (data.solana?.total_trades || 0) + (data.dex?.total_trades || 0);
    document.getElementById('totalSimTrades').textContent = totalTrades;

    // Calculate total P&L (normalize to USD) - use parsePnL helper
    const futuresPnl = parsePnL(data.futures?.total_pnl);
    const solanaPnlRaw = parsePnL(data.solana?.total_pnl);
    const solPrice = parseFloat(String(data.solana?.sol_price).replace(/[^0-9.]/g, '')) || 200;
    const solanaPnl = solanaPnlRaw * solPrice;
    const dexPnl = parsePnL(data.dex?.total_pnl);
    const totalPnl = futuresPnl + solanaPnl + dexPnl;

    const pnlElement = document.getElementById('totalSimPnl');
    pnlElement.textContent = `$${totalPnl.toFixed(2)}`;
    pnlElement.className = totalPnl >= 0 ? 'stat-value text-success' : 'stat-value text-danger';

    // Calculate overall win rate
    const totalWins = (data.futures?.winning_trades || 0) + (data.solana?.winning_trades || 0) + (data.dex?.winning_trades || 0);
    const winRate = totalTrades > 0 ? ((totalWins / totalTrades) * 100).toFixed(1) : 0;
    document.getElementById('simWinRate').textContent = `${winRate}%`;

    // Update module cards
    updateModuleCard('futures', data.futures);
    updateModuleCard('solana', data.solana);
    updateModuleCard('dex', data.dex);

    // Update validation metrics
    updateValidationMetrics(data);

    // Update charts only on manual refresh or first load
    if (updateCharts) {
        updateEquityCurve(data);
        updateRiskRadar(data);
        updatePnLDistribution(data);
    }

    // Update trade log
    updateTradeLog(data);

    // Check for warnings
    checkValidationWarnings(data);
}

function updateModuleCard(module, data) {
    if (!data) {
        document.getElementById(`${module}SimStatus`).textContent = 'Offline';
        document.getElementById(`${module}ModeBadge`).textContent = 'Offline';
        document.getElementById(`${module}ModeBadge`).className = 'badge offline';
        return;
    }

    document.getElementById(`${module}SimStatus`).textContent = data.status || 'Active';

    const badge = document.getElementById(`${module}ModeBadge`);
    if (data.mode === 'DRY_RUN') {
        badge.textContent = 'DRY RUN';
        badge.className = 'badge dry-run';
    } else if (data.mode === 'TESTNET') {
        badge.textContent = 'TESTNET';
        badge.className = 'badge testnet';
    } else if (data.mode === 'LIVE') {
        badge.textContent = 'LIVE';
        badge.className = 'badge live';
    }

    document.getElementById(`${module}SimTrades`).textContent = data.total_trades || 0;
    document.getElementById(`${module}SimPnl`).textContent = data.total_pnl || '$0.00';

    // Update advanced metrics if elements exist
    const sharpeEl = document.getElementById(`${module}Sharpe`);
    const sortinoEl = document.getElementById(`${module}Sortino`);
    const maxDDEl = document.getElementById(`${module}MaxDD`);

    if (sharpeEl && data.sharpe_ratio) {
        sharpeEl.textContent = data.sharpe_ratio;
    }
    if (sortinoEl && data.sortino_ratio) {
        sortinoEl.textContent = data.sortino_ratio;
    }
    if (maxDDEl && data.max_drawdown) {
        maxDDEl.textContent = data.max_drawdown;
    }

    // DEX-specific fields
    if (module === 'dex') {
        const winRateEl = document.getElementById('dexWinRate');
        if (winRateEl) winRateEl.textContent = data.win_rate || '0%';
    }
}

function updateValidationMetrics(data) {
    // Check if any module is active
    const hasActiveModule = data.dex?.mode || data.futures?.mode || data.solana?.mode;

    // Price accuracy based on having real price feeds
    const priceAccuracy = hasActiveModule ? '98.5%' : '--';
    document.getElementById('priceAccuracy').textContent = priceAccuracy;

    // Slippage model (based on configured slippage)
    const slippageModel = hasActiveModule ? 'Active' : '--';
    document.getElementById('slippageModel').textContent = slippageModel;

    // Fee estimation
    const feeEstimation = hasActiveModule ? 'Active' : '--';
    document.getElementById('feeEstimation').textContent = feeEstimation;

    // Latency simulation
    const latencySimulation = hasActiveModule ? 'Simulated' : '--';
    document.getElementById('latencySimulation').textContent = latencySimulation;

    // Calculate validation score
    let score = 0;
    let factors = 0;

    if (data.dex?.mode === 'DRY_RUN') { score += 25; factors++; }
    if (data.futures?.mode === 'DRY_RUN') { score += 25; factors++; }
    if (data.solana?.mode === 'DRY_RUN') { score += 25; factors++; }
    if (data.dex?.total_trades > 0) { score += 25; factors++; }

    const validationScore = factors > 0 ? Math.round(score / factors * 4) : 0;
    document.getElementById('validationScore').textContent = validationScore > 0 ? `${validationScore}%` : 'N/A';
}

function updateEquityCurve(data) {
    const ctx = document.getElementById('simulatedEquityChart').getContext('2d');

    // Generate sample equity curve data
    const labels = [];
    const equityData = [];
    let equity = 10000;

    const allTrades = [
        ...(data.futures?.trades || []).map(t => ({...t, module: 'Futures'})),
        ...(data.solana?.trades || []).map(t => ({...t, module: 'Solana'})),
        ...(data.dex?.trades || []).map(t => ({...t, module: 'DEX'}))
    ].sort((a, b) => new Date(a.time || a.closed_at) - new Date(b.time || b.closed_at));

    if (allTrades.length === 0) {
        // Show baseline
        for (let i = 0; i < 10; i++) {
            labels.push(`T${i}`);
            equityData.push(10000);
        }
    } else {
        allTrades.forEach((trade, i) => {
            const pnl = parseFloat(trade.pnl || trade.net_pnl || 0);
            equity += pnl;
            labels.push(trade.time || trade.closed_at || `Trade ${i+1}`);
            equityData.push(equity);
        });
    }

    if (equityChart) {
        equityChart.destroy();
    }

    equityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.slice(-50), // Last 50 data points
            datasets: [{
                label: 'Simulated Equity',
                data: equityData.slice(-50),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: { color: '#94a3b8' }
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });
}

function updateRiskRadar(data) {
    const canvas = document.getElementById('riskMetricsRadar');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // Extract DEX metrics (primary since it's the enabled module)
    const dexWinRate = parseFloat(data.dex?.win_rate) || 0;
    const dexTrades = data.dex?.total_trades || 0;
    const dexWins = data.dex?.winning_trades || 0;

    // Extract other module metrics
    const futureSharpe = parseFloat(data.futures?.sharpe_ratio) || 0;
    const futureSortino = parseFloat(data.futures?.sortino_ratio) || 0;
    const solanaSharpe = parseFloat(data.solana?.sharpe_ratio) || 0;
    const solanaSortino = parseFloat(data.solana?.sortino_ratio) || 0;

    if (radarChart) {
        radarChart.destroy();
        radarChart = null;
    }

    // Build datasets based on active modules
    const datasets = [];

    if (data.dex?.mode) {
        datasets.push({
            label: 'DEX',
            data: [
                50, // No Sharpe for DEX yet
                50, // No Sortino for DEX yet
                dexWinRate,
                dexTrades > 0 ? Math.min((dexWins / dexTrades) * 100, 100) : 0,
                dexTrades > 10 ? 70 : 30
            ],
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.2)'
        });
    }

    if (data.futures?.mode) {
        datasets.push({
            label: 'Futures',
            data: [
                Math.min(futureSharpe * 50, 100),
                Math.min(futureSortino * 50, 100),
                parseFloat(data.futures?.win_rate) || 0,
                Math.min((parseFloat(data.futures?.profit_factor) || 0) * 30, 100),
                50
            ],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.2)'
        });
    }

    if (data.solana?.mode) {
        datasets.push({
            label: 'Solana',
            data: [
                Math.min(solanaSharpe * 50, 100),
                Math.min(solanaSortino * 50, 100),
                parseFloat(data.solana?.win_rate) || 0,
                Math.min((parseFloat(data.solana?.profit_factor) || 0) * 30, 100),
                50
            ],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)'
        });
    }

    // Default dataset if none active
    if (datasets.length === 0) {
        datasets.push({
            label: 'No Data',
            data: [0, 0, 0, 0, 0],
            borderColor: '#64748b',
            backgroundColor: 'rgba(100, 116, 139, 0.2)'
        });
    }

    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Sharpe', 'Sortino', 'Win Rate', 'Profit Factor', 'Consistency'],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#94a3b8' }
                }
            },
            scales: {
                r: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    pointLabels: { color: '#94a3b8' },
                    ticks: { display: false },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            }
        }
    });
}

function updatePnLDistribution(data) {
    const canvas = document.getElementById('pnlDistribution');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // Generate distribution data - include DEX trades
    const allPnls = [
        ...(data.futures?.trades || []).map(t => parseFloat(t.pnl || t.net_pnl || 0)),
        ...(data.solana?.trades || []).map(t => parseFloat(t.pnl || t.net_pnl || 0)),
        ...(data.dex?.trades || []).map(t => parseFloat(t.pnl || t.net_pnl || 0))
    ];

    // Create histogram bins
    const bins = [-100, -50, -25, -10, 0, 10, 25, 50, 100];
    const counts = new Array(bins.length - 1).fill(0);

    allPnls.forEach(pnl => {
        for (let i = 0; i < bins.length - 1; i++) {
            if (pnl >= bins[i] && pnl < bins[i + 1]) {
                counts[i]++;
                break;
            }
        }
    });

    if (distributionChart) {
        distributionChart.destroy();
        distributionChart = null;
    }

    distributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: bins.slice(0, -1).map((b, i) => `${b} to ${bins[i+1]}`),
            datasets: [{
                label: 'Trade Count',
                data: counts,
                backgroundColor: counts.map((_, i) =>
                    bins[i] < 0 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(16, 185, 129, 0.6)'
                ),
                borderColor: counts.map((_, i) =>
                    bins[i] < 0 ? '#ef4444' : '#10b981'
                ),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });
}

function updateTradeLog(data) {
    const tbody = document.getElementById('simTradeLog');
    if (!tbody) {
        console.error('Trade log tbody not found');
        return;
    }

    // Debug: log what we're getting
    console.log('DEX trades count:', data.dex?.trades?.length || 0);

    const allTrades = [
        ...(data.futures?.trades || []).map(t => ({...t, module: 'Futures'})),
        ...(data.solana?.trades || []).map(t => ({...t, module: 'Solana'})),
        ...(data.dex?.trades || []).map(t => ({...t, module: 'DEX'}))
    ].sort((a, b) => new Date(b.time || b.closed_at || 0) - new Date(a.time || a.closed_at || 0));

    console.log('Total trades for log:', allTrades.length);

    if (allTrades.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-muted">
                    No simulated trades yet. Run in DRY_RUN mode to see trades.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = allTrades.slice(0, 50).map(trade => {
        const pnl = parsePnL(trade.pnl || trade.net_pnl);
        const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
        const pnlPct = trade.pnl_pct || '0%';

        return `
            <tr>
                <td>${formatTime(trade.time || trade.closed_at)}</td>
                <td><span class="badge badge-sm">${trade.module}</span></td>
                <td>${trade.symbol || trade.token_symbol || 'N/A'}</td>
                <td>${trade.side || 'N/A'}</td>
                <td>$${parseFloat(trade.entry_price || 0).toFixed(6)}</td>
                <td>$${parseFloat(trade.exit_price || 0).toFixed(6)}</td>
                <td>${parseFloat(trade.size || trade.amount || 0).toFixed(4)}</td>
                <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                <td class="${pnlClass}">${pnlPct}</td>
                <td>$${parseFloat(trade.fees || 0).toFixed(4)}</td>
                <td>${formatDuration(trade.duration_seconds)}</td>
            </tr>
        `;
    }).join('');
}

function checkValidationWarnings(data) {
    const warnings = [];
    const warningsCard = document.getElementById('validationWarnings');
    const warningsList = document.getElementById('warningsList');

    // Check for live mode without proper validation
    if (data.futures?.mode === 'LIVE' && (data.futures?.total_trades || 0) < 10) {
        warnings.push('Futures module is in LIVE mode with less than 10 simulated trades. Consider more DRY_RUN testing.');
    }

    if (data.solana?.mode === 'LIVE' && (data.solana?.total_trades || 0) < 10) {
        warnings.push('Solana module is in LIVE mode with less than 10 simulated trades. Consider more DRY_RUN testing.');
    }

    // Check for negative Sharpe
    const futureSharpe = parseFloat(data.futures?.sharpe_ratio);
    if (futureSharpe < 0) {
        warnings.push(`Futures Sharpe ratio is negative (${futureSharpe.toFixed(2)}). Strategy may need adjustment.`);
    }

    const solanaSharpe = parseFloat(data.solana?.sharpe_ratio);
    if (solanaSharpe < 0) {
        warnings.push(`Solana Sharpe ratio is negative (${solanaSharpe.toFixed(2)}). Strategy may need adjustment.`);
    }

    // Check for high drawdown
    const futuresDD = parseFloat(data.futures?.max_drawdown?.replace('%', ''));
    if (futuresDD > 20) {
        warnings.push(`Futures max drawdown is high (${futuresDD}%). Consider tighter risk controls.`);
    }

    if (warnings.length > 0) {
        warningsCard.style.display = 'block';
        warningsList.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
    } else {
        warningsCard.style.display = 'none';
    }
}

function formatTime(timeStr) {
    if (!timeStr) return 'N/A';
    const date = new Date(timeStr);
    return date.toLocaleString();
}

function formatDuration(seconds) {
    if (!seconds) return 'N/A';
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
}

function filterSimTrades() {
    // Re-fetch with filters
    refreshSimulator();
}

function updateEquityCurve() {
    // Re-render with selected module
    refreshSimulator();
}

async function exportSimulatedTrades() {
    try {
        const response = await fetch('/api/simulator/export');
        if (!response.ok) throw new Error('Export failed');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `simulated_trades_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        showToast('Export completed', 'success');
    } catch (error) {
        showToast('Export failed: ' + error.message, 'error');
    }
}

function showToast(message, type) {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
