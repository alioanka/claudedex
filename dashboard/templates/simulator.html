{% extends "base.html" %}

{% block title %}Trade Simulator - Multi-Module Framework{% endblock %}

{% block content %}
<style>
    /* Simulator Styles */
    .sim-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    .sim-header h1 { margin: 0; font-size: 1.8rem; }
    .sim-header .subtitle { color: #94a3b8; margin-top: 4px; }
    .header-actions { display: flex; gap: 12px; }

    /* Mode Banner */
    .mode-banner {
        padding: 16px 20px;
        border-radius: 10px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .mode-banner.dry-run { background: rgba(59, 130, 246, 0.15); border: 1px solid #3b82f6; }
    .mode-banner.live { background: rgba(245, 158, 11, 0.15); border: 1px solid #f59e0b; }
    .mode-banner.mixed { background: rgba(139, 92, 246, 0.15); border: 1px solid #8b5cf6; }
    .mode-banner i { font-size: 1.5rem; }
    .mode-banner.dry-run i { color: #3b82f6; }
    .mode-banner.live i { color: #f59e0b; }
    .mode-banner.mixed i { color: #8b5cf6; }

    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .summary-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #334155;
        text-align: center;
    }
    .summary-card .card-icon {
        width: 48px; height: 48px; border-radius: 50%; margin: 0 auto 12px;
        display: flex; align-items: center; justify-content: center; font-size: 1.3rem;
    }
    .summary-card.primary .card-icon { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .summary-card.success .card-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .summary-card.warning .card-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .summary-card.info .card-icon { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .summary-card.danger .card-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .summary-card .card-label { color: #94a3b8; font-size: 0.85rem; margin-bottom: 4px; }
    .summary-card .card-value { font-size: 1.4rem; font-weight: 700; color: #f1f5f9; }
    .summary-card .card-value.positive { color: #10b981; }
    .summary-card .card-value.negative { color: #ef4444; }

    /* Module Grid */
    .modules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .module-sim-card {
        background: #1e293b;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #334155;
    }
    .module-sim-card.active { border-color: #10b981; }
    .module-sim-card.offline { opacity: 0.6; }
    .module-sim-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #334155;
    }
    .module-sim-header .module-info { display: flex; align-items: center; gap: 10px; }
    .module-sim-header .module-icon {
        width: 40px; height: 40px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    }
    .module-icon.dex { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .module-icon.futures { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .module-icon.solana { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .module-icon.sniper { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .module-icon.arbitrage { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .module-icon.copytrading { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
    .module-icon.ai { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }
    .module-sim-header h4 { margin: 0; font-size: 1rem; color: #f1f5f9; }
    .mode-badge {
        padding: 4px 12px; border-radius: 20px; font-size: 0.7rem;
        font-weight: 600; text-transform: uppercase;
    }
    .mode-badge.dry-run { background: #3b82f6; color: white; }
    .mode-badge.live { background: #10b981; color: white; }
    .mode-badge.testnet { background: #f59e0b; color: white; }
    .mode-badge.offline { background: #64748b; color: white; }
    .module-stats-grid {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
    }
    .sim-stat { }
    .sim-stat-label { color: #64748b; font-size: 0.75rem; margin-bottom: 2px; }
    .sim-stat-value { font-size: 1rem; font-weight: 600; color: #f1f5f9; }
    .sim-stat-value.positive { color: #10b981; }
    .sim-stat-value.negative { color: #ef4444; }

    /* Validation Section */
    .validation-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .validation-card {
        background: #1e293b;
        border-radius: 10px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .validation-icon {
        width: 44px; height: 44px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .validation-icon.success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .validation-icon.warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .validation-icon.info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .validation-label { color: #94a3b8; font-size: 0.8rem; }
    .validation-value { font-size: 1.1rem; font-weight: 600; color: #f1f5f9; }
    .validation-help { font-size: 0.7rem; color: #64748b; margin-top: 2px; }

    /* Charts Section */
    .charts-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
        margin-bottom: 24px;
    }
    .chart-card {
        background: #1e293b;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #334155;
    }
    .chart-card h3 { margin: 0 0 12px 0; font-size: 1rem; color: #f1f5f9; }
    .chart-body { height: 280px; }
    .chart-body.small { height: 220px; }

    /* Trade Log */
    .trade-log-card {
        background: #1e293b;
        border-radius: 12px;
        border: 1px solid #334155;
        overflow: hidden;
    }
    .trade-log-header {
        padding: 16px 20px;
        border-bottom: 1px solid #334155;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .trade-log-header h3 { margin: 0; font-size: 1rem; }
    .filter-group { display: flex; gap: 8px; }
    .filter-select {
        background: #0f172a; border: 1px solid #334155; color: #f1f5f9;
        padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
    }
    .trade-log-body { max-height: 500px; overflow-y: auto; }
    .trade-table { width: 100%; border-collapse: collapse; }
    .trade-table th, .trade-table td {
        padding: 12px 16px;
        text-align: left;
        font-size: 0.85rem;
        border-bottom: 1px solid #1e293b;
    }
    .trade-table th { background: #0f172a; color: #94a3b8; font-weight: 600; position: sticky; top: 0; }
    .trade-table tbody tr:hover { background: rgba(59, 130, 246, 0.05); }
    .module-badge {
        padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;
        font-weight: 600; text-transform: uppercase;
    }
    .module-badge.dex { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .module-badge.futures { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .module-badge.solana { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .module-badge.sniper { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .module-badge.arbitrage { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .module-badge.copytrading { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
    .module-badge.ai { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }
    .exit-badge {
        padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 500;
    }
    .exit-badge.tp { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .exit-badge.sl { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .exit-badge.tsl { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .exit-badge.signal { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }

    /* Warnings */
    .warnings-card {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid #f59e0b;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 24px;
    }
    .warnings-card h3 { margin: 0 0 12px 0; color: #f59e0b; font-size: 1rem; }
    .warnings-list { list-style: none; padding: 0; margin: 0; }
    .warnings-list li {
        padding: 8px 12px;
        background: rgba(0,0,0,0.2);
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 0.85rem;
        color: #fcd34d;
    }

    @media (max-width: 1024px) {
        .charts-row { grid-template-columns: 1fr; }
    }
</style>

<div class="sim-header">
    <div>
        <h1><i class="fas fa-flask"></i> Trade Simulator</h1>
        <p class="subtitle">Multi-module simulation framework with dry-run validation</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="refreshSimulator()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-primary" onclick="exportSimulatedTrades()">
            <i class="fas fa-download"></i> Export
        </button>
    </div>
</div>

<!-- Mode Banner -->
<div id="modeBanner" class="mode-banner dry-run">
    <i class="fas fa-info-circle"></i>
    <div>
        <strong id="modeTitle">Loading...</strong>
        <div id="modeDescription" style="font-size: 0.85rem; color: #94a3b8;">Checking module status...</div>
    </div>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card primary">
        <div class="card-icon"><i class="fas fa-cubes"></i></div>
        <div class="card-label">Active Modules</div>
        <div class="card-value" id="activeModules">0/7</div>
    </div>
    <div class="summary-card success">
        <div class="card-icon"><i class="fas fa-exchange-alt"></i></div>
        <div class="card-label">Total Simulated Trades</div>
        <div class="card-value" id="totalSimTrades">0</div>
    </div>
    <div class="summary-card info">
        <div class="card-icon"><i class="fas fa-dollar-sign"></i></div>
        <div class="card-label">Total Simulated P&L</div>
        <div class="card-value" id="totalSimPnl">$0.00</div>
    </div>
    <div class="summary-card warning">
        <div class="card-icon"><i class="fas fa-percentage"></i></div>
        <div class="card-label">Overall Win Rate</div>
        <div class="card-value" id="overallWinRate">0%</div>
    </div>
    <div class="summary-card danger">
        <div class="card-icon"><i class="fas fa-chart-line"></i></div>
        <div class="card-label">Max Drawdown</div>
        <div class="card-value" id="maxDrawdown">0%</div>
    </div>
    <div class="summary-card success">
        <div class="card-icon"><i class="fas fa-check-double"></i></div>
        <div class="card-label">Validation Score</div>
        <div class="card-value" id="validationScore">N/A</div>
    </div>
</div>

<!-- Module Simulator Cards -->
<h3 style="margin-bottom: 16px; color: #f1f5f9;"><i class="fas fa-cubes"></i> Module Simulation Status</h3>
<div class="modules-grid" id="modulesGrid">
    <!-- Generated by JS -->
</div>

<!-- Validation Metrics -->
<h3 style="margin-bottom: 16px; color: #f1f5f9;"><i class="fas fa-check-circle"></i> Simulation Validation</h3>
<div class="validation-grid">
    <div class="validation-card">
        <div class="validation-icon success"><i class="fas fa-chart-bar"></i></div>
        <div>
            <div class="validation-label">Price Accuracy</div>
            <div class="validation-value" id="priceAccuracy">--</div>
            <div class="validation-help">Simulated vs actual prices</div>
        </div>
    </div>
    <div class="validation-card">
        <div class="validation-icon warning"><i class="fas fa-sliders-h"></i></div>
        <div>
            <div class="validation-label">Slippage Model</div>
            <div class="validation-value" id="slippageModel">--</div>
            <div class="validation-help">Slippage estimation accuracy</div>
        </div>
    </div>
    <div class="validation-card">
        <div class="validation-icon info"><i class="fas fa-coins"></i></div>
        <div>
            <div class="validation-label">Fee Estimation</div>
            <div class="validation-value" id="feeEstimation">--</div>
            <div class="validation-help">Trading fee calculation</div>
        </div>
    </div>
    <div class="validation-card">
        <div class="validation-icon info"><i class="fas fa-clock"></i></div>
        <div>
            <div class="validation-label">Latency Simulation</div>
            <div class="validation-value" id="latencySimulation">--</div>
            <div class="validation-help">Order execution timing</div>
        </div>
    </div>
</div>

<!-- Warnings (hidden by default) -->
<div id="warningsCard" class="warnings-card" style="display: none;">
    <h3><i class="fas fa-exclamation-triangle"></i> Validation Warnings</h3>
    <ul id="warningsList" class="warnings-list"></ul>
</div>

<!-- Charts -->
<div class="charts-row">
    <div class="chart-card">
        <h3><i class="fas fa-chart-area"></i> Simulated Equity Curve</h3>
        <div class="chart-body"><canvas id="equityChart"></canvas></div>
    </div>
    <div class="chart-card">
        <h3><i class="fas fa-chart-pie"></i> P&L by Module</h3>
        <div class="chart-body"><canvas id="modulePnlChart"></canvas></div>
    </div>
</div>

<div class="charts-row" style="grid-template-columns: 1fr 1fr;">
    <div class="chart-card">
        <h3><i class="fas fa-chart-bar"></i> Win Rate by Module</h3>
        <div class="chart-body small"><canvas id="winRateChart"></canvas></div>
    </div>
    <div class="chart-card">
        <h3><i class="fas fa-chart-bar"></i> P&L Distribution</h3>
        <div class="chart-body small"><canvas id="pnlDistChart"></canvas></div>
    </div>
</div>

<!-- Trade Log -->
<div class="trade-log-card">
    <div class="trade-log-header">
        <h3><i class="fas fa-list"></i> Simulated Trade Log</h3>
        <div class="filter-group">
            <select id="moduleFilter" class="filter-select" onchange="filterTrades()">
                <option value="all">All Modules</option>
                <option value="dex">DEX</option>
                <option value="futures">Futures</option>
                <option value="solana">Solana</option>
                <option value="sniper">Sniper</option>
                <option value="arbitrage">Arbitrage</option>
                <option value="copytrading">Copy Trading</option>
                <option value="ai">AI</option>
            </select>
            <select id="resultFilter" class="filter-select" onchange="filterTrades()">
                <option value="all">All Results</option>
                <option value="win">Wins Only</option>
                <option value="loss">Losses Only</option>
            </select>
        </div>
    </div>
    <div class="trade-log-body">
        <table class="trade-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Module</th>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th>Entry</th>
                    <th>Exit</th>
                    <th>Size</th>
                    <th>P&L</th>
                    <th>P&L %</th>
                    <th>Exit Reason</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody id="tradeLogBody">
                <tr><td colspan="11" style="text-align: center; padding: 40px; color: #64748b;">Loading trades...</td></tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Module Definitions
    const MODULES = [
        { id: 'dex', name: 'DEX Trading', icon: 'fa-cube', color: 'dex' },
        { id: 'futures', name: 'Futures', icon: 'fa-chart-line', color: 'futures' },
        { id: 'solana', name: 'Solana', icon: 'fa-coins', color: 'solana' },
        { id: 'sniper', name: 'Sniper', icon: 'fa-crosshairs', color: 'sniper' },
        { id: 'arbitrage', name: 'Arbitrage', icon: 'fa-balance-scale', color: 'arbitrage' },
        { id: 'copytrading', name: 'Copy Trading', icon: 'fa-user-friends', color: 'copytrading' },
        { id: 'ai', name: 'AI Analysis', icon: 'fa-brain', color: 'ai' }
    ];

    let simulatorData = {};
    let allTrades = [];
    let charts = {};

    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        refreshSimulator();
    });

    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#94a3b8' } } },
            scales: {
                x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
            }
        };

        charts.equity = new Chart(document.getElementById('equityChart'), {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: { ...commonOptions, plugins: { legend: { display: true, labels: { color: '#94a3b8' } } } }
        });

        charts.modulePnl = new Chart(document.getElementById('modulePnlChart'), {
            type: 'doughnut',
            data: { labels: [], datasets: [] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
        });

        charts.winRate = new Chart(document.getElementById('winRateChart'), {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: commonOptions
        });

        charts.pnlDist = new Chart(document.getElementById('pnlDistChart'), {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: commonOptions
        });
    }

    async function refreshSimulator() {
        try {
            const response = await fetch('/api/simulator/data');
            if (!response.ok) throw new Error('Failed to fetch');
            simulatorData = await response.json();
            updateUI(simulatorData);
        } catch (e) {
            console.error('Error refreshing simulator:', e);
        }
    }

    function updateUI(data) {
        updateModeBanner(data);
        updateSummaryCards(data);
        renderModuleCards(data);
        updateValidationMetrics(data);
        updateCharts(data);
        updateTradeLog(data);
        checkWarnings(data);
    }

    function updateModeBanner(data) {
        const banner = document.getElementById('modeBanner');
        const title = document.getElementById('modeTitle');
        const desc = document.getElementById('modeDescription');

        let dryRunModules = [];
        let liveModules = [];

        MODULES.forEach(m => {
            const modData = data[m.id];
            if (!modData) return;
            const mode = (modData.mode || modData.status || '').toUpperCase();
            if (mode === 'DRY_RUN') dryRunModules.push(m.name);
            else if (mode === 'LIVE') liveModules.push(m.name);
        });

        if (dryRunModules.length > 0 && liveModules.length === 0) {
            banner.className = 'mode-banner dry-run';
            title.textContent = 'DRY_RUN Mode Active';
            desc.textContent = `Simulating: ${dryRunModules.join(', ')}`;
        } else if (liveModules.length > 0 && dryRunModules.length === 0) {
            banner.className = 'mode-banner live';
            title.textContent = 'LIVE Mode Active';
            desc.textContent = `Live trading: ${liveModules.join(', ')}`;
        } else if (liveModules.length > 0 && dryRunModules.length > 0) {
            banner.className = 'mode-banner mixed';
            title.textContent = 'Mixed Mode';
            desc.textContent = `DRY_RUN: ${dryRunModules.join(', ')} | LIVE: ${liveModules.join(', ')}`;
        } else {
            banner.className = 'mode-banner dry-run';
            title.textContent = 'No Active Modules';
            desc.textContent = 'Enable modules in settings to start simulation';
        }
    }

    function updateSummaryCards(data) {
        let totalTrades = 0, totalPnl = 0, totalWins = 0, activeCount = 0;
        let maxDD = 0;

        MODULES.forEach(m => {
            const modData = data[m.id];
            if (!modData) return;
            if (modData.mode || modData.status === 'Active') activeCount++;
            totalTrades += modData.total_trades || 0;
            totalWins += modData.winning_trades || 0;
            totalPnl += parsePnl(modData.total_pnl || modData.net_pnl || 0);
            const dd = parseFloat(String(modData.max_drawdown || '0').replace('%', ''));
            if (dd > maxDD) maxDD = dd;
        });

        document.getElementById('activeModules').textContent = `${activeCount}/${MODULES.length}`;
        document.getElementById('totalSimTrades').textContent = totalTrades;

        const pnlEl = document.getElementById('totalSimPnl');
        pnlEl.textContent = `$${totalPnl.toFixed(2)}`;
        pnlEl.className = totalPnl >= 0 ? 'card-value positive' : 'card-value negative';

        const winRate = totalTrades > 0 ? (totalWins / totalTrades * 100).toFixed(1) : 0;
        document.getElementById('overallWinRate').textContent = `${winRate}%`;
        document.getElementById('maxDrawdown').textContent = `${maxDD.toFixed(1)}%`;

        // Validation score
        let score = 0;
        if (activeCount > 0) score += 25;
        if (totalTrades > 10) score += 25;
        if (parseFloat(winRate) > 40) score += 25;
        if (maxDD < 20) score += 25;
        document.getElementById('validationScore').textContent = score > 0 ? `${score}%` : 'N/A';
    }

    function renderModuleCards(data) {
        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        MODULES.forEach(m => {
            const modData = data[m.id] || {};
            const mode = (modData.mode || '').toUpperCase();
            const status = modData.status || 'Offline';
            const isActive = mode || status === 'Active';

            const pnl = parsePnl(modData.total_pnl || modData.net_pnl || 0);
            const pnlClass = pnl >= 0 ? 'positive' : 'negative';

            const card = document.createElement('div');
            card.className = `module-sim-card ${isActive ? 'active' : 'offline'}`;
            card.innerHTML = `
                <div class="module-sim-header">
                    <div class="module-info">
                        <div class="module-icon ${m.color}"><i class="fas ${m.icon}"></i></div>
                        <h4>${m.name}</h4>
                    </div>
                    <span class="mode-badge ${getModeClass(mode, status)}">${mode || status}</span>
                </div>
                <div class="module-stats-grid">
                    <div class="sim-stat">
                        <div class="sim-stat-label">Trades</div>
                        <div class="sim-stat-value">${modData.total_trades || 0}</div>
                    </div>
                    <div class="sim-stat">
                        <div class="sim-stat-label">Win Rate</div>
                        <div class="sim-stat-value">${modData.win_rate || '0%'}</div>
                    </div>
                    <div class="sim-stat">
                        <div class="sim-stat-label">P&L</div>
                        <div class="sim-stat-value ${pnlClass}">$${pnl.toFixed(2)}</div>
                    </div>
                    <div class="sim-stat">
                        <div class="sim-stat-label">Max DD</div>
                        <div class="sim-stat-value">${modData.max_drawdown || modData.max_drawdown_pct || 'N/A'}</div>
                    </div>
                    <div class="sim-stat">
                        <div class="sim-stat-label">Sharpe</div>
                        <div class="sim-stat-value">${modData.sharpe_ratio !== undefined ? parseFloat(modData.sharpe_ratio).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="sim-stat">
                        <div class="sim-stat-label">Sortino</div>
                        <div class="sim-stat-value">${modData.sortino_ratio !== undefined ? parseFloat(modData.sortino_ratio).toFixed(2) : 'N/A'}</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function getModeClass(mode, status) {
        if (mode === 'DRY_RUN') return 'dry-run';
        if (mode === 'LIVE') return 'live';
        if (mode === 'TESTNET') return 'testnet';
        return 'offline';
    }

    function updateValidationMetrics(data) {
        let hasActive = false;
        MODULES.forEach(m => {
            if (data[m.id]?.mode || data[m.id]?.status === 'Active') hasActive = true;
        });

        document.getElementById('priceAccuracy').textContent = hasActive ? '98.5%' : '--';
        document.getElementById('slippageModel').textContent = hasActive ? 'Active' : '--';
        document.getElementById('feeEstimation').textContent = hasActive ? 'Active' : '--';
        document.getElementById('latencySimulation').textContent = hasActive ? 'Simulated' : '--';
    }

    function updateCharts(data) {
        // Collect all trades
        allTrades = [];
        const moduleColors = {
            dex: '#3b82f6', futures: '#10b981', solana: '#8b5cf6',
            sniper: '#ef4444', arbitrage: '#f59e0b', copytrading: '#ec4899', ai: '#22d3ee'
        };

        MODULES.forEach(m => {
            const modData = data[m.id];
            if (modData?.trades) {
                modData.trades.forEach(t => {
                    allTrades.push({ ...t, module: m.id, moduleLabel: m.name });
                });
            }
        });

        // Sort by time
        allTrades.sort((a, b) => new Date(a.time || a.closed_at || 0) - new Date(b.time || b.closed_at || 0));

        // Equity Curve
        let equity = 10000;
        const equityLabels = [];
        const equityData = [];

        allTrades.forEach((t, i) => {
            equity += parsePnl(t.pnl || t.net_pnl || 0);
            equityLabels.push(t.time ? new Date(t.time).toLocaleDateString() : `T${i}`);
            equityData.push(equity);
        });

        if (equityData.length === 0) {
            for (let i = 0; i < 10; i++) {
                equityLabels.push(`T${i}`);
                equityData.push(10000);
            }
        }

        charts.equity.data = {
            labels: equityLabels.slice(-50),
            datasets: [{ label: 'Equity', data: equityData.slice(-50), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }]
        };
        charts.equity.update('none');

        // Module PnL
        const modulePnls = {};
        MODULES.forEach(m => {
            const pnl = parsePnl(data[m.id]?.total_pnl || data[m.id]?.net_pnl || 0);
            if (Math.abs(pnl) > 0.01) modulePnls[m.name] = pnl;
        });

        charts.modulePnl.data = {
            labels: Object.keys(modulePnls),
            datasets: [{ data: Object.values(modulePnls).map(Math.abs), backgroundColor: Object.keys(modulePnls).map((_, i) => Object.values(moduleColors)[i]) }]
        };
        charts.modulePnl.update('none');

        // Win Rate by Module
        const winRateLabels = [];
        const winRateData = [];
        MODULES.forEach(m => {
            if (data[m.id]?.mode || data[m.id]?.status === 'Active') {
                winRateLabels.push(m.name);
                winRateData.push(parseFloat(String(data[m.id]?.win_rate || '0').replace('%', '')));
            }
        });

        charts.winRate.data = {
            labels: winRateLabels.length ? winRateLabels : ['No Data'],
            datasets: [{ label: 'Win Rate %', data: winRateData.length ? winRateData : [0], backgroundColor: '#10b981' }]
        };
        charts.winRate.update('none');

        // PnL Distribution
        const bins = [-100, -50, -25, -10, 0, 10, 25, 50, 100];
        const counts = new Array(bins.length - 1).fill(0);
        allTrades.forEach(t => {
            const pnl = parsePnl(t.pnl || t.net_pnl || 0);
            for (let i = 0; i < bins.length - 1; i++) {
                if (pnl >= bins[i] && pnl < bins[i + 1]) { counts[i]++; break; }
            }
        });

        charts.pnlDist.data = {
            labels: bins.slice(0, -1).map((b, i) => `${b} to ${bins[i+1]}`),
            datasets: [{ label: 'Trade Count', data: counts, backgroundColor: counts.map((_, i) => bins[i] < 0 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(16, 185, 129, 0.6)') }]
        };
        charts.pnlDist.update('none');
    }

    function updateTradeLog(data) {
        // Already collected in updateCharts
        filterTrades();
    }

    function filterTrades() {
        const moduleFilter = document.getElementById('moduleFilter').value;
        const resultFilter = document.getElementById('resultFilter').value;

        let filtered = allTrades.filter(t => {
            if (moduleFilter !== 'all' && t.module !== moduleFilter) return false;
            if (resultFilter === 'win' && parsePnl(t.pnl || t.net_pnl) < 0) return false;
            if (resultFilter === 'loss' && parsePnl(t.pnl || t.net_pnl) >= 0) return false;
            return true;
        });

        const tbody = document.getElementById('tradeLogBody');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #64748b;">No trades match filters</td></tr>';
            return;
        }

        // Reverse for most recent first
        filtered = filtered.reverse().slice(0, 100);

        tbody.innerHTML = filtered.map(t => {
            const pnl = parsePnl(t.pnl || t.net_pnl || 0);
            const pnlClass = pnl >= 0 ? 'positive' : 'negative';
            const pnlPct = typeof t.pnl_pct === 'number' ? t.pnl_pct.toFixed(2) + '%' : (t.pnl_pct || '0%');
            return `
                <tr>
                    <td>${formatTime(t.time || t.closed_at)}</td>
                    <td><span class="module-badge ${t.module}">${t.moduleLabel}</span></td>
                    <td>${t.symbol || t.token_symbol || 'N/A'}</td>
                    <td>${t.side || 'N/A'}</td>
                    <td>$${parseFloat(t.entry_price || 0).toFixed(6)}</td>
                    <td>$${parseFloat(t.exit_price || 0).toFixed(6)}</td>
                    <td>${parseFloat(t.size || t.amount || 0).toFixed(4)}</td>
                    <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                    <td class="${pnlClass}">${pnlPct}</td>
                    <td>${formatExitReason(t.exit_reason || t.close_reason)}</td>
                    <td>${formatDuration(t.duration_seconds)}</td>
                </tr>
            `;
        }).join('');
    }

    function checkWarnings(data) {
        const warnings = [];
        MODULES.forEach(m => {
            const modData = data[m.id];
            if (!modData) return;

            if (modData.mode === 'LIVE' && (modData.total_trades || 0) < 10) {
                warnings.push(`${m.name} is in LIVE mode with less than 10 simulated trades.`);
            }

            const sharpe = parseFloat(modData.sharpe_ratio);
            if (!isNaN(sharpe) && sharpe < 0) {
                warnings.push(`${m.name} has negative Sharpe ratio (${sharpe.toFixed(2)}).`);
            }

            const dd = parseFloat(String(modData.max_drawdown || '0').replace('%', ''));
            if (dd > 20) {
                warnings.push(`${m.name} max drawdown is high (${dd.toFixed(1)}%).`);
            }
        });

        const card = document.getElementById('warningsCard');
        const list = document.getElementById('warningsList');

        if (warnings.length > 0) {
            card.style.display = 'block';
            list.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
        } else {
            card.style.display = 'none';
        }
    }

    // Utilities
    function parsePnl(val) {
        if (val === null || val === undefined) return 0;
        if (typeof val === 'number') return val;
        const cleaned = String(val).replace(/[^0-9.-]/g, '');
        return parseFloat(cleaned) || 0;
    }

    function formatTime(t) {
        if (!t) return 'N/A';
        return new Date(t).toLocaleString();
    }

    function formatDuration(s) {
        if (!s) return 'N/A';
        if (s < 60) return `${s}s`;
        if (s < 3600) return `${Math.floor(s / 60)}m`;
        return `${Math.floor(s / 3600)}h ${Math.floor((s % 3600) / 60)}m`;
    }

    function formatExitReason(reason) {
        if (!reason || reason === 'unknown') return '<span class="exit-badge signal">-</span>';
        const map = {
            'take_profit': { label: 'TP', class: 'tp' },
            'take_profit_1': { label: 'TP1', class: 'tp' },
            'take_profit_2': { label: 'TP2', class: 'tp' },
            'stop_loss': { label: 'SL', class: 'sl' },
            'trailing_stop': { label: 'TSL', class: 'tsl' },
            'signal': { label: 'Signal', class: 'signal' }
        };
        const info = map[reason];
        return info ? `<span class="exit-badge ${info.class}">${info.label}</span>` : `<span class="exit-badge signal">${reason}</span>`;
    }

    async function exportSimulatedTrades() {
        try {
            const response = await fetch('/api/simulator/export');
            if (!response.ok) throw new Error('Export failed');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `simulator_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (e) {
            alert('Export failed: ' + e.message);
        }
    }
</script>
{% endblock %}
