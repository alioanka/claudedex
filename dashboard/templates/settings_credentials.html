{% extends "base.html" %}

{% block title %}Secure Credentials - ClaudeDex{% endblock %}

{% block head %}
<style>
    .credential-card {
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
    }
    .credential-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .credential-card.configured {
        border-left-color: #28a745;
    }
    .credential-card.not-configured {
        border-left-color: #ffc107;
    }
    .credential-card.required.not-configured {
        border-left-color: #dc3545;
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .credential-value-input {
        font-family: monospace;
    }
    .credential-actions {
        display: flex;
        gap: 5px;
    }

    .status-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
    }

    .stats-card {
        text-align: center;
        padding: 20px;
    }
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
    }

    .security-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .migration-status {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .key-storage-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
    }
    .key-storage-indicator.docker { background: #d4edda; color: #155724; }
    .key-storage-indicator.file { background: #cce5ff; color: #004085; }
    .key-storage-indicator.env { background: #fff3cd; color: #856404; }

    .credential-modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-shield-alt me-2"></i>Secure Credentials Manager</h2>
            <p class="text-muted">Manage encrypted credentials for all modules. Values are encrypted at rest.</p>
        </div>
    </div>

    <!-- Security Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="securityStatus">
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number text-primary" id="statTotal">0</div>
                <div class="text-muted">Total Credentials</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number text-success" id="statConfigured">0</div>
                <div class="text-muted">Configured</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number text-danger" id="statRequired">0</div>
                <div class="text-muted">Required Missing</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number text-info" id="statBootstrap">-</div>
                <div class="text-muted">Storage Mode</div>
            </div>
        </div>
    </div>

    <!-- Migration Tool -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Migration Tools</h5>
                    <button class="btn btn-primary btn-sm" onclick="showMigrationModal()">
                        <i class="fas fa-upload me-1"></i>Import from .env
                    </button>
                </div>
                <div class="card-body">
                    <p class="mb-2">Use these tools to migrate credentials from .env to the secure database storage.</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="importFromEnv()">
                            <i class="fas fa-file-import me-1"></i>Auto-Import All
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="validateCredentials()">
                            <i class="fas fa-check-circle me-1"></i>Validate All
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="rotateEncryptionKey()">
                            <i class="fas fa-sync me-1"></i>Rotate Encryption Key
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Filter -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group" id="categoryFilter">
                <button type="button" class="btn btn-outline-primary active" data-category="all">
                    <i class="fas fa-globe me-1"></i>All
                </button>
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Credentials by Category -->
    <div id="credentialsList">
        <!-- Will be populated by JS -->
    </div>
</div>

<!-- Edit Credential Modal -->
<div class="modal fade" id="editCredentialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Credential</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCredentialForm">
                    <input type="hidden" id="editKeyName">

                    <div class="mb-3">
                        <label class="form-label">Key Name</label>
                        <input type="text" class="form-control" id="editKeyNameDisplay" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="editDisplayName">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Value</label>
                        <div class="input-group">
                            <input type="password" class="form-control credential-value-input" id="editValue"
                                   placeholder="Enter new value (leave empty to keep current)">
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('editValue')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Leave empty to keep the current value</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editCategory">
                                    <option value="security">Security</option>
                                    <option value="wallet">Wallet</option>
                                    <option value="exchange">Exchange</option>
                                    <option value="database">Database</option>
                                    <option value="api">API</option>
                                    <option value="notification">Notification</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Module</label>
                                <select class="form-select" id="editModule">
                                    <option value="all">All</option>
                                    <option value="dex">DEX</option>
                                    <option value="futures">Futures</option>
                                    <option value="solana">Solana</option>
                                    <option value="ai">AI</option>
                                    <option value="copytrading">Copy Trading</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="editIsRequired">
                        <label class="form-check-label" for="editIsRequired">Required for operation</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCredential()">
                    <i class="fas fa-save me-1"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Credential Modal -->
<div class="modal fade" id="addCredentialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add New Credential</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCredentialForm">
                    <div class="mb-3">
                        <label class="form-label">Key Name *</label>
                        <input type="text" class="form-control" id="addKeyName"
                               placeholder="e.g., MY_API_KEY" pattern="[A-Z0-9_]+" required>
                        <small class="text-muted">Use UPPERCASE with underscores only</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Value *</label>
                        <div class="input-group">
                            <input type="password" class="form-control credential-value-input" id="addValue" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('addValue')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="addDisplayName">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="addCategory">
                            <option value="general">General</option>
                            <option value="security">Security</option>
                            <option value="wallet">Wallet</option>
                            <option value="exchange">Exchange</option>
                            <option value="database">Database</option>
                            <option value="api">API</option>
                            <option value="notification">Notification</option>
                        </select>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="addIsSensitive" checked>
                        <label class="form-check-label" for="addIsSensitive">Encrypt this value</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewCredential()">
                    <i class="fas fa-plus me-1"></i>Add Credential
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import from .env Modal -->
<div class="modal fade" id="importEnvModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-import me-2"></i>Import from .env</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This will import credentials from your .env file into the secure database.
                    Values will be encrypted before storage.
                </div>

                <div id="importPreview">
                    <!-- Will be populated with credentials to import -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="performImport()">
                    <i class="fas fa-upload me-1"></i>Import Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let credentials = [];
let categories = [];
let currentCategory = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadCredentials();
    loadCategories();
    loadStats();

    // Category filter click handlers
    document.getElementById('categoryFilter').addEventListener('click', function(e) {
        if (e.target.dataset.category) {
            document.querySelectorAll('#categoryFilter button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentCategory = e.target.dataset.category;
            renderCredentials();
        }
    });
});

async function loadCredentials() {
    try {
        const response = await fetch('/api/credentials', {credentials: 'same-origin'});
        if (!response.ok) {
            console.error('Credentials API error:', response.status);
            return;
        }
        credentials = await response.json();
        renderCredentials();
    } catch (error) {
        console.error('Failed to load credentials:', error);
        showToast('Failed to load credentials', 'error');
    }
}

async function loadCategories() {
    try {
        const response = await fetch('/api/credentials/categories', {credentials: 'same-origin'});
        if (!response.ok) return;
        categories = await response.json();
        renderCategoryFilter();
    } catch (error) {
        console.error('Failed to load categories:', error);
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/credentials/stats', {credentials: 'same-origin'});
        if (!response.ok) return;
        const stats = await response.json();

        document.getElementById('statTotal').textContent = stats.total || 0;
        document.getElementById('statConfigured').textContent = stats.configured || 0;
        document.getElementById('statRequired').textContent =
            (stats.required || 0) - (stats.required_configured || 0);
        document.getElementById('statBootstrap').textContent =
            stats.is_bootstrap_mode ? 'Fallback (.env)' : 'Database';

        // Update security status
        updateSecurityStatus(stats);
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

function updateSecurityStatus(stats) {
    const container = document.getElementById('securityStatus');

    if (stats.is_bootstrap_mode) {
        container.innerHTML = `
            <div class="security-warning">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Bootstrap Mode Active</h5>
                <p class="mb-2">Credentials are being loaded from .env file. For better security:</p>
                <ol class="mb-0">
                    <li>Import credentials to database using the Migration Tools below</li>
                    <li>Move encryption key to /secure/encryption.key or Docker secret</li>
                    <li>Remove sensitive values from .env file</li>
                </ol>
            </div>
        `;
    } else if (!stats.has_encryption) {
        container.innerHTML = `
            <div class="security-warning">
                <h5><i class="fas fa-lock-open me-2"></i>Encryption Not Available</h5>
                <p class="mb-0">Encryption key not found. Sensitive credentials cannot be stored securely.</p>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="migration-status">
                <h5><i class="fas fa-check-circle text-success me-2"></i>Secure Mode Active</h5>
                <p class="mb-0">Credentials are stored encrypted in the database.</p>
            </div>
        `;
    }
}

function renderCategoryFilter() {
    const filter = document.getElementById('categoryFilter');
    categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-primary';
        btn.dataset.category = cat.category;
        btn.innerHTML = `<i class="${cat.icon || 'fas fa-folder'} me-1"></i>${cat.display_name}`;
        filter.appendChild(btn);
    });
}

function renderCredentials() {
    const container = document.getElementById('credentialsList');
    container.innerHTML = '';

    // Filter by category
    let filtered = currentCategory === 'all' ?
        credentials :
        credentials.filter(c => c.category === currentCategory);

    // Group by category
    const grouped = {};
    filtered.forEach(cred => {
        if (!grouped[cred.category]) {
            grouped[cred.category] = [];
        }
        grouped[cred.category].push(cred);
    });

    // Render each category
    for (const [category, creds] of Object.entries(grouped)) {
        const catInfo = categories.find(c => c.category === category) || {
            display_name: category,
            icon: 'fas fa-key',
            color: '#6c757d'
        };

        const section = document.createElement('div');
        section.className = 'mb-4';
        section.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background-color: ${catInfo.color}">
                    <i class="${catInfo.icon}"></i>
                </div>
                <div>
                    <h5 class="mb-0">${catInfo.display_name}</h5>
                    <small class="text-muted">${creds.length} credentials</small>
                </div>
            </div>
            <div class="row" id="creds-${category}"></div>
        `;
        container.appendChild(section);

        const row = section.querySelector(`#creds-${category}`);
        creds.forEach(cred => {
            const card = createCredentialCard(cred);
            row.appendChild(card);
        });
    }

    // Add "Add New" button
    container.innerHTML += `
        <div class="text-center mt-4">
            <button class="btn btn-outline-primary" onclick="showAddModal()">
                <i class="fas fa-plus me-2"></i>Add New Credential
            </button>
        </div>
    `;
}

function createCredentialCard(cred) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-3';

    const statusClass = cred.has_value ? 'configured' : 'not-configured';
    const requiredClass = cred.is_required ? 'required' : '';

    col.innerHTML = `
        <div class="card credential-card ${statusClass} ${requiredClass}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">${cred.display_name || cred.key_name}</h6>
                    <div>
                        ${cred.is_required ? '<span class="badge bg-danger status-badge">Required</span>' : ''}
                        ${cred.has_value ?
                            '<span class="badge bg-success status-badge">Configured</span>' :
                            '<span class="badge bg-warning status-badge">Not Set</span>'}
                    </div>
                </div>

                <p class="card-text small text-muted mb-2">
                    <code>${cred.key_name}</code>
                </p>

                ${cred.description ? `<p class="card-text small mb-2">${cred.description}</p>` : ''}

                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <span class="badge bg-secondary">${cred.subcategory || cred.module || 'all'}</span>
                    </small>
                    <div class="credential-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editCredential('${cred.key_name}')"
                                title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${cred.has_value ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCredential('${cred.key_name}')"
                                    title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;

    return col;
}

function editCredential(keyName) {
    const cred = credentials.find(c => c.key_name === keyName);
    if (!cred) return;

    document.getElementById('editKeyName').value = cred.key_name;
    document.getElementById('editKeyNameDisplay').value = cred.key_name;
    document.getElementById('editDisplayName').value = cred.display_name || '';
    document.getElementById('editDescription').value = cred.description || '';
    document.getElementById('editCategory').value = cred.category || 'general';
    document.getElementById('editModule').value = cred.module || 'all';
    document.getElementById('editIsRequired').checked = cred.is_required || false;
    document.getElementById('editValue').value = '';

    new bootstrap.Modal(document.getElementById('editCredentialModal')).show();
}

async function saveCredential() {
    const keyName = document.getElementById('editKeyName').value;
    const value = document.getElementById('editValue').value;

    const data = {
        display_name: document.getElementById('editDisplayName').value,
        description: document.getElementById('editDescription').value,
        category: document.getElementById('editCategory').value,
        module: document.getElementById('editModule').value,
        is_required: document.getElementById('editIsRequired').checked
    };

    // Only include value if it was changed
    if (value) {
        data.value = value;
    }

    try {
        const response = await fetch(`/api/credentials/${keyName}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
            credentials: 'same-origin'
        });

        if (response.ok) {
            showToast('Credential saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editCredentialModal')).hide();
            loadCredentials();
            loadStats();
        } else {
            const error = await response.json();
            showToast(error.message || 'Failed to save credential', 'error');
        }
    } catch (error) {
        showToast('Failed to save credential', 'error');
    }
}

function showAddModal() {
    document.getElementById('addCredentialForm').reset();
    new bootstrap.Modal(document.getElementById('addCredentialModal')).show();
}

async function addNewCredential() {
    const keyName = document.getElementById('addKeyName').value.toUpperCase();
    const value = document.getElementById('addValue').value;

    if (!keyName || !value) {
        showToast('Key name and value are required', 'error');
        return;
    }

    const data = {
        key_name: keyName,
        value: value,
        display_name: document.getElementById('addDisplayName').value || keyName,
        category: document.getElementById('addCategory').value,
        is_sensitive: document.getElementById('addIsSensitive').checked
    };

    try {
        const response = await fetch('/api/credentials', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
            credentials: 'same-origin'
        });

        if (response.ok) {
            showToast('Credential added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addCredentialModal')).hide();
            loadCredentials();
            loadStats();
        } else {
            const error = await response.json();
            showToast(error.message || 'Failed to add credential', 'error');
        }
    } catch (error) {
        showToast('Failed to add credential', 'error');
    }
}

async function deleteCredential(keyName) {
    if (!confirm(`Are you sure you want to remove the value for ${keyName}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/credentials/${keyName}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        if (response.ok) {
            showToast('Credential removed', 'success');
            loadCredentials();
            loadStats();
        } else {
            showToast('Failed to remove credential', 'error');
        }
    } catch (error) {
        showToast('Failed to remove credential', 'error');
    }
}

async function importFromEnv() {
    if (!confirm('This will import all credentials from .env to the database. Continue?')) {
        return;
    }

    try {
        const response = await fetch('/api/credentials/import-env', {
            method: 'POST',
            credentials: 'same-origin'
        });

        const result = await response.json();

        if (response.ok) {
            showToast(`Imported ${result.imported} credentials`, 'success');
            loadCredentials();
            loadStats();
        } else {
            showToast(result.message || 'Import failed', 'error');
        }
    } catch (error) {
        showToast('Import failed', 'error');
    }
}

async function validateCredentials() {
    try {
        const response = await fetch('/api/credentials/validate', {credentials: 'same-origin'});
        const result = await response.json();

        if (result.all_valid) {
            showToast('All credentials are valid', 'success');
        } else {
            showToast(`${result.invalid_count} credentials have issues`, 'warning');
        }
    } catch (error) {
        showToast('Validation failed', 'error');
    }
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showMigrationModal() {
    new bootstrap.Modal(document.getElementById('importEnvModal')).show();
}

async function rotateEncryptionKey() {
    if (!confirm('WARNING: Rotating the encryption key will re-encrypt all credentials. Make sure you have a backup. Continue?')) {
        return;
    }

    showToast('Encryption key rotation is not yet implemented. Please rotate manually.', 'warning');
}
</script>
{% endblock %}
