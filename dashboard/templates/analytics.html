{% extends "base.html" %}

{% block title %}Advanced Analytics - ClaudeDex{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/analytics.css">
<style>
    .portfolio-summary {
        margin-bottom: 24px;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .stat {
        background: var(--bg-tertiary);
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .pnl-positive {
        color: var(--accent-success) !important;
    }

    .pnl-negative {
        color: var(--accent-danger) !important;
    }

    .module-tabs {
        margin-bottom: 24px;
    }

    .tabs-header {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .tab-button {
        padding: 10px 20px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab-button:hover {
        background: var(--bg-secondary);
    }

    .tab-button.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    .metric {
        text-align: center;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
    }

    .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
        display: block;
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }

    .chart-card .card-body {
        height: 300px;
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
    }

    .trades-table th,
    .trades-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .trades-table th {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .no-data {
        text-align: center;
        color: var(--text-secondary);
        padding: 40px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Advanced Analytics</h1>
    <div class="page-actions">
        <select id="timeframe-selector" class="form-control" style="width: auto;">
            <option value="1h">1 Hour</option>
            <option value="4h">4 Hours</option>
            <option value="24h" selected>24 Hours</option>
            <option value="7d">7 Days</option>
            <option value="30d">30 Days</option>
            <option value="all">All Time</option>
        </select>
        <button id="refresh-btn" class="btn btn-primary" onclick="refreshAnalytics()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
</div>

<!-- Portfolio Summary -->
<section class="portfolio-summary">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Portfolio Overview</h3>
        </div>
        <div class="card-body">
            <div class="summary-stats">
                <div class="stat">
                    <span class="stat-label">Total P&L</span>
                    <span id="total-pnl" class="stat-value pnl-positive">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Trades</span>
                    <span id="total-trades" class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Active Modules</span>
                    <span id="active-modules" class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Best Performer</span>
                    <span id="best-performer" class="stat-value">-</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Module Tabs -->
<section class="module-tabs">
    <div class="tabs-header" id="module-tabs">
        <button class="tab-button active" data-module="dex_trading">DEX Trading</button>
        <button class="tab-button" data-module="futures_trading">Futures Trading</button>
        <button class="tab-button" data-module="solana_trading">Solana Strategies</button>
    </div>
</section>

<!-- Module Analytics -->
<section class="module-analytics" id="module-analytics">
    <!-- Performance Metrics -->
    <div class="analytics-grid">
        <!-- Performance Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Performance Metrics</h3>
            </div>
            <div class="card-body">
                <div class="metrics-grid">
                    <div class="metric">
                        <span class="metric-label">Win Rate</span>
                        <span id="win-rate" class="metric-value">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Profit Factor</span>
                        <span id="profit-factor" class="metric-value">0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Sharpe Ratio</span>
                        <span id="sharpe-ratio" class="metric-value">0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Max Drawdown</span>
                        <span id="max-drawdown" class="metric-value">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Win</span>
                        <span id="avg-win" class="metric-value">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Loss</span>
                        <span id="avg-loss" class="metric-value">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Metrics -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Risk Metrics</h3>
            </div>
            <div class="card-body">
                <div class="metrics-grid">
                    <div class="metric">
                        <span class="metric-label">Total Exposure</span>
                        <span id="total-exposure" class="metric-value">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Net Exposure</span>
                        <span id="net-exposure" class="metric-value">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">VaR (95%)</span>
                        <span id="var-95" class="metric-value">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Volatility (Annual)</span>
                        <span id="annual-vol" class="metric-value">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Leverage</span>
                        <span id="avg-leverage" class="metric-value">1.0x</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Largest Position</span>
                        <span id="largest-position" class="metric-value">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <!-- Equity Curve -->
        <div class="card chart-card">
            <div class="card-header">
                <h3 class="card-title">Equity Curve</h3>
            </div>
            <div class="card-body">
                <canvas id="equity-chart"></canvas>
            </div>
        </div>

        <!-- Daily P&L -->
        <div class="card chart-card">
            <div class="card-header">
                <h3 class="card-title">Daily P&L</h3>
            </div>
            <div class="card-body">
                <canvas id="daily-pnl-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Trade History -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Trades</h3>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Token</th>
                            <th>Type</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>Size</th>
                            <th>P&L</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody id="trades-table-body">
                        <tr>
                            <td colspan="8" class="no-data">No trades found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="/static/js/analytics.js"></script>
<script>
function refreshAnalytics() {
    if (typeof initializeDashboard === 'function') {
        initializeDashboard();
    } else {
        location.reload();
    }
}

// Tab switching - use switchModule from analytics.js
document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const module = this.getAttribute('data-module');
        if (typeof switchModule === 'function') {
            switchModule(module);
        } else if (typeof loadModuleAnalytics === 'function') {
            loadModuleAnalytics(module, currentTimeframe || '24h');
        }
    });
});
</script>
{% endblock %}
