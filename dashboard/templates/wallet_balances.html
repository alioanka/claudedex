{% extends "base.html" %}

{% block title %}Wallet Balances{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .page-container {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    /* Total Portfolio Card */
    .total-portfolio-card {
        background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
        border: 2px solid #3b82f6;
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    .total-portfolio-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #10b981);
    }

    .total-portfolio-card::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        pointer-events: none;
    }

    .total-label {
        font-size: 0.875rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }

    .total-value {
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 16px;
    }

    .total-change {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
    }

    .total-change.positive {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .total-change.negative {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .portfolio-breakdown {
        display: flex;
        gap: 24px;
        margin-top: 24px;
        flex-wrap: wrap;
    }

    .breakdown-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 12px 20px;
        border-radius: 10px;
        min-width: 140px;
    }

    .breakdown-label {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-bottom: 4px;
    }

    .breakdown-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #f8fafc;
    }

    /* Chain Cards Grid */
    .chains-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chain-card {
        background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
        border-radius: 16px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .chain-card:hover {
        border-color: #4b5563;
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }

    .chain-card.ethereum { border-top: 3px solid #627eea; }
    .chain-card.bsc { border-top: 3px solid #f0b90b; }
    .chain-card.polygon { border-top: 3px solid #8247e5; }
    .chain-card.arbitrum { border-top: 3px solid #28a0f0; }
    .chain-card.base { border-top: 3px solid #0052ff; }
    .chain-card.solana { border-top: 3px solid #9945ff; }
    .chain-card.futures { border-top: 3px solid #f59e0b; }
    .chain-card.spot { border-top: 3px solid #10b981; }

    .chain-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chain-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chain-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .chain-icon.ethereum { background: rgba(98, 126, 234, 0.2); color: #627eea; }
    .chain-icon.bsc { background: rgba(240, 185, 11, 0.2); color: #f0b90b; }
    .chain-icon.polygon { background: rgba(130, 71, 229, 0.2); color: #8247e5; }
    .chain-icon.arbitrum { background: rgba(40, 160, 240, 0.2); color: #28a0f0; }
    .chain-icon.base { background: rgba(0, 82, 255, 0.2); color: #0052ff; }
    .chain-icon.solana { background: rgba(153, 69, 255, 0.2); color: #9945ff; }
    .chain-icon.futures { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .chain-icon.spot { background: rgba(16, 185, 129, 0.2); color: #10b981; }

    .chain-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #f9fafb;
    }

    .chain-network {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    .chain-status {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .chain-status.active {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .chain-status.inactive {
        background: rgba(107, 114, 128, 0.2);
        color: #9ca3af;
    }

    .chain-balance {
        margin-bottom: 20px;
    }

    .balance-usd {
        font-size: 2rem;
        font-weight: 700;
        color: #f9fafb;
        margin-bottom: 4px;
    }

    .balance-native {
        font-size: 1rem;
        color: #9ca3af;
    }

    .chain-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding-top: 16px;
        border-top: 1px solid #374151;
    }

    .chain-stat {
        text-align: center;
    }

    .chain-stat-label {
        font-size: 0.7rem;
        color: #9ca3af;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .chain-stat-value {
        font-size: 1rem;
        font-weight: 600;
        color: #f9fafb;
    }

    .positive { color: #10b981 !important; }
    .negative { color: #ef4444 !important; }

    /* Wallet Details Section */
    .wallet-section {
        background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #f9fafb;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .wallet-address-card {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
    }

    .wallet-address-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .wallet-type {
        font-size: 0.85rem;
        font-weight: 600;
        color: #94a3b8;
    }

    .wallet-address {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 0.85rem;
        color: #8b5cf6;
        background: rgba(139, 92, 246, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
        word-break: break-all;
    }

    .copy-btn {
        background: transparent;
        border: 1px solid #4b5563;
        color: #94a3b8;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .copy-btn:hover {
        background: #374151;
        color: #f9fafb;
    }

    /* Charts Section */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }

    .chart-card {
        background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
        border-radius: 16px;
        padding: 24px;
    }

    .chart-container {
        position: relative;
        height: 280px;
    }

    /* Token Holdings Table */
    .tokens-table-wrapper {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #374151;
    }

    .tokens-table {
        width: 100%;
        border-collapse: collapse;
    }

    .tokens-table th {
        background: #0f172a;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #94a3b8;
        font-size: 0.75rem;
        text-transform: uppercase;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .tokens-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #374151;
        color: #f9fafb;
    }

    .tokens-table tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }

    .token-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .token-symbol {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #374151, #1f2937);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        color: #f9fafb;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #374151;
        color: #e5e7eb;
        border: 1px solid #4b5563;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: #94a3b8;
    }

    .loading-spinner {
        border: 3px solid #374151;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .last-updated {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-wallet"></i>
                Wallet Balances
            </h1>
            <p class="page-subtitle">Multi-chain portfolio overview and wallet balances</p>
            <p class="last-updated" id="lastUpdated">Last updated: Loading...</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="loadBalances()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading wallet balances...</p>
    </div>

    <!-- Content (hidden until loaded) -->
    <div id="contentContainer" style="display: none;">
        <!-- Total Portfolio Value -->
        <div class="total-portfolio-card">
            <div class="total-label">Total Portfolio Value</div>
            <div class="total-value" id="totalValue">$0.00</div>
            <div class="total-change positive" id="totalChange">
                <i class="fas fa-arrow-up"></i>
                <span>$0.00 (0.00%)</span>
            </div>
            <div class="portfolio-breakdown" id="portfolioBreakdown">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Chain Cards -->
        <div class="chains-grid" id="chainsGrid">
            <!-- Dynamically populated -->
        </div>

        <!-- Charts Row -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    Portfolio Distribution
                </div>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Balance by Chain
                </div>
                <div class="chart-container">
                    <canvas id="chainBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Wallet Addresses -->
        <div class="wallet-section">
            <div class="section-title">
                <i class="fas fa-key"></i>
                Wallet Addresses
            </div>
            <div id="walletAddresses">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Exchange Assets (if available) -->
        <div class="wallet-section" id="exchangeAssetsSection" style="display: none;">
            <div class="section-title">
                <i class="fas fa-coins"></i>
                Exchange Assets (Binance Spot)
            </div>
            <div class="tokens-table-wrapper">
                <table class="tokens-table">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Balance</th>
                            <th>USD Value</th>
                        </tr>
                    </thead>
                    <tbody id="exchangeAssetsTable">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let distributionChart = null;
let chainBarChart = null;

const CHAIN_CONFIG = {
    'ETHEREUM': { name: 'Ethereum', icon: 'fab fa-ethereum', class: 'ethereum', network: 'Mainnet' },
    'BSC': { name: 'BNB Smart Chain', icon: 'fas fa-coins', class: 'bsc', network: 'BSC Mainnet' },
    'POLYGON': { name: 'Polygon', icon: 'fas fa-hexagon', class: 'polygon', network: 'Polygon PoS' },
    'ARBITRUM': { name: 'Arbitrum', icon: 'fas fa-bolt', class: 'arbitrum', network: 'Arbitrum One' },
    'BASE': { name: 'Base', icon: 'fas fa-circle', class: 'base', network: 'Base Mainnet' },
    'SOLANA': { name: 'Solana', icon: 'fas fa-sun', class: 'solana', network: 'Mainnet Beta' },
    'SOLANA_MODULE': { name: 'Solana (Trading)', icon: 'fas fa-robot', class: 'solana', network: 'Trading Module' },
    'FUTURES': { name: 'Binance Futures', icon: 'fas fa-chart-line', class: 'futures', network: 'USDT-M' },
    'SPOT': { name: 'Binance Spot', icon: 'fas fa-wallet', class: 'spot', network: 'Spot Account' }
};

const CHAIN_COLORS = {
    'ETHEREUM': '#627eea',
    'BSC': '#f0b90b',
    'POLYGON': '#8247e5',
    'ARBITRUM': '#28a0f0',
    'BASE': '#0052ff',
    'SOLANA': '#9945ff',
    'SOLANA_MODULE': '#14f195',
    'FUTURES': '#f59e0b',
    'SPOT': '#10b981'
};

async function loadBalances() {
    try {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('contentContainer').style.display = 'none';

        const response = await fetch('/api/wallets/balances');
        const data = await response.json();

        if (data.status === 'success') {
            renderBalances(data.balances);
            document.getElementById('lastUpdated').textContent =
                'Last updated: ' + new Date().toLocaleString();
        } else {
            console.error('Failed to load balances:', data.error);
        }

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('contentContainer').style.display = 'block';
    } catch (error) {
        console.error('Error loading balances:', error);
        document.getElementById('loadingState').innerHTML = `
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ef4444; margin-bottom: 16px;"></i>
            <p>Failed to load wallet balances. Please try again.</p>
            <button class="btn btn-primary" onclick="loadBalances()" style="margin-top: 16px;">
                <i class="fas fa-sync"></i> Retry
            </button>
        `;
    }
}

function renderBalances(balances) {
    // Total Portfolio
    const total = balances.TOTAL || { balance: 0, pnl: 0, pnl_pct: 0 };
    document.getElementById('totalValue').textContent = '$' + formatNumber(total.balance);

    const totalChangeEl = document.getElementById('totalChange');
    const pnlSign = total.pnl >= 0 ? '+' : '';
    totalChangeEl.innerHTML = `
        <i class="fas fa-arrow-${total.pnl >= 0 ? 'up' : 'down'}"></i>
        <span>${pnlSign}$${formatNumber(Math.abs(total.pnl))} (${total.pnl_pct.toFixed(2)}%)</span>
    `;
    totalChangeEl.className = 'total-change ' + (total.pnl >= 0 ? 'positive' : 'negative');

    // Portfolio Breakdown
    const breakdownEl = document.getElementById('portfolioBreakdown');
    const onChainValue = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE', 'SOLANA', 'SOLANA_MODULE']
        .reduce((sum, chain) => sum + (balances[chain]?.balance || 0), 0);
    const exchangeValue = (balances.FUTURES?.balance || 0) + (balances.SPOT?.balance || 0);
    const totalPositions = total.positions || 0;

    breakdownEl.innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">On-Chain</div>
            <div class="breakdown-value">$${formatNumber(onChainValue)}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Exchange</div>
            <div class="breakdown-value">$${formatNumber(exchangeValue)}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Active Positions</div>
            <div class="breakdown-value">${totalPositions}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Chains Active</div>
            <div class="breakdown-value">${countActiveChains(balances)}</div>
        </div>
    `;

    // Chain Cards
    renderChainCards(balances);

    // Charts
    renderDistributionChart(balances);
    renderChainBarChart(balances);

    // Exchange Assets
    if (balances.SPOT && balances.SPOT.assets && balances.SPOT.assets.length > 0) {
        document.getElementById('exchangeAssetsSection').style.display = 'block';
        renderExchangeAssets(balances.SPOT.assets);
    }

    // Wallet Addresses
    renderWalletAddresses();
}

function renderChainCards(balances) {
    const grid = document.getElementById('chainsGrid');
    grid.innerHTML = '';

    const chains = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE', 'SOLANA', 'SOLANA_MODULE', 'FUTURES', 'SPOT'];

    chains.forEach(chain => {
        const data = balances[chain];
        if (!data) return;

        const config = CHAIN_CONFIG[chain] || { name: chain, icon: 'fas fa-link', class: 'default' };
        const hasBalance = (data.balance || 0) > 0.01 || (data.native_balance || 0) > 0;
        const isActive = hasBalance || (data.positions || 0) > 0;

        const pnl = data.pnl || 0;
        const pnlPct = data.pnl_pct || 0;
        const positions = data.positions || 0;

        const card = document.createElement('div');
        card.className = `chain-card ${config.class}`;
        card.innerHTML = `
            <div class="chain-header">
                <div class="chain-info">
                    <div class="chain-icon ${config.class}">
                        <i class="${config.icon}"></i>
                    </div>
                    <div>
                        <div class="chain-name">${config.name}</div>
                        <div class="chain-network">${config.network}</div>
                    </div>
                </div>
                <span class="chain-status ${isActive ? 'active' : 'inactive'}">
                    ${isActive ? 'Active' : 'Empty'}
                </span>
            </div>
            <div class="chain-balance">
                <div class="balance-usd">$${formatNumber(data.balance || 0)}</div>
                ${data.native_balance !== undefined ? `
                    <div class="balance-native">
                        ${formatNumber(data.native_balance, 6)} ${data.native_symbol || ''}
                    </div>
                ` : ''}
            </div>
            <div class="chain-stats">
                <div class="chain-stat">
                    <div class="chain-stat-label">P&L</div>
                    <div class="chain-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                        ${pnl >= 0 ? '+' : ''}$${formatNumber(Math.abs(pnl))}
                    </div>
                </div>
                <div class="chain-stat">
                    <div class="chain-stat-label">Positions</div>
                    <div class="chain-stat-value">${positions}</div>
                </div>
            </div>
        `;

        grid.appendChild(card);
    });
}

function renderDistributionChart(balances) {
    const ctx = document.getElementById('distributionChart').getContext('2d');

    const chains = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE', 'SOLANA', 'SOLANA_MODULE', 'FUTURES', 'SPOT'];
    const data = [];
    const labels = [];
    const colors = [];

    chains.forEach(chain => {
        const balance = balances[chain]?.balance || 0;
        if (balance > 0.01) {
            const config = CHAIN_CONFIG[chain] || { name: chain };
            labels.push(config.name);
            data.push(balance);
            colors.push(CHAIN_COLORS[chain] || '#6b7280');
        }
    });

    if (distributionChart) distributionChart.destroy();

    distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#94a3b8',
                        padding: 16,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const pct = ((ctx.raw / total) * 100).toFixed(1);
                            return `$${formatNumber(ctx.raw)} (${pct}%)`;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
}

function renderChainBarChart(balances) {
    const ctx = document.getElementById('chainBarChart').getContext('2d');

    const chains = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE', 'SOLANA', 'SOLANA_MODULE', 'FUTURES', 'SPOT'];
    const data = [];
    const labels = [];
    const colors = [];

    chains.forEach(chain => {
        const balance = balances[chain]?.balance || 0;
        const config = CHAIN_CONFIG[chain] || { name: chain };
        labels.push(config.name.replace(' (Trading)', '').substring(0, 10));
        data.push(balance);
        colors.push(CHAIN_COLORS[chain] || '#6b7280');
    });

    if (chainBarChart) chainBarChart.destroy();

    chainBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Balance (USD)',
                data: data,
                backgroundColor: colors,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => '$' + formatNumber(value)
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8', maxRotation: 45 }
                }
            }
        }
    });
}

function renderExchangeAssets(assets) {
    const tbody = document.getElementById('exchangeAssetsTable');
    tbody.innerHTML = '';

    // Sort by USD value descending
    const sortedAssets = [...assets].sort((a, b) => (b.usd_value || 0) - (a.usd_value || 0));

    sortedAssets.forEach(asset => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="token-info">
                    <div class="token-symbol">${asset.asset.substring(0, 2)}</div>
                    <div>
                        <div style="font-weight: 600;">${asset.asset}</div>
                    </div>
                </div>
            </td>
            <td>${formatNumber(asset.total, 8)}</td>
            <td style="font-weight: 600;">$${formatNumber(asset.usd_value)}</td>
        `;
        tbody.appendChild(row);
    });
}

function renderWalletAddresses() {
    const container = document.getElementById('walletAddresses');
    container.innerHTML = '';

    const wallets = [
        { type: 'EVM Wallet', env: 'WALLET_ADDRESS', placeholder: '0x...' },
        { type: 'Solana Main Wallet', env: 'SOLANA_WALLET', placeholder: 'ABC123...' },
        { type: 'Solana Trading Module', env: 'SOLANA_MODULE_WALLET', placeholder: 'XYZ789...' }
    ];

    wallets.forEach(wallet => {
        // We'll show placeholder text - actual addresses are fetched from env but masked for security
        const card = document.createElement('div');
        card.className = 'wallet-address-card';
        card.innerHTML = `
            <div class="wallet-address-header">
                <span class="wallet-type">${wallet.type}</span>
                <button class="copy-btn" onclick="copyWalletInfo('${wallet.type}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="wallet-address" id="wallet-${wallet.env}">
                ${wallet.placeholder} (configured via environment)
            </div>
        `;
        container.appendChild(card);
    });
}

function copyWalletInfo(walletType) {
    // In a real implementation, this would copy the actual wallet address
    alert(`${walletType} address copied to clipboard!`);
}

function countActiveChains(balances) {
    const chains = ['ETHEREUM', 'BSC', 'POLYGON', 'ARBITRUM', 'BASE', 'SOLANA', 'SOLANA_MODULE', 'FUTURES', 'SPOT'];
    return chains.filter(chain => {
        const data = balances[chain];
        return data && ((data.balance || 0) > 0.01 || (data.native_balance || 0) > 0);
    }).length;
}

function formatNumber(num, decimals = 2) {
    if (num === undefined || num === null) return '0';
    const n = parseFloat(num);
    if (isNaN(n)) return '0';
    if (Math.abs(n) >= 1000000) {
        return (n / 1000000).toFixed(2) + 'M';
    } else if (Math.abs(n) >= 1000) {
        return (n / 1000).toFixed(2) + 'K';
    }
    return n.toFixed(decimals);
}

// Load on page load
loadBalances();

// Auto-refresh every 60 seconds
setInterval(loadBalances, 60000);
</script>
{% endblock %}
