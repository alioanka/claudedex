{% extends "base.html" %}

{% block title %}Solana Trades{% endblock %}

{% block extra_head %}
<style>
    .page-container {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
    }

    .trades-table th, .trades-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .trades-table th {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
    }

    .trades-table td {
        color: var(--text-primary);
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-open { background: #dbeafe; color: #1d4ed8; }
    .badge-close { background: #fef3c7; color: #b45309; }
    .badge-buy { background: #d1fae5; color: #065f46; }
    .badge-sell { background: #fee2e2; color: #991b1b; }
    .badge-jupiter { background: #e0e7ff; color: #4338ca; }
    .badge-drift { background: #fce7f3; color: #9d174d; }
    .badge-pumpfun { background: #ccfbf1; color: #0f766e; }
    .badge-dry { background: #f3f4f6; color: #374151; }
    .badge-live { background: #fef3c7; color: #b45309; }

    .positive { color: #10b981; }
    .negative { color: #ef4444; }

    .stats-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-box {
        background: var(--metric-bg, #f9fafb);
        padding: 16px 20px;
        border-radius: 8px;
        text-align: center;
        flex: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --metric-bg: #111827;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-exchange-alt"></i>
                Solana Trades
            </h1>
            <p class="page-subtitle">Trade history for Solana strategies</p>
        </div>
        <button class="btn btn-secondary" onclick="loadTrades()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <!-- Stats Summary -->
    <div class="stats-row">
        <div class="stat-box">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="total-trades">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Open Positions</div>
            <div class="stat-value" id="open-positions">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Closed Trades</div>
            <div class="stat-value" id="closed-trades">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="win-rate">0%</div>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-history"></i>
            Recent Trades
        </div>
        <div id="trades-container">
            <div class="empty-state" id="empty-state">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 16px; display: block;"></i>
                <p>No trades yet. Trade history will appear here.</p>
            </div>
            <table class="trades-table" id="trades-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Token</th>
                        <th>Strategy</th>
                        <th>Side</th>
                        <th>Price</th>
                        <th>Amount</th>
                        <th>P&L</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody id="trades-body">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function loadTrades() {
    try {
        const response = await fetch('/api/solana/trades');
        if (response.ok) {
            const data = await response.json();
            if (data.trades && data.trades.length > 0) {
                displayTrades(data.trades);
            } else {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('trades-table').style.display = 'none';
            }
        }
    } catch (e) {
        console.error('Failed to load trades:', e);
    }
}

function displayTrades(trades) {
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('trades-table').style.display = 'table';

    // Calculate stats
    let opens = 0, closes = 0, wins = 0;
    trades.forEach(t => {
        if (t.type === 'OPEN') opens++;
        if (t.type === 'CLOSE') {
            closes++;
            if (t.win) wins++;
        }
    });

    document.getElementById('total-trades').textContent = trades.length;
    document.getElementById('open-positions').textContent = opens - closes;
    document.getElementById('closed-trades').textContent = closes;
    document.getElementById('win-rate').textContent = closes > 0 ? `${((wins/closes)*100).toFixed(0)}%` : '0%';

    const tbody = document.getElementById('trades-body');
    tbody.innerHTML = '';

    trades.forEach(trade => {
        const row = document.createElement('tr');

        // Format timestamp
        const time = new Date(trade.timestamp).toLocaleString();

        // Type badge
        const typeBadge = trade.type === 'OPEN'
            ? '<span class="badge badge-open">OPEN</span>'
            : '<span class="badge badge-close">CLOSE</span>';

        // Side badge
        const sideBadge = trade.side === 'BUY'
            ? '<span class="badge badge-buy">BUY</span>'
            : '<span class="badge badge-sell">SELL</span>';

        // Strategy badge
        const strategy = (trade.strategy || '').toLowerCase();
        const strategyBadge = `<span class="badge badge-${strategy}">${strategy.toUpperCase()}</span>`;

        // Mode badge
        const modeBadge = trade.mode === 'DRY_RUN'
            ? '<span class="badge badge-dry">DRY_RUN</span>'
            : '<span class="badge badge-live">LIVE</span>';

        // Price formatting
        const price = trade.price || trade.entry_price || 0;
        const priceFormatted = price < 0.01 ? price.toFixed(8) : price.toFixed(4);

        // Amount
        const amount = trade.amount_sol ? `${trade.amount_sol.toFixed(4)} SOL` : '-';

        // P&L
        let pnl = '-';
        if (trade.type === 'CLOSE' && trade.pnl_sol !== undefined) {
            const pnlClass = trade.pnl_sol >= 0 ? 'positive' : 'negative';
            pnl = `<span class="${pnlClass}">${trade.pnl_sol >= 0 ? '+' : ''}${trade.pnl_sol.toFixed(4)} SOL</span>`;
        }

        row.innerHTML = `
            <td>${time}</td>
            <td>${typeBadge}</td>
            <td><strong>${trade.token}</strong></td>
            <td>${strategyBadge}</td>
            <td>${sideBadge}</td>
            <td>$${priceFormatted}</td>
            <td>${amount}</td>
            <td>${pnl}</td>
            <td>${modeBadge}</td>
        `;

        tbody.appendChild(row);
    });
}

// Load trades on page load
document.addEventListener('DOMContentLoaded', loadTrades);

// Auto-refresh every 30 seconds
setInterval(loadTrades, 30000);
</script>
{% endblock %}
