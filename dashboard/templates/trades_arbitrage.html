{% extends "base.html" %}

{% block title %}Arbitrage Trades{% endblock %}

{% block extra_head %}
<style>
    .page-container { padding: 20px; }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filters-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 20px;
    }

    .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
    }

    .filter-select {
        background: var(--metric-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 12px;
        color: var(--text-primary);
        font-size: 0.875rem;
        min-width: 140px;
    }

    .filter-btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        background: #6b7280;
        color: white;
    }

    .filter-btn:hover { background: #4b5563; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .positive { color: #10b981; }
    .negative { color: #ef4444; }

    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
    }

    .trades-table th {
        background: var(--metric-bg);
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        white-space: nowrap;
        cursor: pointer;
    }

    .trades-table th:hover { background: var(--border-color); }

    .trades-table td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    .trades-table tr:hover { background: var(--metric-bg); }

    .dex-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .spread-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .simulated-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }

    .btn-primary { background: #8b5cf6; color: white; }
    .btn-primary:hover { background: #7c3aed; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .pagination-btn {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 0.875rem;
    }

    .pagination-btn:hover { background: var(--metric-bg); }
    .pagination-btn.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .pagination-info {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --metric-bg: #111827;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-exchange-alt"></i>
                Arbitrage Trades
            </h1>
            <p class="page-subtitle">Complete arbitrage trade history</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadTrades()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <button class="btn btn-primary" onclick="exportCSV()">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Timeframe</label>
                <select id="filter-timeframe" class="filter-select" onchange="applyFilters()">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Route</label>
                <select id="filter-route" class="filter-select" onchange="applyFilters()">
                    <option value="all">All Routes</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Result</label>
                <select id="filter-result" class="filter-select" onchange="applyFilters()">
                    <option value="all">All Results</option>
                    <option value="profit">Profitable</option>
                    <option value="loss">Loss</option>
                </select>
            </div>

            <button class="filter-btn" onclick="resetFilters()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Winning</div>
            <div class="stat-value positive" id="stat-winning">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="stat-winrate">0%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="stat-pnl">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Spread</div>
            <div class="stat-value" id="stat-spread">0.00%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Volume</div>
            <div class="stat-value" id="stat-volume">0.00 ETH</div>
        </div>
    </div>

    <!-- Trade Table -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-history"></i>
            Trade History (<span id="trade-count">0</span>)
        </div>
        <div id="trades-empty" class="empty-state">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 16px; display: block;"></i>
            <p>No arbitrage trades found.</p>
        </div>
        <div class="table-responsive">
            <table class="trades-table" id="trades-table" style="display: none;">
                <thead>
                    <tr>
                        <th onclick="sortTable('time')">Time ↕</th>
                        <th onclick="sortTable('token')">Token ↕</th>
                        <th onclick="sortTable('route')">Route ↕</th>
                        <th onclick="sortTable('amount')">Amount ↕</th>
                        <th onclick="sortTable('spread')">Spread ↕</th>
                        <th onclick="sortTable('pnl')">Profit ↕</th>
                        <th onclick="sortTable('eth_price')">ETH Price ↕</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody"></tbody>
            </table>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<script>
// Token address to symbol mapping
const TOKEN_SYMBOLS = {
    '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2': 'WETH',
    '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599': 'WBTC',
    '0x514910771AF9Ca656af840dff83E8264EcF986CA': 'LINK',
    '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984': 'UNI',
    '0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9': 'AAVE',
    '0x7D1AfA7B718fb893dB30A3aBc0Cfc608AaCfeBB0': 'MATIC',
    '0xD533a949740bb3306d119CC777fa900bA034cd52': 'CRV',
    '0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32': 'LDO',
    '0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2': 'MKR',
    '0xC011a73ee8576Fb46F5E1c5751cA3B9Fe0af2a6F': 'SNX',
    '0xc00e94Cb662C3520282E6f5717214004A7f26888': 'COMP',
    '0xba100000625a3754423978a60c9317c58a424e3D': 'BAL',
    '0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e': 'YFI',
    '0xc944E90C64B2c07662A292be6244BDf05Cda44a7': 'GRT',
    '0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72': 'ENS',
    '0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE': 'SHIB',
    '0x6982508145454Ce325dDbE47a25d4ec3d2311933': 'PEPE',
    '0x6B3595068778DD592e39A122f4f5a5cF09C90fE2': 'SUSHI',
    '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48': 'USDC',
    '0xdAC17F958D2ee523a2206206994597C13D831ec7': 'USDT'
};

function getTokenSymbol(address) {
    if (!address) return 'UNKNOWN';
    const upper = address.toUpperCase();
    for (const [addr, symbol] of Object.entries(TOKEN_SYMBOLS)) {
        if (addr.toUpperCase() === upper) return symbol;
    }
    return address.length > 10 ? `${address.slice(0, 6)}...${address.slice(-4)}` : address;
}

let allTrades = [];
let filteredTrades = [];
let currentSort = { column: 'time', direction: 'desc' };
let currentPage = 1;
const pageSize = 50;

async function loadTrades() {
    try {
        const response = await fetch('/api/arbitrage/trades?limit=2000');
        const data = await response.json();

        if (data.success && data.trades) {
            allTrades = data.trades;
            extractRoutes();
            applyFilters();
        }
    } catch (error) {
        console.error('Error loading trades:', error);
    }
}

function extractRoutes() {
    const routes = new Set();
    allTrades.forEach(t => {
        if (t.buy_dex && t.sell_dex) {
            routes.add(`${t.buy_dex} → ${t.sell_dex}`);
        }
    });

    const select = document.getElementById('filter-route');
    select.innerHTML = '<option value="all">All Routes</option>';
    Array.from(routes).sort().forEach(route => {
        const option = document.createElement('option');
        option.value = route;
        option.textContent = route;
        select.appendChild(option);
    });
}

function applyFilters() {
    const timeframe = document.getElementById('filter-timeframe').value;
    const route = document.getElementById('filter-route').value;
    const result = document.getElementById('filter-result').value;

    let startDate = null;
    const now = new Date();

    if (timeframe === 'today') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (timeframe === '7d') {
        startDate = new Date(now - 7 * 24 * 60 * 60 * 1000);
    } else if (timeframe === '30d') {
        startDate = new Date(now - 30 * 24 * 60 * 60 * 1000);
    }

    filteredTrades = allTrades.filter(trade => {
        if (startDate) {
            const tradeDate = new Date(trade.timestamp || trade.entry_timestamp);
            if (tradeDate < startDate) return false;
        }

        if (route !== 'all') {
            const tradeRoute = `${trade.buy_dex} → ${trade.sell_dex}`;
            if (tradeRoute !== route) return false;
        }

        const pnl = parseFloat(trade.profit_loss || 0);
        if (result === 'profit' && pnl <= 0) return false;
        if (result === 'loss' && pnl > 0) return false;

        return true;
    });

    currentPage = 1;
    sortTrades();
    updateStats();
    updateDisplay();
}

function resetFilters() {
    document.getElementById('filter-timeframe').value = 'all';
    document.getElementById('filter-route').value = 'all';
    document.getElementById('filter-result').value = 'all';
    applyFilters();
}

function sortTable(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
    }
    sortTrades();
    updateDisplay();
}

function sortTrades() {
    const col = currentSort.column;
    const dir = currentSort.direction === 'asc' ? 1 : -1;

    filteredTrades.sort((a, b) => {
        let aVal, bVal;

        switch (col) {
            case 'time':
                aVal = new Date(a.timestamp || a.entry_timestamp).getTime();
                bVal = new Date(b.timestamp || b.entry_timestamp).getTime();
                break;
            case 'token':
                aVal = a.token_address || '';
                bVal = b.token_address || '';
                return dir * aVal.localeCompare(bVal);
            case 'route':
                aVal = `${a.buy_dex}-${a.sell_dex}`;
                bVal = `${b.buy_dex}-${b.sell_dex}`;
                return dir * aVal.localeCompare(bVal);
            case 'amount':
                aVal = parseFloat(a.amount_eth || 0);
                bVal = parseFloat(b.amount_eth || 0);
                break;
            case 'spread':
                aVal = parseFloat(a.spread_pct || 0);
                bVal = parseFloat(b.spread_pct || 0);
                break;
            case 'pnl':
                aVal = parseFloat(a.profit_loss || 0);
                bVal = parseFloat(b.profit_loss || 0);
                break;
            case 'eth_price':
                aVal = parseFloat(a.eth_price || 0);
                bVal = parseFloat(b.eth_price || 0);
                break;
            default:
                return 0;
        }

        return dir * (aVal - bVal);
    });
}

function updateStats() {
    const total = filteredTrades.length;
    const wins = filteredTrades.filter(t => parseFloat(t.profit_loss || 0) > 0).length;
    const totalPnl = filteredTrades.reduce((sum, t) => sum + parseFloat(t.profit_loss || 0), 0);
    const avgSpread = total > 0 ? filteredTrades.reduce((sum, t) => sum + parseFloat(t.spread_pct || 0), 0) / total : 0;
    const totalVolume = filteredTrades.reduce((sum, t) => sum + parseFloat(t.amount_eth || 0), 0);
    const winRate = total > 0 ? (wins / total * 100) : 0;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-winning').textContent = wins;
    document.getElementById('stat-winrate').textContent = winRate.toFixed(1) + '%';

    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = `$${totalPnl.toFixed(2)}`;
    pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

    document.getElementById('stat-spread').textContent = avgSpread.toFixed(2) + '%';
    document.getElementById('stat-volume').textContent = totalVolume.toFixed(4) + ' ETH';
}

function updateDisplay() {
    const tbody = document.getElementById('tradesTableBody');
    const emptyState = document.getElementById('trades-empty');
    const table = document.getElementById('trades-table');
    const countEl = document.getElementById('trade-count');

    countEl.textContent = filteredTrades.length;

    if (filteredTrades.length === 0) {
        emptyState.style.display = 'block';
        table.style.display = 'none';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    emptyState.style.display = 'none';
    table.style.display = 'table';

    const totalPages = Math.ceil(filteredTrades.length / pageSize);
    const start = (currentPage - 1) * pageSize;
    const displayed = filteredTrades.slice(start, start + pageSize);

    tbody.innerHTML = displayed.map(trade => {
        const timestamp = trade.timestamp || trade.entry_timestamp;
        const timeStr = timestamp ? new Date(timestamp).toLocaleString() : 'N/A';
        const pnl = parseFloat(trade.profit_loss || 0);
        const spread = parseFloat(trade.spread_pct || 0);
        const amount = parseFloat(trade.amount_eth || trade.amount || 0);
        const ethPrice = parseFloat(trade.eth_price || 0);
        const isDryRun = trade.dry_run || trade.is_simulated;

        const token = trade.token_address || '';
        const tokenSymbol = getTokenSymbol(token);
        const shortToken = token.length > 10 ? `${token.slice(0, 6)}...${token.slice(-4)}` : token;

        return `
            <tr>
                <td>${timeStr}</td>
                <td title="${token}">
                    <div style="font-weight: 600;">${tokenSymbol}</div>
                    <div style="font-size: 0.7rem; color: var(--text-tertiary); font-family: monospace;">${shortToken}</div>
                </td>
                <td>
                    <span class="dex-badge">${trade.buy_dex || 'DEX'}</span>
                    →
                    <span class="dex-badge">${trade.sell_dex || 'DEX'}</span>
                </td>
                <td>${amount.toFixed(4)} ETH</td>
                <td><span class="spread-badge">${spread.toFixed(2)}%</span></td>
                <td class="${pnl >= 0 ? 'positive' : 'negative'}"><strong>$${pnl.toFixed(2)}</strong></td>
                <td>$${ethPrice.toFixed(2)}</td>
                <td>${isDryRun ? '<span class="simulated-badge">SIMULATED</span>' : '<span class="dex-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">LIVE</span>'}</td>
            </tr>
        `;
    }).join('');

    updatePagination(totalPages);
}

function updatePagination(totalPages) {
    const container = document.getElementById('pagination');
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }

    let html = `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>←</button>`;

    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }

    html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>→</button>`;
    html += `<span class="pagination-info">Page ${currentPage} of ${totalPages}</span>`;

    container.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredTrades.length / pageSize);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    updateDisplay();
}

function exportCSV() {
    if (filteredTrades.length === 0) {
        alert('No trades to export');
        return;
    }

    const headers = ['Time', 'Token', 'Buy DEX', 'Sell DEX', 'Amount (ETH)', 'Spread %', 'Profit', 'ETH Price', 'Simulated'];
    const rows = filteredTrades.map(t => [
        t.timestamp || t.entry_timestamp || '',
        t.token_address,
        t.buy_dex,
        t.sell_dex,
        parseFloat(t.amount_eth || 0).toFixed(4),
        parseFloat(t.spread_pct || 0).toFixed(2),
        parseFloat(t.profit_loss || 0).toFixed(2),
        parseFloat(t.eth_price || 0).toFixed(2),
        t.is_simulated ? 'Yes' : 'No'
    ]);

    let csv = headers.join(',') + '\n';
    rows.forEach(row => csv += row.map(c => `"${c}"`).join(',') + '\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `arbitrage_trades_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

loadTrades();
setInterval(loadTrades, 60000);
</script>
{% endblock %}
