{% extends "base.html" %}

{% block title %}Futures Trading Settings{% endblock %}

{% block extra_head %}
<style>
    .settings-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
    }

    .settings-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .settings-title i {
        color: #8b5cf6;
    }

    .settings-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .setting-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .setting-item {
        background: var(--bg-tertiary);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .setting-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .setting-description {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 12px;
    }

    .setting-input {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .setting-input:focus {
        outline: none;
        border-color: #8b5cf6;
    }

    .setting-input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
    }

    .setting-select {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.875rem;
        cursor: pointer;
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toggle-switch input[type="checkbox"] {
        width: 48px;
        height: 24px;
        appearance: none;
        background: var(--bg-tertiary);
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle-switch input[type="checkbox"]:checked {
        background: #8b5cf6;
    }

    .toggle-switch input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
    }

    .toggle-switch input[type="checkbox"]:checked::before {
        left: 26px;
    }

    .btn-save {
        background: #8b5cf6;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-save:hover {
        background: #7c3aed;
        transform: translateY(-2px);
    }

    .btn-reset {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        padding: 12px 24px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-reset:hover {
        background: var(--bg-hover);
    }

    .warning-box {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 8px;
        padding: 16px;
        color: #f59e0b;
        font-size: 0.875rem;
        display: flex;
        align-items: start;
        gap: 12px;
        margin-bottom: 20px;
    }

    .info-box {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 16px;
        color: #3b82f6;
        font-size: 0.875rem;
        display: flex;
        align-items: start;
        gap: 12px;
        margin-bottom: 20px;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-enabled {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-disabled {
        background: rgba(107, 114, 128, 0.2);
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header -->
    <div class="settings-header">
        <div class="settings-title">
            <i class="fas fa-chart-line"></i>
            Futures Trading Settings
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn-reset" onclick="resetSettings()">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
            <button class="btn-save" onclick="saveSettings()">
                <i class="fas fa-save"></i> Save All Changes
            </button>
        </div>
    </div>

    <!-- Module Status -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-power-off"></i>
                Module Status
            </div>
            <span class="status-badge status-disabled" id="moduleStatus">DISABLED</span>
        </div>

        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Risk Warning:</strong> Futures trading involves significant risk of loss.
                Leverage can magnify both gains and losses. Only trade with capital you can afford to lose.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Enable Futures Module
                </label>
                <div class="setting-description">Enable or disable the entire futures trading module</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_enabled" name="futures_enabled">
                    <span id="enabledLabel">Disabled</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Exchange Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-building"></i>
                Exchange Configuration
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div>
                API keys are stored securely in the sensitive configuration section of the main settings page.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Exchange</label>
                <div class="setting-description">Select your preferred futures exchange</div>
                <select class="setting-select" id="futures_exchange" name="futures_exchange">
                    <option value="binance">Binance Futures</option>
                    <option value="bybit">Bybit</option>
                    <option value="okx">OKX</option>
                    <option value="bitget">Bitget</option>
                </select>
            </div>

            <div class="setting-item">
                <label class="setting-label">Trading Mode</label>
                <div class="setting-description">Select paper trading for testing without real funds</div>
                <select class="setting-select" id="futures_trading_mode" name="futures_trading_mode">
                    <option value="paper">Paper Trading (Testnet)</option>
                    <option value="live">Live Trading</option>
                </select>
            </div>

            <div class="setting-item">
                <label class="setting-label">Contract Type</label>
                <div class="setting-description">Type of futures contracts to trade</div>
                <select class="setting-select" id="futures_contract_type" name="futures_contract_type">
                    <option value="perpetual">Perpetual (USDT-M)</option>
                    <option value="coin_margined">Coin Margined (COIN-M)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Capital & Position Sizing -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-dollar-sign"></i>
                Capital & Position Sizing
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Capital Allocation (USDT)</label>
                <div class="setting-description">Total capital allocated to futures trading</div>
                <input type="number" class="setting-input" id="futures_capital" name="futures_capital" value="300" min="10" step="10">
            </div>

            <div class="setting-item">
                <label class="setting-label">Max Position Size (%)</label>
                <div class="setting-description">Maximum percentage of capital per trade</div>
                <input type="number" class="setting-input" id="futures_max_position_pct" name="futures_max_position_pct" value="10" min="1" max="100" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Max Concurrent Positions</label>
                <div class="setting-description">Maximum number of open positions at once</div>
                <input type="number" class="setting-input" id="futures_max_positions" name="futures_max_positions" value="3" min="1" max="20">
            </div>

            <div class="setting-item">
                <label class="setting-label">Minimum Trade Size (USDT)</label>
                <div class="setting-description">Minimum size for any futures trade</div>
                <input type="number" class="setting-input" id="futures_min_trade_size" name="futures_min_trade_size" value="10" min="1" step="1">
            </div>
        </div>
    </div>

    <!-- Leverage & Margin Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-balance-scale"></i>
                Leverage & Margin
            </div>
        </div>

        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                Higher leverage increases risk of liquidation. Start with lower leverage until you understand the risks.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Default Leverage</label>
                <div class="setting-description">Default leverage for new positions</div>
                <input type="number" class="setting-input" id="futures_leverage" name="futures_leverage" value="5" min="1" max="125" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Maximum Leverage</label>
                <div class="setting-description">Maximum allowed leverage</div>
                <input type="number" class="setting-input" id="futures_max_leverage" name="futures_max_leverage" value="10" min="1" max="125" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Margin Mode</label>
                <div class="setting-description">Isolated protects other positions, Cross uses full balance</div>
                <select class="setting-select" id="futures_margin_mode" name="futures_margin_mode">
                    <option value="isolated">Isolated Margin</option>
                    <option value="cross">Cross Margin</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Risk Management -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-shield-alt"></i>
                Risk Management
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Stop Loss (%)</label>
                <div class="setting-description">Default stop loss percentage</div>
                <input type="number" class="setting-input" id="futures_stop_loss" name="futures_stop_loss" value="2" min="0.1" max="50" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Take Profit (%)</label>
                <div class="setting-description">Default take profit percentage</div>
                <input type="number" class="setting-input" id="futures_take_profit" name="futures_take_profit" value="4" min="0.1" max="100" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Daily Loss Limit (%)</label>
                <div class="setting-description">Stop trading if daily loss exceeds this percentage</div>
                <input type="number" class="setting-input" id="futures_daily_loss_limit" name="futures_daily_loss_limit" value="5" min="1" max="50" step="0.5">
            </div>

            <div class="setting-item">
                <label class="setting-label">Liquidation Buffer (%)</label>
                <div class="setting-description">Close position before liquidation when margin drops to this level</div>
                <input type="number" class="setting-input" id="futures_liquidation_buffer" name="futures_liquidation_buffer" value="20" min="5" max="50" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Enable Trailing Stop
                </label>
                <div class="setting-description">Use trailing stops to lock in profits</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_trailing_stop" name="futures_trailing_stop" checked>
                    <span>Enabled</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Trailing Stop Distance (%)</label>
                <div class="setting-description">Distance for trailing stop from current price</div>
                <input type="number" class="setting-input" id="futures_trailing_distance" name="futures_trailing_distance" value="1.5" min="0.1" max="20" step="0.1">
            </div>
        </div>
    </div>

    <!-- Trading Pairs -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-coins"></i>
                Trading Pairs
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item" style="grid-column: span 2;">
                <label class="setting-label">Allowed Trading Pairs</label>
                <div class="setting-description">Comma-separated list of allowed perpetual pairs (e.g., BTCUSDT, ETHUSDT)</div>
                <input type="text" class="setting-input" id="futures_allowed_pairs" name="futures_allowed_pairs" value="BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT" placeholder="BTCUSDT,ETHUSDT,BNBUSDT">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Trade Both Directions
                </label>
                <div class="setting-description">Allow both long and short positions</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_both_directions" name="futures_both_directions" checked>
                    <span>Enabled</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Preferred Direction</label>
                <div class="setting-description">Default trading direction when both are disabled</div>
                <select class="setting-select" id="futures_preferred_direction" name="futures_preferred_direction">
                    <option value="long">Long Only</option>
                    <option value="short">Short Only</option>
                    <option value="both">Both Directions</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Funding Rate Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-percentage"></i>
                Funding Rate Settings
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Funding Rate Arbitrage
                </label>
                <div class="setting-description">Enable trading based on funding rate opportunities</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_funding_arb" name="futures_funding_arb">
                    <span>Disabled</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Max Funding Rate (%)</label>
                <div class="setting-description">Maximum funding rate before closing positions</div>
                <input type="number" class="setting-input" id="futures_max_funding_rate" name="futures_max_funding_rate" value="0.1" min="0.01" max="1" step="0.01">
            </div>
        </div>
    </div>
</div>

<script>
// Load current settings
async function loadSettings() {
    try {
        const response = await fetch('/api/settings/futures');
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.settings) {
                populateSettings(data.settings);
            }
        }
    } catch (e) {
        console.error('Failed to load settings:', e);
    }
}

function populateSettings(settings) {
    for (const [key, value] of Object.entries(settings)) {
        const element = document.getElementById(key);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }
    }
    updateModuleStatus();
}

function updateModuleStatus() {
    const enabled = document.getElementById('futures_enabled').checked;
    const statusBadge = document.getElementById('moduleStatus');
    const enabledLabel = document.getElementById('enabledLabel');

    if (enabled) {
        statusBadge.className = 'status-badge status-enabled';
        statusBadge.textContent = 'ENABLED';
        enabledLabel.textContent = 'Enabled';
    } else {
        statusBadge.className = 'status-badge status-disabled';
        statusBadge.textContent = 'DISABLED';
        enabledLabel.textContent = 'Disabled';
    }
}

async function saveSettings() {
    const settings = {};
    const inputs = document.querySelectorAll('.setting-input, .setting-select, input[type="checkbox"]');

    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            settings[input.id] = input.checked;
        } else if (input.type === 'number') {
            settings[input.id] = parseFloat(input.value);
        } else {
            settings[input.id] = input.value;
        }
    });

    try {
        const response = await fetch('/api/settings/futures', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });

        if (response.ok) {
            showToast('Settings saved successfully!', 'success');
            updateModuleStatus();
        } else {
            const error = await response.json();
            showToast('Failed to save settings: ' + (error.error || 'Unknown error'), 'error');
        }
    } catch (e) {
        showToast('Error saving settings: ' + e.message, 'error');
    }
}

function resetSettings() {
    if (confirm('Reset all futures settings to defaults?')) {
        // Set default values
        document.getElementById('futures_enabled').checked = false;
        document.getElementById('futures_exchange').value = 'binance';
        document.getElementById('futures_trading_mode').value = 'paper';
        document.getElementById('futures_contract_type').value = 'perpetual';
        document.getElementById('futures_capital').value = 300;
        document.getElementById('futures_max_position_pct').value = 10;
        document.getElementById('futures_max_positions').value = 3;
        document.getElementById('futures_min_trade_size').value = 10;
        document.getElementById('futures_leverage').value = 5;
        document.getElementById('futures_max_leverage').value = 10;
        document.getElementById('futures_margin_mode').value = 'isolated';
        document.getElementById('futures_stop_loss').value = 2;
        document.getElementById('futures_take_profit').value = 4;
        document.getElementById('futures_daily_loss_limit').value = 5;
        document.getElementById('futures_liquidation_buffer').value = 20;
        document.getElementById('futures_trailing_stop').checked = true;
        document.getElementById('futures_trailing_distance').value = 1.5;
        document.getElementById('futures_allowed_pairs').value = 'BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT';
        document.getElementById('futures_both_directions').checked = true;
        document.getElementById('futures_preferred_direction').value = 'both';
        document.getElementById('futures_funding_arb').checked = false;
        document.getElementById('futures_max_funding_rate').value = 0.1;

        updateModuleStatus();
        showToast('Settings reset to defaults', 'info');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Event listeners
document.getElementById('futures_enabled').addEventListener('change', updateModuleStatus);

// Load settings on page load
document.addEventListener('DOMContentLoaded', loadSettings);
</script>
{% endblock %}
