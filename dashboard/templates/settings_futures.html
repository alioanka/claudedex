{% extends "base.html" %}

{% block title %}Futures Trading Settings{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #2d3548;
    }

    .settings-title {
        font-size: 2rem;
        font-weight: 700;
        color: #e8eaed;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .settings-title i {
        color: #8b5cf6;
    }

    /* Dark Blue Section Cards */
    .settings-section {
        background: #1a1f2e;
        border: 1px solid #2d3548;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #2d3548;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #e8eaed;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        color: #8b5cf6;
    }

    .setting-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    /* Setting Items - Darker Blue */
    .setting-item {
        background: #242b3d;
        padding: 18px;
        border-radius: 10px;
        border: 1px solid #2d3548;
    }

    .setting-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #e8eaed;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .setting-description {
        font-size: 0.8rem;
        color: #9aa0a6;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .setting-input {
        width: 100%;
        padding: 12px 14px;
        background: #1a1f2e;
        border: 1px solid #2d3548;
        border-radius: 8px;
        color: #e8eaed;
        font-size: 0.9rem;
    }

    .setting-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    .setting-input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
    }

    .setting-select {
        width: 100%;
        padding: 12px 14px;
        background: #1a1f2e;
        border: 1px solid #2d3548;
        border-radius: 8px;
        color: #e8eaed;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .setting-select:focus {
        outline: none;
        border-color: #8b5cf6;
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #9aa0a6;
    }

    .toggle-switch input[type="checkbox"] {
        width: 48px;
        height: 24px;
        appearance: none;
        background: #2d3548;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle-switch input[type="checkbox"]:checked {
        background: #8b5cf6;
    }

    .toggle-switch input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
    }

    .toggle-switch input[type="checkbox"]:checked::before {
        left: 26px;
    }

    /* Buttons - Gradient Styling */
    .btn-save {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: #ffffff;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-save:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .btn-reset {
        background: #242b3d;
        color: #e8eaed;
        padding: 12px 24px;
        border: 1px solid #2d3548;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-reset:hover {
        background: #2d3548;
        border-color: #3d4a5c;
    }

    .warning-box {
        background: rgba(245, 158, 11, 0.15);
        border: 1px solid rgba(245, 158, 11, 0.4);
        border-radius: 10px;
        padding: 16px;
        color: #f59e0b;
        font-size: 0.875rem;
        display: flex;
        align-items: start;
        gap: 12px;
        margin-bottom: 20px;
    }

    .info-box {
        background: rgba(139, 92, 246, 0.15);
        border: 1px solid rgba(139, 92, 246, 0.4);
        border-radius: 10px;
        padding: 16px;
        color: #a78bfa;
        font-size: 0.875rem;
        display: flex;
        align-items: start;
        gap: 12px;
        margin-bottom: 20px;
    }

    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-enabled {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-disabled {
        background: rgba(107, 114, 128, 0.2);
        color: #9aa0a6;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .settings-header {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .setting-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header -->
    <div class="settings-header">
        <div class="settings-title">
            <i class="fas fa-chart-line"></i>
            Futures Trading Settings
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn-reset" onclick="resetSettings()">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
            <button class="btn-save" onclick="saveSettings()">
                <i class="fas fa-save"></i> Save All Changes
            </button>
        </div>
    </div>

    <!-- Module Status -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-power-off"></i>
                Module Status
            </div>
            <span class="status-badge status-disabled" id="moduleStatus">CHECKING...</span>
        </div>

        <div class="info-box" id="runningInfo" style="display: none; background: #d1fae5; border-color: #10b981;">
            <i class="fas fa-check-circle" style="color: #10b981;"></i>
            <div id="runningInfoText">
                <strong>Module Running:</strong> The Futures module is currently active.
            </div>
        </div>

        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Risk Warning:</strong> Futures trading involves significant risk of loss.
                Leverage can magnify both gains and losses. Only trade with capital you can afford to lose.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Enable Futures Module (requires .env update)
                </label>
                <div class="setting-description">Module enable/disable is controlled by FUTURES_MODULE_ENABLED in .env file</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_enabled" name="futures_enabled" disabled>
                    <span id="enabledLabel">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Exchange Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-building"></i>
                Exchange Configuration
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div>
                API keys are stored securely in the sensitive configuration section of the main settings page.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Exchange</label>
                <div class="setting-description">Select your preferred futures exchange</div>
                <select class="setting-select" id="futures_exchange" name="futures_exchange">
                    <option value="binance">Binance Futures</option>
                    <option value="bybit">Bybit</option>
                    <option value="okx">OKX</option>
                    <option value="bitget">Bitget</option>
                </select>
            </div>

            <div class="setting-item">
                <label class="setting-label">Trading Mode</label>
                <div class="setting-description">Select paper trading for testing without real funds</div>
                <select class="setting-select" id="futures_trading_mode" name="futures_trading_mode">
                    <option value="paper">Paper Trading (Testnet)</option>
                    <option value="live">Live Trading</option>
                </select>
            </div>

            <div class="setting-item">
                <label class="setting-label">Contract Type</label>
                <div class="setting-description">Type of futures contracts to trade</div>
                <select class="setting-select" id="futures_contract_type" name="futures_contract_type">
                    <option value="perpetual">Perpetual (USDT-M)</option>
                    <option value="coin_margined">Coin Margined (COIN-M)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Capital & Position Sizing -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-dollar-sign"></i>
                Capital & Position Sizing
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Position Sizing Formula:</strong> Capital × Position% = Margin, then Margin × Leverage = Notional Position.
                Example: $300 × 15% = $45 margin × 10x = $450 notional position.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Capital Allocation (USDT)</label>
                <div class="setting-description">Total capital allocated to futures trading</div>
                <input type="number" class="setting-input" id="futures_capital" name="futures_capital" value="300" min="10" step="10">
            </div>

            <div class="setting-item">
                <label class="setting-label">Max Concurrent Positions</label>
                <div class="setting-description">Maximum number of open positions at once</div>
                <input type="number" class="setting-input" id="futures_max_positions" name="futures_max_positions" value="3" min="1" max="20">
            </div>

            <div class="setting-item">
                <label class="setting-label">Minimum Trade Size (USDT)</label>
                <div class="setting-description">Minimum notional size for any futures trade</div>
                <input type="number" class="setting-input" id="futures_min_trade_size" name="futures_min_trade_size" value="10" min="1" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Max Position Size (USDT)</label>
                <div class="setting-description">Maximum notional size cap regardless of percentage</div>
                <input type="number" class="setting-input" id="futures_max_position_usd" name="futures_max_position_usd" value="500" min="10" step="10">
            </div>
        </div>

        <!-- Dynamic Position Sizing Sub-section -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #2d3548;">
            <h4 style="color: #a78bfa; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-sliders-h"></i>
                Dynamic Position Sizing
            </h4>
            <div class="setting-grid">
                <div class="setting-item">
                    <label class="setting-label">
                        <i class="fas fa-toggle-on"></i>
                        Enable Dynamic Sizing
                    </label>
                    <div class="setting-description">Adjust position size based on signal strength (stronger signals = larger positions)</div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="futures_dynamic_position_sizing" name="futures_dynamic_position_sizing" checked>
                        <span>Enabled</span>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Static Position Size (%)</label>
                    <div class="setting-description">Fixed % of capital when dynamic sizing is disabled</div>
                    <input type="number" class="setting-input" id="futures_static_position_pct" name="futures_static_position_pct" value="15" min="1" max="50" step="1">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Min Position Size (%)</label>
                    <div class="setting-description">Minimum % of capital for weak signals</div>
                    <input type="number" class="setting-input" id="futures_min_position_pct" name="futures_min_position_pct" value="5" min="1" max="50" step="1">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Max Position Size (%)</label>
                    <div class="setting-description">Maximum % of capital for strong signals</div>
                    <input type="number" class="setting-input" id="futures_max_position_pct" name="futures_max_position_pct" value="20" min="1" max="100" step="1">
                </div>
            </div>
        </div>
    </div>

    <!-- Leverage & Margin Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-balance-scale"></i>
                Leverage & Margin
            </div>
        </div>

        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                Higher leverage increases risk of liquidation. Start with lower leverage until you understand the risks.
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Default Leverage</label>
                <div class="setting-description">Default leverage for new positions</div>
                <input type="number" class="setting-input" id="futures_leverage" name="futures_leverage" value="5" min="1" max="125" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Maximum Leverage</label>
                <div class="setting-description">Maximum allowed leverage</div>
                <input type="number" class="setting-input" id="futures_max_leverage" name="futures_max_leverage" value="10" min="1" max="125" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Margin Mode</label>
                <div class="setting-description">Isolated protects other positions, Cross uses full balance</div>
                <select class="setting-select" id="futures_margin_mode" name="futures_margin_mode">
                    <option value="isolated">Isolated Margin</option>
                    <option value="cross">Cross Margin</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Risk Management -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-shield-alt"></i>
                Risk Management
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">Stop Loss (%)</label>
                <div class="setting-description">Default stop loss percentage</div>
                <input type="number" class="setting-input" id="futures_stop_loss" name="futures_stop_loss" value="2" min="0.1" max="50" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Take Profit (%)</label>
                <div class="setting-description">Default take profit percentage</div>
                <input type="number" class="setting-input" id="futures_take_profit" name="futures_take_profit" value="4" min="0.1" max="100" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label">Daily Loss Limit (%)</label>
                <div class="setting-description">Stop trading if daily loss exceeds this percentage</div>
                <input type="number" class="setting-input" id="futures_daily_loss_limit" name="futures_daily_loss_limit" value="5" min="1" max="50" step="0.5">
            </div>

            <div class="setting-item">
                <label class="setting-label">Liquidation Buffer (%)</label>
                <div class="setting-description">Close position before liquidation when margin drops to this level</div>
                <input type="number" class="setting-input" id="futures_liquidation_buffer" name="futures_liquidation_buffer" value="20" min="5" max="50" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Enable Trailing Stop
                </label>
                <div class="setting-description">Use trailing stops to lock in profits</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_trailing_stop" name="futures_trailing_stop" checked>
                    <span>Enabled</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Trailing Stop Distance (%)</label>
                <div class="setting-description">Distance for trailing stop from current price</div>
                <input type="number" class="setting-input" id="futures_trailing_distance" name="futures_trailing_distance" value="1.5" min="0.1" max="20" step="0.1">
            </div>
        </div>
    </div>

    <!-- Multiple Take Profits -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-layer-group"></i>
                Multiple Take Profits
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Partial Position Closes:</strong> Configure up to 4 take profit levels. Each TP closes a percentage of the position.
                Set Size% to 0 to disable a TP level. Example: TP1=25% at 2%, TP2=25% at 4%, TP3=25% at 6%, TP4=25% at 10%.
            </div>
        </div>

        <div class="setting-grid">
            <!-- TP1 -->
            <div class="setting-item">
                <label class="setting-label" style="color: #10b981;">
                    <i class="fas fa-flag"></i>
                    TP1 Price (%)
                </label>
                <div class="setting-description">First take profit at this % price move</div>
                <input type="number" class="setting-input" id="futures_tp1_pct" name="futures_tp1_pct" value="2" min="0.1" max="50" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label" style="color: #10b981;">
                    <i class="fas fa-percentage"></i>
                    TP1 Size (%)
                </label>
                <div class="setting-description">Close this % of position at TP1</div>
                <input type="number" class="setting-input" id="futures_tp1_size_pct" name="futures_tp1_size_pct" value="25" min="0" max="100" step="5">
            </div>

            <!-- TP2 -->
            <div class="setting-item">
                <label class="setting-label" style="color: #3b82f6;">
                    <i class="fas fa-flag"></i>
                    TP2 Price (%)
                </label>
                <div class="setting-description">Second take profit at this % price move</div>
                <input type="number" class="setting-input" id="futures_tp2_pct" name="futures_tp2_pct" value="4" min="0.1" max="50" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label" style="color: #3b82f6;">
                    <i class="fas fa-percentage"></i>
                    TP2 Size (%)
                </label>
                <div class="setting-description">Close this % of position at TP2</div>
                <input type="number" class="setting-input" id="futures_tp2_size_pct" name="futures_tp2_size_pct" value="25" min="0" max="100" step="5">
            </div>

            <!-- TP3 -->
            <div class="setting-item">
                <label class="setting-label" style="color: #f59e0b;">
                    <i class="fas fa-flag"></i>
                    TP3 Price (%)
                </label>
                <div class="setting-description">Third take profit at this % price move</div>
                <input type="number" class="setting-input" id="futures_tp3_pct" name="futures_tp3_pct" value="6" min="0.1" max="50" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label" style="color: #f59e0b;">
                    <i class="fas fa-percentage"></i>
                    TP3 Size (%)
                </label>
                <div class="setting-description">Close this % of position at TP3</div>
                <input type="number" class="setting-input" id="futures_tp3_size_pct" name="futures_tp3_size_pct" value="25" min="0" max="100" step="5">
            </div>

            <!-- TP4 -->
            <div class="setting-item">
                <label class="setting-label" style="color: #ef4444;">
                    <i class="fas fa-flag"></i>
                    TP4 Price (%)
                </label>
                <div class="setting-description">Final take profit at this % price move</div>
                <input type="number" class="setting-input" id="futures_tp4_pct" name="futures_tp4_pct" value="10" min="0.1" max="100" step="0.1">
            </div>

            <div class="setting-item">
                <label class="setting-label" style="color: #ef4444;">
                    <i class="fas fa-percentage"></i>
                    TP4 Size (%)
                </label>
                <div class="setting-description">Close remaining % at TP4 (set to 0 to disable)</div>
                <input type="number" class="setting-input" id="futures_tp4_size_pct" name="futures_tp4_size_pct" value="25" min="0" max="100" step="5">
            </div>
        </div>

        <div class="warning-box" style="margin-top: 16px;">
            <i class="fas fa-calculator"></i>
            <div>
                <strong>Size Total:</strong> <span id="tp_size_total">100%</span> - All TP sizes should add up to 100% to close the full position.
                If total is less than 100%, remaining position stays open until SL or signal reversal.
            </div>
        </div>
    </div>

    <!-- Trading Pairs -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-coins"></i>
                Trading Pairs
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item" style="grid-column: span 2;">
                <label class="setting-label">Allowed Trading Pairs</label>
                <div class="setting-description">Comma-separated list of allowed perpetual pairs (e.g., BTCUSDT, ETHUSDT)</div>
                <input type="text" class="setting-input" id="futures_allowed_pairs" name="futures_allowed_pairs" value="BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT" placeholder="BTCUSDT,ETHUSDT,BNBUSDT">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Trade Both Directions
                </label>
                <div class="setting-description">Allow both long and short positions</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_both_directions" name="futures_both_directions" checked>
                    <span>Enabled</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Preferred Direction</label>
                <div class="setting-description">Default trading direction when both are disabled</div>
                <select class="setting-select" id="futures_preferred_direction" name="futures_preferred_direction">
                    <option value="long">Long Only</option>
                    <option value="short">Short Only</option>
                    <option value="both">Both Directions</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Strategy Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                Strategy Settings
            </div>
        </div>

        <div class="alert-warning" style="background: #433d1e; border: 1px solid #6b5e22; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <i class="fas fa-lightbulb" style="color: #f5c518;"></i>
            <span style="color: #e8eaed;">For paper trading, use a shorter timeframe (5m or 15m) and lower signal score (2-3) to collect more simulated trade data.</span>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-clock"></i>
                    Signal Timeframe
                </label>
                <div class="setting-description">Candle timeframe for technical analysis (shorter = more signals)</div>
                <select class="setting-select" id="futures_signal_timeframe" name="futures_signal_timeframe">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m" selected>15 Minutes (Recommended for Paper)</option>
                    <option value="30m">30 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                </select>
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-sync"></i>
                    Scan Interval (seconds)
                </label>
                <div class="setting-description">How often to scan for trading opportunities</div>
                <input type="number" class="setting-input" id="futures_scan_interval_seconds" name="futures_scan_interval_seconds" value="30" min="10" max="300" step="5">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-star"></i>
                    Min Signal Score
                </label>
                <div class="setting-description">Minimum combined score to trigger trade (1-6, lower = more trades)</div>
                <input type="number" class="setting-input" id="futures_min_signal_score" name="futures_min_signal_score" value="3" min="1" max="6" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-hourglass-half"></i>
                    Cooldown (minutes)
                </label>
                <div class="setting-description">Wait time after closing a position before opening a new one</div>
                <input type="number" class="setting-input" id="futures_cooldown_minutes" name="futures_cooldown_minutes" value="5" min="0" max="60" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">RSI Oversold (Strong Buy)</label>
                <div class="setting-description">RSI below this triggers STRONG_BUY signal</div>
                <input type="number" class="setting-input" id="futures_rsi_oversold" name="futures_rsi_oversold" value="30" min="10" max="50" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">RSI Overbought (Strong Sell)</label>
                <div class="setting-description">RSI above this triggers STRONG_SELL signal</div>
                <input type="number" class="setting-input" id="futures_rsi_overbought" name="futures_rsi_overbought" value="70" min="50" max="90" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">RSI Weak Oversold (Buy)</label>
                <div class="setting-description">RSI below this triggers BUY signal</div>
                <input type="number" class="setting-input" id="futures_rsi_weak_oversold" name="futures_rsi_weak_oversold" value="40" min="20" max="50" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">RSI Weak Overbought (Sell)</label>
                <div class="setting-description">RSI above this triggers SELL signal</div>
                <input type="number" class="setting-input" id="futures_rsi_weak_overbought" name="futures_rsi_weak_overbought" value="60" min="50" max="80" step="1">
            </div>

            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Verbose Signal Logging
                </label>
                <div class="setting-description">Log detailed signal analysis for each scan</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_verbose_signals" name="futures_verbose_signals" checked>
                    <span>Enabled</span>
                </div>
            </div>
        </div>

        <!-- NEW: Advanced Signal Filters -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #2d3548;">
            <h4 style="color: #a78bfa; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-filter"></i>
                Advanced Signal Filters (Profitability Improvements)
            </h4>
            <div class="info-box">
                <i class="fas fa-lightbulb"></i>
                <div>
                    <strong>Profitability Tip:</strong> These filters reduce trade frequency but improve win rate.
                    Enable both for higher quality signals. Disable for more trades during testing.
                </div>
            </div>
            <div class="setting-grid">
                <div class="setting-item">
                    <label class="setting-label">
                        <i class="fas fa-arrow-trend-up"></i>
                        Require Trend Confirmation
                    </label>
                    <div class="setting-description">Only take LONG in uptrend, SHORT in downtrend (recommended)</div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="futures_require_trend_confirmation" name="futures_require_trend_confirmation" checked>
                        <span>Enabled</span>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">
                        <i class="fas fa-align-center"></i>
                        Require Trend Alignment
                    </label>
                    <div class="setting-description">Signal direction must match overall trend direction</div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="futures_require_trend_alignment" name="futures_require_trend_alignment" checked>
                        <span>Enabled</span>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">
                        <i class="fas fa-chart-bar"></i>
                        Require Volume Confirmation
                    </label>
                    <div class="setting-description">Only trade when volume is above average</div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="futures_require_volume_confirmation" name="futures_require_volume_confirmation" checked>
                        <span>Enabled</span>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">
                        <i class="fas fa-chart-area"></i>
                        Min Volume Multiplier
                    </label>
                    <div class="setting-description">Required volume ratio vs average (e.g., 1.2 = 20% above avg)</div>
                    <input type="number" class="setting-input" id="futures_min_volume_multiplier" name="futures_min_volume_multiplier" value="1.2" min="0.5" max="5" step="0.1">
                </div>

                <div class="setting-item">
                    <label class="setting-label">
                        <i class="fas fa-ban"></i>
                        Max Consecutive Losses
                    </label>
                    <div class="setting-description">Pause trading after this many consecutive losses</div>
                    <input type="number" class="setting-input" id="futures_max_consecutive_losses" name="futures_max_consecutive_losses" value="4" min="1" max="10" step="1">
                </div>
            </div>
        </div>
    </div>

    <!-- Funding Rate Settings -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-percentage"></i>
                Funding Rate Settings
            </div>
        </div>

        <div class="setting-grid">
            <div class="setting-item">
                <label class="setting-label">
                    <i class="fas fa-toggle-on"></i>
                    Funding Rate Arbitrage
                </label>
                <div class="setting-description">Enable trading based on funding rate opportunities</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="futures_funding_arb" name="futures_funding_arb">
                    <span>Disabled</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Max Funding Rate (%)</label>
                <div class="setting-description">Maximum funding rate before closing positions</div>
                <input type="number" class="setting-input" id="futures_max_funding_rate" name="futures_max_funding_rate" value="0.1" min="0.01" max="1" step="0.01">
            </div>
        </div>
    </div>
</div>

<script>
// Load current settings
async function loadSettings() {
    try {
        // First check the actual module status
        await checkModuleRunningStatus();

        const response = await fetch('/api/settings/futures');
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.settings) {
                populateSettings(data.settings);
            }
        }
    } catch (e) {
        console.error('Failed to load settings:', e);
    }
}

// Check if the module is actually running
async function checkModuleRunningStatus() {
    try {
        const response = await fetch('/api/simulator/data');
        if (response.ok) {
            const data = await response.json();
            if (data.futures && data.futures.status === 'Active') {
                // Module is running
                const statusBadge = document.getElementById('moduleStatus');
                const enabledCheckbox = document.getElementById('futures_enabled');
                const enabledLabel = document.getElementById('enabledLabel');
                const runningInfo = document.getElementById('runningInfo');
                const runningInfoText = document.getElementById('runningInfoText');

                statusBadge.className = 'status-badge status-enabled';
                statusBadge.textContent = 'RUNNING';
                enabledCheckbox.checked = true;
                enabledLabel.textContent = 'Running';
                runningInfo.style.display = 'flex';

                // Show mode info
                const mode = data.futures.mode || 'DRY_RUN';
                const network = data.futures.network || 'TESTNET';
                const exchange = data.futures.exchange || 'BINANCE';
                const positions = data.futures.active_positions || 0;
                runningInfoText.innerHTML = `<strong>Module Running:</strong> ${exchange} ${network} - ${mode} mode | ${positions} active position(s)`;
                return;
            }
        }

        // Module not running
        const statusBadge = document.getElementById('moduleStatus');
        const enabledLabel = document.getElementById('enabledLabel');
        statusBadge.className = 'status-badge status-disabled';
        statusBadge.textContent = 'OFFLINE';
        enabledLabel.textContent = 'Not Running';
    } catch (e) {
        console.log('Could not check module status:', e);
        const statusBadge = document.getElementById('moduleStatus');
        const enabledLabel = document.getElementById('enabledLabel');
        statusBadge.className = 'status-badge status-disabled';
        statusBadge.textContent = 'OFFLINE';
        enabledLabel.textContent = 'Not Running';
    }
}

function populateSettings(settings) {
    for (const [key, value] of Object.entries(settings)) {
        const element = document.getElementById(key);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }
    }
    updateModuleStatus();
    // Update TP size total after loading settings
    if (typeof updateTpSizeTotal === 'function') {
        updateTpSizeTotal();
    }
}

function updateModuleStatus() {
    // Module status is now determined by checkModuleRunningStatus()
    // This function is kept for compatibility but does not override running status
}

async function saveSettings() {
    const settings = {};
    const inputs = document.querySelectorAll('.setting-input, .setting-select, input[type="checkbox"]');

    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            settings[input.id] = input.checked;
        } else if (input.type === 'number') {
            settings[input.id] = parseFloat(input.value);
        } else {
            settings[input.id] = input.value;
        }
    });

    try {
        const response = await fetch('/api/settings/futures', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });

        if (response.ok) {
            showToast('Settings saved successfully!', 'success');
            updateModuleStatus();
        } else {
            const error = await response.json();
            showToast('Failed to save settings: ' + (error.error || 'Unknown error'), 'error');
        }
    } catch (e) {
        showToast('Error saving settings: ' + e.message, 'error');
    }
}

function resetSettings() {
    if (confirm('Reset all futures settings to defaults?')) {
        // Set default values
        document.getElementById('futures_enabled').checked = false;
        document.getElementById('futures_exchange').value = 'binance';
        document.getElementById('futures_trading_mode').value = 'paper';
        document.getElementById('futures_contract_type').value = 'perpetual';
        document.getElementById('futures_capital').value = 300;
        document.getElementById('futures_max_positions').value = 3;
        document.getElementById('futures_min_trade_size').value = 10;
        document.getElementById('futures_max_position_usd').value = 500;
        // Dynamic position sizing
        document.getElementById('futures_dynamic_position_sizing').checked = true;
        document.getElementById('futures_static_position_pct').value = 15;
        document.getElementById('futures_min_position_pct').value = 5;
        document.getElementById('futures_max_position_pct').value = 20;
        // Leverage
        document.getElementById('futures_leverage').value = 5;
        document.getElementById('futures_max_leverage').value = 10;
        document.getElementById('futures_margin_mode').value = 'isolated';
        // Risk
        document.getElementById('futures_stop_loss').value = 2;
        document.getElementById('futures_take_profit').value = 4;
        document.getElementById('futures_daily_loss_limit').value = 5;
        document.getElementById('futures_liquidation_buffer').value = 20;
        document.getElementById('futures_trailing_stop').checked = true;
        document.getElementById('futures_trailing_distance').value = 1.5;
        // Multiple TPs
        document.getElementById('futures_tp1_pct').value = 2;
        document.getElementById('futures_tp1_size_pct').value = 25;
        document.getElementById('futures_tp2_pct').value = 4;
        document.getElementById('futures_tp2_size_pct').value = 25;
        document.getElementById('futures_tp3_pct').value = 6;
        document.getElementById('futures_tp3_size_pct').value = 25;
        document.getElementById('futures_tp4_pct').value = 10;
        document.getElementById('futures_tp4_size_pct').value = 25;
        // Trading pairs
        document.getElementById('futures_allowed_pairs').value = 'BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT';
        document.getElementById('futures_both_directions').checked = true;
        document.getElementById('futures_preferred_direction').value = 'both';
        // Funding
        document.getElementById('futures_funding_arb').checked = false;
        document.getElementById('futures_max_funding_rate').value = 0.1;
        // NEW: Advanced signal filters
        document.getElementById('futures_require_trend_confirmation').checked = true;
        document.getElementById('futures_require_trend_alignment').checked = true;
        document.getElementById('futures_require_volume_confirmation').checked = true;
        document.getElementById('futures_min_volume_multiplier').value = 1.2;
        document.getElementById('futures_max_consecutive_losses').value = 4;

        updateModuleStatus();
        updateTpSizeTotal();
        showToast('Settings reset to defaults', 'info');
    }
}

// Calculate and display TP size total
function updateTpSizeTotal() {
    const tp1 = parseFloat(document.getElementById('futures_tp1_size_pct').value) || 0;
    const tp2 = parseFloat(document.getElementById('futures_tp2_size_pct').value) || 0;
    const tp3 = parseFloat(document.getElementById('futures_tp3_size_pct').value) || 0;
    const tp4 = parseFloat(document.getElementById('futures_tp4_size_pct').value) || 0;
    const total = tp1 + tp2 + tp3 + tp4;

    const totalEl = document.getElementById('tp_size_total');
    totalEl.textContent = total + '%';

    if (total === 100) {
        totalEl.style.color = '#10b981';  // Green
    } else if (total > 100) {
        totalEl.style.color = '#ef4444';  // Red
    } else {
        totalEl.style.color = '#f59e0b';  // Orange (less than 100%)
    }
}

// Add event listeners for TP size inputs
document.addEventListener('DOMContentLoaded', function() {
    ['futures_tp1_size_pct', 'futures_tp2_size_pct', 'futures_tp3_size_pct', 'futures_tp4_size_pct'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', updateTpSizeTotal);
        }
    });
});

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Load settings on page load
document.addEventListener('DOMContentLoaded', loadSettings);

// Refresh module status every 30 seconds
setInterval(checkModuleRunningStatus, 30000);
</script>
{% endblock %}
