{% extends "base.html" %}

{% block title %}AI Settings - ClaudeDex{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI Module Configuration</h5>
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
                <div class="card-body">
                    <form id="aiSettingsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3">Trading Parameters</h6>

                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="direct_trading">
                                    <label class="form-check-label" for="direct_trading">Enable Direct Trading</label>
                                    <div class="form-text">Allow AI to execute trades automatically based on sentiment.</div>
                                </div>

                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="dry_run" checked>
                                    <label class="form-check-label" for="dry_run">DRY RUN Mode</label>
                                    <div class="form-text">Simulate trades without real execution. <strong class="text-danger">Disable for LIVE trading.</strong></div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Confidence Threshold (%)</label>
                                    <input type="number" class="form-control" id="confidence_threshold" min="0" max="100">
                                    <div class="form-text">Minimum sentiment score (0-100) to trigger a trade.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Trade Amount (USD)</label>
                                    <input type="number" class="form-control" id="trade_amount_usd" step="10">
                                    <div class="form-text">Amount to invest per trade (Binance Futures margin).</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Trading Pair</label>
                                    <select class="form-select" id="trading_pair">
                                        <option value="BTCUSDT">BTC/USDT</option>
                                        <option value="ETHUSDT">ETH/USDT</option>
                                        <option value="SOLUSDT">SOL/USDT</option>
                                        <option value="BNBUSDT">BNB/USDT</option>
                                    </select>
                                    <div class="form-text">Trading pair for AI-triggered trades on Binance Futures.</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3">Analysis Settings</h6>

                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-brain me-2"></i>AI Provider</label>
                                    <select class="form-select" id="ai_provider">
                                        <option value="openai">OpenAI (GPT-3.5 Turbo)</option>
                                        <option value="claude">Anthropic (Claude 3 Haiku)</option>
                                        <option value="both">Both (Average Score)</option>
                                    </select>
                                    <div class="form-text">Select which AI model(s) to use for sentiment analysis. Using "Both" will call both APIs and average the sentiment scores.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Sentiment Source</label>
                                    <select class="form-select" id="sentiment_source">
                                        <option value="news">News Headlines</option>
                                        <option value="social">Social Media (Twitter/Reddit)</option>
                                        <option value="combined">Combined</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Analysis Interval (Minutes)</label>
                                    <input type="number" class="form-control" id="analysis_interval" min="5" step="5">
                                    <div class="form-text">How often to fetch and analyze data.</div>
                                </div>

                                <div class="alert alert-success mt-3" id="api-status">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="api-status-text">Checking API status...</span>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3"><i class="fas fa-door-open me-2"></i>Exit Strategy (Take Profit / Stop Loss)</h6>

                                <div class="mb-3">
                                    <label class="form-label">Take Profit (%)</label>
                                    <input type="number" class="form-control" id="take_profit_pct" min="1" max="100" step="1" value="5">
                                    <div class="form-text">Auto-close position when profit reaches this percentage. Default: 5%.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Stop Loss (%)</label>
                                    <input type="number" class="form-control" id="stop_loss_pct" min="1" max="50" step="1" value="3">
                                    <div class="form-text">Auto-close position when loss reaches this percentage. Default: 3%.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Max Hold Time (Hours)</label>
                                    <input type="number" class="form-control" id="max_hold_hours" min="1" max="168" step="1" value="24">
                                    <div class="form-text">Maximum time to hold a position before auto-closing. Default: 24 hours.</div>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Position Monitoring:</strong> Active positions are checked every 60 seconds. When TP, SL, or max hold time is reached, the position is automatically closed via Binance Futures API.
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3"><i class="fas fa-cog me-2"></i>Execution Settings</h6>

                                <div class="mb-3">
                                    <label class="form-label">Leverage</label>
                                    <select class="form-select" id="leverage">
                                        <option value="1">1x (No leverage)</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="5" selected>5x</option>
                                        <option value="10">10x</option>
                                        <option value="20">20x (High Risk)</option>
                                    </select>
                                    <div class="form-text">Leverage for Binance Futures positions. <strong class="text-danger">Higher leverage = higher risk.</strong></div>
                                </div>

                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Binance Futures:</strong> Trades are executed on Binance Futures. Ensure you have sufficient USDT margin and understand the risks of futures trading.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Comprehensive Guide -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i>AI Analysis Module - Complete User Guide</h5>
                </div>
                <div class="card-body">
                    <!-- Overview Section -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-brain me-2"></i>Overview</h5>
                        <p>The AI Analysis Module uses OpenAI GPT to analyze crypto news sentiment and generate trading signals. It fetches headlines from crypto news APIs, sends them to GPT-3.5-turbo for analysis, and produces a sentiment score that can trigger automated trades.</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Current Status:</strong> Operational. Runs sentiment analysis every 15 minutes to conserve API credits.
                        </div>
                    </div>

                    <!-- File Structure -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-folder-tree me-2"></i>Module Architecture</h5>
                        <div class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.85rem;">
                            modules/ai_analysis/<br>
                            ├── main_ai.py &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Entry point<br>
                            └── core/<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;└── sentiment_engine.py &nbsp;&nbsp;# Sentiment analysis + AITradeExecutor (Binance Futures)
                        </div>
                        <div class="mt-2 small text-muted">
                            <strong>Key Components:</strong> SentimentEngine (news fetching, GPT analysis), AITradeExecutor (Binance Futures execution), Position Monitor (TP/SL/Max Hold)
                        </div>
                    </div>

                    <!-- Dashboard Pages -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-desktop me-2"></i>Dashboard Pages</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Page</th><th>URL</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Dashboard</td><td><code>/ai/dashboard</code></td><td>Live signals and sentiment overview</td></tr>
                                    <tr><td>Sentiment</td><td><code>/ai/sentiment</code></td><td>Sentiment history and trends</td></tr>
                                    <tr><td>Performance</td><td><code>/ai/performance</code></td><td>AI trade performance metrics</td></tr>
                                    <tr><td>Settings</td><td><code>/ai/settings</code></td><td>This configuration page</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Settings Reference -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-sliders-h me-2"></i>Settings Reference</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Setting</th><th>Description</th><th>Recommended Value</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><strong>Enable Direct Trading</strong></td><td>Allow AI to execute trades automatically</td><td>Disabled initially</td></tr>
                                    <tr><td><strong>DRY RUN Mode</strong></td><td>Simulate trades without execution</td><td>Enabled (until tested)</td></tr>
                                    <tr><td><strong>Confidence Threshold</strong></td><td>Min sentiment score to trigger trade (0-100)</td><td>85%</td></tr>
                                    <tr><td><strong>Trade Amount (USD)</strong></td><td>Margin amount per trade</td><td>$50</td></tr>
                                    <tr><td><strong>Trading Pair</strong></td><td>Binance Futures trading pair</td><td>BTCUSDT</td></tr>
                                    <tr><td><strong>Sentiment Source</strong></td><td>Data source for analysis</td><td>Combined</td></tr>
                                    <tr><td><strong>Analysis Interval</strong></td><td>Minutes between analyses</td><td>15</td></tr>
                                    <tr class="table-info"><td colspan="3"><strong>Exit Strategy</strong></td></tr>
                                    <tr><td><strong>Take Profit %</strong></td><td>Auto-close at this profit level</td><td>5%</td></tr>
                                    <tr><td><strong>Stop Loss %</strong></td><td>Auto-close at this loss level</td><td>3%</td></tr>
                                    <tr><td><strong>Max Hold Time</strong></td><td>Maximum position duration (hours)</td><td>24 hours</td></tr>
                                    <tr><td><strong>Leverage</strong></td><td>Futures leverage multiplier</td><td>5x</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-cogs me-2"></i>How It Works</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <ol>
                                    <li><strong>Fetch News:</strong> Module calls CryptoCompare News API to get top 10 crypto headlines</li>
                                    <li><strong>LLM Analysis:</strong> Headlines sent to OpenAI GPT-3.5-turbo with prompt asking for sentiment score</li>
                                    <li><strong>Score Calculation:</strong> GPT returns a float between -1.0 (extremely bearish) and 1.0 (extremely bullish)</li>
                                    <li><strong>Store Result:</strong> Score is logged to <code>sentiment_logs</code> table in database</li>
                                    <li><strong>Trade Decision:</strong> If Direct Trading enabled and score exceeds threshold, trade is executed/simulated</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Sentiment Scale -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-tachometer-alt me-2"></i>Sentiment Score Scale</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Score Range</th><th>Interpretation</th><th>Action</th></tr>
                                </thead>
                                <tbody>
                                    <tr class="table-danger"><td>-1.0 to -0.7</td><td>Extremely Bearish</td><td>SHORT signal (if enabled)</td></tr>
                                    <tr><td>-0.7 to -0.3</td><td>Bearish</td><td>Caution</td></tr>
                                    <tr><td>-0.3 to 0.3</td><td>Neutral</td><td>HOLD</td></tr>
                                    <tr><td>0.3 to 0.7</td><td>Bullish</td><td>Caution</td></tr>
                                    <tr class="table-success"><td>0.7 to 1.0</td><td>Extremely Bullish</td><td>LONG signal (if enabled)</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Implementation Status -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-tasks me-2"></i>Implementation Status</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Feature</th><th>Status</th><th>Notes</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>News Fetching</td><td><span class="badge bg-success">Functional</span></td><td>CryptoCompare API (free tier)</td></tr>
                                    <tr><td>LLM Analysis</td><td><span class="badge bg-success">Functional</span></td><td>OpenAI GPT-3.5-turbo</td></tr>
                                    <tr><td>Sentiment Storage</td><td><span class="badge bg-success">Functional</span></td><td>Logs to sentiment_logs table</td></tr>
                                    <tr><td>Trade Logging</td><td><span class="badge bg-success">Functional</span></td><td>Stores to trades table</td></tr>
                                    <tr><td>Trade Execution (DRY RUN)</td><td><span class="badge bg-success">Functional</span></td><td>Full simulation with logging</td></tr>
                                    <tr><td>Trade Execution (LIVE)</td><td><span class="badge bg-success">Functional</span></td><td>Binance Futures API (LONG/SHORT)</td></tr>
                                    <tr><td>Exit Strategy (TP/SL)</td><td><span class="badge bg-success">Functional</span></td><td>Position monitoring every 60s</td></tr>
                                    <tr><td>Max Hold Time</td><td><span class="badge bg-success">Functional</span></td><td>Auto-close after configured hours</td></tr>
                                    <tr><td>Position Tracking</td><td><span class="badge bg-success">Functional</span></td><td>Tracks active positions in memory + DB</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Required .env Keys -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-key me-2"></i>Required Environment Variables</h5>
                        <div class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.85rem;">
                            # Required for AI Analysis<br>
                            OPENAI_API_KEY=sk-proj-...<br><br>
                            # Required for LIVE trading on Binance Futures<br>
                            BINANCE_API_KEY=your_binance_api_key<br>
                            BINANCE_SECRET_KEY=your_binance_secret_key<br><br>
                            # Optional: Alternative LLM (not yet implemented)<br>
                            ANTHROPIC_API_KEY=sk-ant-...
                        </div>
                        <div class="alert alert-success mt-2">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Status:</strong> Your OPENAI_API_KEY is configured and working.
                        </div>
                        <div class="alert alert-warning mt-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Binance Futures:</strong> Ensure your API keys have Futures trading enabled and sufficient USDT margin. Use Testnet first if available.
                        </div>
                    </div>

                    <!-- Operating Modes -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-toggle-on me-2"></i>Operating Modes</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-header"><strong>Support Tool Mode</strong></div>
                                    <div class="card-body">
                                        <p><strong>Direct Trading:</strong> Disabled</p>
                                        <ul class="mb-0">
                                            <li>Logs sentiment scores to dashboard</li>
                                            <li>Provides market insights</li>
                                            <li>No trades executed</li>
                                            <li>Use for manual trading decisions</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-header"><strong>Direct Trading Mode</strong></div>
                                    <div class="card-body">
                                        <p><strong>Direct Trading:</strong> Enabled</p>
                                        <ul class="mb-0">
                                            <li>Automatically executes trades</li>
                                            <li>BUY on high positive sentiment</li>
                                            <li>SELL on high negative sentiment</li>
                                            <li>Simulated in DRY RUN mode</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Cost Considerations -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-dollar-sign me-2"></i>API Cost Considerations</h5>
                        <div class="alert alert-warning">
                            <ul class="mb-0">
                                <li><strong>OpenAI API:</strong> GPT-3.5-turbo costs ~$0.002 per 1K tokens</li>
                                <li><strong>Default Interval:</strong> 15 minutes = ~96 calls/day = ~$0.20/day</li>
                                <li><strong>Reduce Costs:</strong> Increase analysis interval or switch to cheaper models</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Risk Warning -->
                    <div class="mb-4">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Risk Warning</h6>
                            <ul class="mb-0">
                                <li><strong>News Lag:</strong> By the time news is published, the market may have already reacted.</li>
                                <li><strong>False Signals:</strong> LLMs can misinterpret sarcasm, context, or specialized jargon.</li>
                                <li><strong>Not Financial Advice:</strong> AI sentiment should be one of many factors in trading decisions.</li>
                                <li><strong>Start with DRY RUN:</strong> Always test Direct Trading with simulated trades first.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Best Practices -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-lightbulb me-2"></i>Best Practices</h5>
                        <ul>
                            <li><strong>Confidence Threshold:</strong> Start with 85%+ to avoid false signals.</li>
                            <li><strong>Trade Amount:</strong> Keep small ($25-50) until you validate AI accuracy.</li>
                            <li><strong>Combine with Other Signals:</strong> Use AI sentiment alongside technical analysis.</li>
                            <li><strong>Review Performance:</strong> Check /ai/performance regularly to track AI accuracy.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadSettings);

    async function loadSettings() {
        try {
            const response = await fetch('/api/ai/settings');
            const data = await response.json();

            if (data.success) {
                const settings = data.settings;
                // Basic settings
                document.getElementById('direct_trading').checked = settings.direct_trading === true;
                document.getElementById('dry_run').checked = settings.dry_run !== false; // Default true
                document.getElementById('confidence_threshold').value = settings.confidence_threshold || 85;
                document.getElementById('trade_amount_usd').value = settings.trade_amount_usd || 50;
                document.getElementById('trading_pair').value = settings.trading_pair || 'BTCUSDT';
                document.getElementById('sentiment_source').value = settings.sentiment_source || 'news';
                document.getElementById('analysis_interval').value = settings.analysis_interval || 15;

                // AI Provider
                document.getElementById('ai_provider').value = settings.ai_provider || 'openai';

                // Exit strategy settings
                document.getElementById('take_profit_pct').value = settings.take_profit_pct || 5;
                document.getElementById('stop_loss_pct').value = settings.stop_loss_pct || 3;
                document.getElementById('max_hold_hours').value = settings.max_hold_hours || 24;

                // Execution settings
                document.getElementById('leverage').value = settings.leverage || 5;

                // Update API status
                updateApiStatus(settings);
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            if (typeof showNotification === 'function') {
                showNotification('Error loading settings', 'error');
            }
        }
    }

    function updateApiStatus(settings) {
        const statusEl = document.getElementById('api-status');
        const statusText = document.getElementById('api-status-text');
        const hasOpenAI = settings.openai_api_configured || false;
        const hasClaude = settings.claude_api_configured || false;

        if (hasOpenAI && hasClaude) {
            statusEl.className = 'alert alert-success mt-3';
            statusText.innerHTML = '<strong>Both APIs configured:</strong> OpenAI and Claude are ready to use.';
        } else if (hasOpenAI) {
            statusEl.className = 'alert alert-info mt-3';
            statusText.innerHTML = '<strong>OpenAI configured:</strong> Set ANTHROPIC_API_KEY in .env to enable Claude.';
        } else if (hasClaude) {
            statusEl.className = 'alert alert-info mt-3';
            statusText.innerHTML = '<strong>Claude configured:</strong> Set OPENAI_API_KEY in .env to enable OpenAI.';
        } else {
            statusEl.className = 'alert alert-danger mt-3';
            statusText.innerHTML = '<strong>No API keys configured!</strong> Add OPENAI_API_KEY and/or ANTHROPIC_API_KEY to .env file.';
        }
    }

    async function saveSettings() {
        const settings = {
            // Basic settings
            direct_trading: document.getElementById('direct_trading').checked,
            dry_run: document.getElementById('dry_run').checked,
            confidence_threshold: parseFloat(document.getElementById('confidence_threshold').value),
            trade_amount_usd: parseFloat(document.getElementById('trade_amount_usd').value),
            trading_pair: document.getElementById('trading_pair').value,
            sentiment_source: document.getElementById('sentiment_source').value,
            analysis_interval: parseInt(document.getElementById('analysis_interval').value),

            // AI Provider
            ai_provider: document.getElementById('ai_provider').value,

            // Exit strategy settings
            take_profit_pct: parseFloat(document.getElementById('take_profit_pct').value),
            stop_loss_pct: parseFloat(document.getElementById('stop_loss_pct').value),
            max_hold_hours: parseInt(document.getElementById('max_hold_hours').value),

            // Execution settings
            leverage: parseInt(document.getElementById('leverage').value)
        };

        try {
            const response = await fetch('/api/ai/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const data = await response.json();

            if (data.success) {
                alert('Settings saved successfully!');
            } else {
                alert('Error saving settings: ' + data.error);
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            alert('Error saving settings');
        }
    }
</script>
{% endblock %}
