{% extends "base.html" %}

{% block title %}Arbitrage Performance{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .page-container {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
        font-weight: 500;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-value.positive { color: #10b981; }
    .stat-value.negative { color: #ef4444; }

    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-container {
        position: relative;
        height: 350px;
        margin-top: 20px;
    }

    .chart-container-small {
        position: relative;
        height: 280px;
        margin-top: 20px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
    }

    .grid-3 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 24px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }

    .loading-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    /* Route Table Styles */
    .route-table {
        width: 100%;
        border-collapse: collapse;
    }

    .route-table th {
        background: var(--metric-bg);
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        white-space: nowrap;
        cursor: pointer;
    }

    .route-table th:hover {
        background: var(--border-color);
    }

    .route-table td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    .route-table tr:hover {
        background: var(--metric-bg);
    }

    .route-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .dex-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .win-rate-bar {
        height: 8px;
        border-radius: 4px;
        background: var(--border-color);
        overflow: hidden;
        width: 80px;
        display: inline-block;
        vertical-align: middle;
        margin-left: 8px;
    }

    .win-rate-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
        transition: width 0.3s;
    }

    .table-responsive {
        overflow-x: auto;
    }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --metric-bg: #111827;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-chart-bar"></i>
                Arbitrage Performance
            </h1>
            <p class="page-subtitle">Performance metrics calculated from arbitrage trade history</p>
        </div>
        <button class="btn btn-secondary" onclick="loadPerformance()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <!-- Overall Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="stat-pnl">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="stat-winrate">0%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Profit Factor</div>
            <div class="stat-value" id="stat-profit-factor">0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Spread</div>
            <div class="stat-value" id="stat-avg-spread">0.00%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Volume</div>
            <div class="stat-value" id="stat-volume">0.00 ETH</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="stat-total-trades">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Profit</div>
            <div class="stat-value positive" id="stat-avg-profit">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Best Trade</div>
            <div class="stat-value positive" id="stat-best-trade">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Worst Trade</div>
            <div class="stat-value negative" id="stat-worst-trade">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Best Spread</div>
            <div class="stat-value positive" id="stat-best-spread">0.00%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Trade Size</div>
            <div class="stat-value" id="stat-avg-size">0.00 ETH</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Routes</div>
            <div class="stat-value" id="stat-routes">0</div>
        </div>
    </div>

    <!-- Charts Row 1: Cumulative P&L & Daily P&L -->
    <div class="grid-2">
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-area"></i>
                Cumulative P&L
            </div>
            <div class="chart-container">
                <canvas id="cumulativePnlChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                Daily P&L
            </div>
            <div class="chart-container">
                <canvas id="dailyPnlChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Performance by Route Section -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-route"></i>
            Performance by Route
        </div>
        <div class="table-responsive">
            <table class="route-table" id="routeTable">
                <thead>
                    <tr>
                        <th onclick="sortRouteTable('route')">Route ↕</th>
                        <th onclick="sortRouteTable('trades')">Trades ↕</th>
                        <th onclick="sortRouteTable('wins')">Wins ↕</th>
                        <th onclick="sortRouteTable('winRate')">Win Rate ↕</th>
                        <th onclick="sortRouteTable('pnl')">Total P&L ↕</th>
                        <th onclick="sortRouteTable('avgPnl')">Avg P&L ↕</th>
                        <th onclick="sortRouteTable('avgSpread')">Avg Spread ↕</th>
                        <th onclick="sortRouteTable('volume')">Volume ↕</th>
                        <th onclick="sortRouteTable('bestTrade')">Best Trade ↕</th>
                    </tr>
                </thead>
                <tbody id="routeTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Row 2: Route Charts -->
    <div class="grid-3">
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                P&L by Route
            </div>
            <div class="chart-container-small">
                <canvas id="routePnlChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-percentage"></i>
                Win Rate by Route
            </div>
            <div class="chart-container-small">
                <canvas id="routeWinRateChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-pie"></i>
                Trade Distribution
            </div>
            <div class="chart-container-small">
                <canvas id="routeDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 3: Spread Analysis -->
    <div class="grid-2">
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-pie"></i>
                Win/Loss Distribution
            </div>
            <div class="chart-container" style="height: 250px; max-width: 400px; margin: 0 auto;">
                <canvas id="winLossChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                Spread Distribution
            </div>
            <div class="chart-container" style="height: 250px;">
                <canvas id="spreadDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let cumulativePnlChart = null;
let dailyPnlChart = null;
let winLossChart = null;
let routePnlChart = null;
let routeWinRateChart = null;
let routeDistributionChart = null;
let spreadDistributionChart = null;
let allTrades = [];
let routeStats = [];
let currentSort = { column: 'pnl', direction: 'desc' };

async function loadPerformance() {
    try {
        const response = await fetch('/api/arbitrage/trades?limit=2000');
        if (!response.ok) throw new Error('Failed to fetch trades');
        const data = await response.json();

        if (data.success && data.trades && data.trades.length > 0) {
            allTrades = data.trades;
            calculateAndDisplayMetrics(data.trades);
            calculateRouteMetrics(data.trades);
        } else {
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading performance:', error);
        showEmptyState();
    }
}

function showEmptyState() {
    document.getElementById('stat-pnl').textContent = '$0.00';
    document.getElementById('stat-winrate').textContent = '0%';
    document.getElementById('stat-profit-factor').textContent = '0.00';
    document.getElementById('stat-avg-spread').textContent = '0.00%';
    document.getElementById('stat-volume').textContent = '0.00 ETH';
    document.getElementById('stat-total-trades').textContent = '0';
    document.getElementById('stat-avg-profit').textContent = '$0.00';
    document.getElementById('stat-best-trade').textContent = '$0.00';
    document.getElementById('stat-worst-trade').textContent = '$0.00';
    document.getElementById('stat-best-spread').textContent = '0.00%';
    document.getElementById('stat-avg-size').textContent = '0.00 ETH';
    document.getElementById('stat-routes').textContent = '0';
    document.getElementById('routeTableBody').innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-secondary);padding:20px;">No arbitrage trades yet</td></tr>';
}

function calculateAndDisplayMetrics(trades) {
    // Sort trades by time (oldest first)
    trades.sort((a, b) => new Date(a.timestamp || a.entry_timestamp) - new Date(b.timestamp || b.entry_timestamp));

    // Calculate basic stats using arbitrage fields
    const pnls = trades.map(t => parseFloat(t.profit_loss || 0));
    const spreads = trades.map(t => parseFloat(t.spread_pct || 0));
    const volumes = trades.map(t => parseFloat(t.amount_eth || t.amount || 0));
    const wins = pnls.filter(p => p > 0);
    const losses = pnls.filter(p => p < 0);

    const totalPnl = pnls.reduce((a, b) => a + b, 0);
    const winRate = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
    const avgSpread = spreads.length > 0 ? spreads.reduce((a, b) => a + b, 0) / spreads.length : 0;
    const totalVolume = volumes.reduce((a, b) => a + b, 0);
    const avgProfit = trades.length > 0 ? totalPnl / trades.length : 0;
    const bestTrade = pnls.length > 0 ? Math.max(...pnls) : 0;
    const worstTrade = pnls.length > 0 ? Math.min(...pnls) : 0;
    const bestSpread = spreads.length > 0 ? Math.max(...spreads) : 0;
    const avgSize = trades.length > 0 ? totalVolume / trades.length : 0;

    // Calculate unique routes
    const routes = new Set();
    trades.forEach(t => {
        if (t.buy_dex && t.sell_dex) {
            routes.add(`${t.buy_dex} → ${t.sell_dex}`);
        }
    });

    // Profit Factor
    const grossProfit = wins.reduce((a, b) => a + b, 0);
    const grossLoss = Math.abs(losses.reduce((a, b) => a + b, 0));
    const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 999.99 : 0;

    // Calculate cumulative P&L
    let cumPnl = 0;
    const cumulativePnl = [0];
    pnls.forEach(pnl => {
        cumPnl += pnl;
        cumulativePnl.push(cumPnl);
    });

    // Update UI
    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = `$${totalPnl.toFixed(2)}`;
    pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

    document.getElementById('stat-winrate').textContent = winRate.toFixed(1) + '%';
    document.getElementById('stat-profit-factor').textContent = profitFactor >= 999 ? '∞' : profitFactor.toFixed(2);
    document.getElementById('stat-avg-spread').textContent = avgSpread.toFixed(2) + '%';
    document.getElementById('stat-volume').textContent = totalVolume.toFixed(4) + ' ETH';
    document.getElementById('stat-total-trades').textContent = trades.length;
    document.getElementById('stat-avg-profit').textContent = `$${avgProfit.toFixed(2)}`;
    document.getElementById('stat-best-trade').textContent = `$${bestTrade.toFixed(2)}`;
    document.getElementById('stat-worst-trade').textContent = `$${worstTrade.toFixed(2)}`;
    document.getElementById('stat-best-spread').textContent = bestSpread.toFixed(2) + '%';
    document.getElementById('stat-avg-size').textContent = avgSize.toFixed(4) + ' ETH';
    document.getElementById('stat-routes').textContent = routes.size;

    // Update charts
    updateCumulativePnlChart(trades, cumulativePnl);
    updateDailyPnlChart(trades);
    updateWinLossChart(wins.length, losses.length);
    updateSpreadDistributionChart(spreads);
}

function calculateRouteMetrics(trades) {
    // Group trades by route (buy_dex → sell_dex)
    const routeMap = {};

    trades.forEach(trade => {
        const route = `${trade.buy_dex || 'Unknown'} → ${trade.sell_dex || 'Unknown'}`;
        if (!routeMap[route]) {
            routeMap[route] = {
                route: route,
                buyDex: trade.buy_dex || 'Unknown',
                sellDex: trade.sell_dex || 'Unknown',
                trades: 0,
                wins: 0,
                totalPnl: 0,
                grossProfit: 0,
                grossLoss: 0,
                totalSpread: 0,
                totalVolume: 0,
                bestTrade: -Infinity
            };
        }

        const pnl = parseFloat(trade.profit_loss || 0);
        const spread = parseFloat(trade.spread_pct || 0);
        const volume = parseFloat(trade.amount_eth || trade.amount || 0);

        routeMap[route].trades++;
        routeMap[route].totalPnl += pnl;
        routeMap[route].totalSpread += spread;
        routeMap[route].totalVolume += volume;

        if (pnl > 0) {
            routeMap[route].wins++;
            routeMap[route].grossProfit += pnl;
        } else {
            routeMap[route].grossLoss += Math.abs(pnl);
        }

        if (pnl > routeMap[route].bestTrade) routeMap[route].bestTrade = pnl;
    });

    // Calculate derived metrics
    routeStats = Object.values(routeMap).map(r => ({
        route: r.route,
        buyDex: r.buyDex,
        sellDex: r.sellDex,
        trades: r.trades,
        wins: r.wins,
        winRate: r.trades > 0 ? (r.wins / r.trades) * 100 : 0,
        pnl: r.totalPnl,
        avgPnl: r.trades > 0 ? r.totalPnl / r.trades : 0,
        avgSpread: r.trades > 0 ? r.totalSpread / r.trades : 0,
        volume: r.totalVolume,
        profitFactor: r.grossLoss > 0 ? r.grossProfit / r.grossLoss : (r.grossProfit > 0 ? 999.99 : 0),
        bestTrade: r.bestTrade === -Infinity ? 0 : r.bestTrade
    }));

    // Sort and display
    sortRouteStats();
    updateRouteTable();
    updateRouteCharts();
}

function sortRouteStats() {
    routeStats.sort((a, b) => {
        let aVal = a[currentSort.column];
        let bVal = b[currentSort.column];

        if (typeof aVal === 'string') {
            return currentSort.direction === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        }

        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });
}

function sortRouteTable(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
    }

    sortRouteStats();
    updateRouteTable();
}

function updateRouteTable() {
    const tbody = document.getElementById('routeTableBody');

    if (routeStats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-secondary);padding:20px;">No arbitrage trades yet</td></tr>';
        return;
    }

    tbody.innerHTML = routeStats.map(r => `
        <tr>
            <td class="route-badge">
                <span class="dex-tag">${r.buyDex}</span>
                →
                <span class="dex-tag">${r.sellDex}</span>
            </td>
            <td>${r.trades}</td>
            <td class="positive">${r.wins}</td>
            <td>
                ${r.winRate.toFixed(1)}%
                <div class="win-rate-bar">
                    <div class="win-rate-bar-fill" style="width: ${r.winRate}%"></div>
                </div>
            </td>
            <td class="${r.pnl >= 0 ? 'positive' : 'negative'}">$${r.pnl.toFixed(2)}</td>
            <td class="${r.avgPnl >= 0 ? 'positive' : 'negative'}">$${r.avgPnl.toFixed(2)}</td>
            <td>${r.avgSpread.toFixed(2)}%</td>
            <td>${r.volume.toFixed(4)} ETH</td>
            <td class="positive">$${r.bestTrade.toFixed(2)}</td>
        </tr>
    `).join('');
}

function updateRouteCharts() {
    // Sort by P&L for charts
    const sortedByPnl = [...routeStats].sort((a, b) => b.pnl - a.pnl);
    const routes = sortedByPnl.map(r => r.route);
    const pnls = sortedByPnl.map(r => r.pnl);
    const winRates = sortedByPnl.map(r => r.winRate);
    const tradeCounts = sortedByPnl.map(r => r.trades);

    // P&L by Route Chart
    const pnlCtx = document.getElementById('routePnlChart').getContext('2d');
    if (routePnlChart) routePnlChart.destroy();

    routePnlChart = new Chart(pnlCtx, {
        type: 'bar',
        data: {
            labels: routes,
            datasets: [{
                label: 'P&L',
                data: pnls,
                backgroundColor: pnls.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: pnls.map(p => p >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `$${ctx.raw.toFixed(2)}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value}`
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8', font: { size: 10 } }
                }
            }
        }
    });

    // Win Rate by Route Chart
    const winRateCtx = document.getElementById('routeWinRateChart').getContext('2d');
    if (routeWinRateChart) routeWinRateChart.destroy();

    routeWinRateChart = new Chart(winRateCtx, {
        type: 'bar',
        data: {
            labels: routes,
            datasets: [{
                label: 'Win Rate',
                data: winRates,
                backgroundColor: winRates.map(wr => {
                    if (wr >= 60) return 'rgba(16, 185, 129, 0.7)';
                    if (wr >= 40) return 'rgba(245, 158, 11, 0.7)';
                    return 'rgba(239, 68, 68, 0.7)';
                }),
                borderColor: winRates.map(wr => {
                    if (wr >= 60) return '#10b981';
                    if (wr >= 40) return '#f59e0b';
                    return '#ef4444';
                }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.raw.toFixed(1)}%`
                    }
                }
            },
            scales: {
                x: {
                    max: 100,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `${value}%`
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8', font: { size: 10 } }
                }
            }
        }
    });

    // Trade Distribution Pie Chart
    const distCtx = document.getElementById('routeDistributionChart').getContext('2d');
    if (routeDistributionChart) routeDistributionChart.destroy();

    const colors = [
        '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6',
        '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
    ];

    routeDistributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: routes,
            datasets: [{
                data: tradeCounts,
                backgroundColor: colors.slice(0, routes.length),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#94a3b8',
                        boxWidth: 12,
                        padding: 8,
                        font: { size: 10 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const pct = ((ctx.raw / total) * 100).toFixed(1);
                            return `${ctx.raw} trades (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateSpreadDistributionChart(spreads) {
    const ctx = document.getElementById('spreadDistributionChart').getContext('2d');
    if (spreadDistributionChart) spreadDistributionChart.destroy();

    // Create histogram buckets for spread distribution
    const buckets = {
        '0-1%': 0,
        '1-2%': 0,
        '2-3%': 0,
        '3-4%': 0,
        '4-5%': 0,
        '5%+': 0
    };

    spreads.forEach(s => {
        if (s < 1) buckets['0-1%']++;
        else if (s < 2) buckets['1-2%']++;
        else if (s < 3) buckets['2-3%']++;
        else if (s < 4) buckets['3-4%']++;
        else if (s < 5) buckets['4-5%']++;
        else buckets['5%+']++;
    });

    spreadDistributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                label: 'Trades',
                data: Object.values(buckets),
                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                borderColor: '#8b5cf6',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.raw} trades`
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function updateCumulativePnlChart(trades, cumulativePnl) {
    const ctx = document.getElementById('cumulativePnlChart').getContext('2d');

    const labels = ['Start', ...trades.map((t, i) => {
        const date = new Date(t.timestamp || t.entry_timestamp);
        return date.toLocaleDateString();
    })];

    if (cumulativePnlChart) {
        cumulativePnlChart.destroy();
    }

    cumulativePnlChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative P&L',
                data: cumulativePnl,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value.toLocaleString()}`
                    }
                }
            }
        }
    });
}

function updateDailyPnlChart(trades) {
    const ctx = document.getElementById('dailyPnlChart').getContext('2d');

    // Group by date
    const dailyPnl = {};
    trades.forEach(t => {
        const date = new Date(t.timestamp || t.entry_timestamp).toLocaleDateString();
        if (!dailyPnl[date]) dailyPnl[date] = 0;
        dailyPnl[date] += parseFloat(t.profit_loss || 0);
    });

    const dates = Object.keys(dailyPnl);
    const pnls = Object.values(dailyPnl);

    if (dailyPnlChart) {
        dailyPnlChart.destroy();
    }

    dailyPnlChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily P&L',
                data: pnls,
                backgroundColor: pnls.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: pnls.map(p => p >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value}`
                    }
                }
            }
        }
    });
}

function updateWinLossChart(wins, losses) {
    const ctx = document.getElementById('winLossChart').getContext('2d');

    if (winLossChart) {
        winLossChart.destroy();
    }

    winLossChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Profitable', 'Loss'],
            datasets: [{
                data: [wins, losses],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#94a3b8' }
                }
            }
        }
    });
}

// Load on page load
loadPerformance();

// Auto-refresh every 60 seconds
setInterval(loadPerformance, 60000);
</script>
{% endblock %}
