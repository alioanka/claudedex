{% extends "base.html" %}

{% block title %}Arbitrage Settings - ClaudeDex{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Arbitrage Module Configuration</h5>
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
                <div class="card-body">
                    <form id="arbitrageSettingsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3">Execution Parameters</h6>

                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabled">
                                    <label class="form-check-label" for="enabled">Enable Arbitrage</label>
                                    <div class="form-text">Master switch for the arbitrage module.</div>
                                </div>

                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="dry_run" checked>
                                    <label class="form-check-label" for="dry_run">DRY RUN Mode</label>
                                    <div class="form-text">Simulate trades without real execution. <strong class="text-danger">Disable for LIVE trading.</strong></div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Min Profit Spread (%)</label>
                                    <input type="number" class="form-control" id="min_profit_spread" min="0.1" step="0.1" value="0.5">
                                    <div class="form-text">Minimum profit margin required to execute an arb (after gas + fees).</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Max Trade Amount (USD)</label>
                                    <input type="number" class="form-control" id="max_trade_amount" step="100" value="1000">
                                    <div class="form-text">Maximum trade size. Larger trades have more slippage.</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3">DEX Selection</h6>

                                <div class="mb-3">
                                    <label class="form-label">Primary DEX</label>
                                    <select class="form-select" id="primary_dex">
                                        <option value="uniswap_v3">Uniswap V3</option>
                                        <option value="sushiswap">SushiSwap</option>
                                        <option value="pancakeswap">PancakeSwap</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Secondary DEXs</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dex_uniswap" checked>
                                        <label class="form-check-label">Uniswap V3</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dex_sushi" checked>
                                        <label class="form-check-label">SushiSwap</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dex_curve">
                                        <label class="form-check-label">Curve</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3"><i class="fas fa-bolt me-2"></i>Flash Loan Settings</h6>

                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="use_flash_loans">
                                    <label class="form-check-label" for="use_flash_loans">Enable Flash Loans</label>
                                    <div class="form-text">Use Aave V3 flash loans for zero-capital arbitrage.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Flash Loan Amount (ETH)</label>
                                    <input type="number" class="form-control" id="flash_loan_amount" min="0.1" step="0.1" value="1">
                                    <div class="form-text">Amount to borrow via flash loan. Fee: 0.09% on Aave V3.</div>
                                </div>

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Flash Loans:</strong> Borrow capital instantly, execute arb, repay in same transaction. No collateral needed, but transaction reverts if unprofitable.
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-uppercase text-muted mb-3"><i class="fas fa-shield-alt me-2"></i>MEV Protection (Flashbots)</h6>

                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="use_flashbots">
                                    <label class="form-check-label" for="use_flashbots">Enable Flashbots</label>
                                    <div class="form-text">Submit transactions via Flashbots to prevent front-running.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Flashbots Max Priority Fee (Gwei)</label>
                                    <input type="number" class="form-control" id="flashbots_priority_fee" min="1" step="1" value="3">
                                    <div class="form-text">Priority fee for Flashbots bundle inclusion.</div>
                                </div>

                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Flashbots:</strong> Requires <code>FLASHBOTS_SIGNING_KEY</code> in .env. Bundles are only included if profitable for miners.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Comprehensive Guide -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i>Arbitrage Module - Complete User Guide</h5>
                </div>
                <div class="card-body">
                    <!-- Overview Section -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-balance-scale me-2"></i>Overview</h5>
                        <p>The Arbitrage Module detects price differences between DEXs and executes flash swaps for risk-free profit. It continuously monitors token prices across multiple exchanges and identifies opportunities where you can buy low on one DEX and sell high on another in a single atomic transaction.</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Current Status:</strong> Operational in DRY RUN mode. Scans WETH/USDC prices every 5 seconds.
                        </div>
                    </div>

                    <!-- File Structure -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-folder-tree me-2"></i>Module Architecture</h5>
                        <div class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.85rem;">
                            modules/arbitrage/<br>
                            ├── main_arbitrage.py &nbsp;&nbsp;&nbsp;&nbsp;# Entry point<br>
                            └── arbitrage_engine.py &nbsp;&nbsp;# ArbitrageEngine + FlashLoanExecutor + FlashbotsExecutor
                        </div>
                        <div class="mt-2 small text-muted">
                            <strong>Key Components:</strong> ArbitrageEngine (price scanning, opportunity detection), FlashLoanExecutor (Aave V3), FlashbotsExecutor (bundle submission)
                        </div>
                    </div>

                    <!-- Dashboard Pages -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-desktop me-2"></i>Dashboard Pages</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Page</th><th>URL</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Dashboard</td><td><code>/arbitrage/dashboard</code></td><td>Opportunity overview and stats</td></tr>
                                    <tr><td>Positions</td><td><code>/arbitrage/positions</code></td><td>Active arbitrage positions</td></tr>
                                    <tr><td>Trades</td><td><code>/arbitrage/trades</code></td><td>Completed arbitrage history</td></tr>
                                    <tr><td>Performance</td><td><code>/arbitrage/performance</code></td><td>P&L metrics and charts</td></tr>
                                    <tr><td>Settings</td><td><code>/arbitrage/settings</code></td><td>This configuration page</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Settings Reference -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-sliders-h me-2"></i>Settings Reference</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Setting</th><th>Description</th><th>Recommended Value</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><strong>Enable Arbitrage</strong></td><td>Master switch for the module</td><td>Enabled</td></tr>
                                    <tr><td><strong>DRY RUN Mode</strong></td><td>Simulate trades without execution</td><td>Enabled (until tested)</td></tr>
                                    <tr><td><strong>Min Profit Spread</strong></td><td>Minimum % to trigger trade</td><td>0.5-1%</td></tr>
                                    <tr><td><strong>Max Trade Amount</strong></td><td>Maximum USD per trade</td><td>$1000</td></tr>
                                    <tr><td><strong>Primary DEX</strong></td><td>Main exchange for pricing</td><td>Uniswap V3</td></tr>
                                    <tr><td><strong>Secondary DEXs</strong></td><td>Additional DEXs to compare</td><td>SushiSwap, Curve</td></tr>
                                    <tr class="table-info"><td colspan="3"><strong>Flash Loans (Aave V3)</strong></td></tr>
                                    <tr><td><strong>Enable Flash Loans</strong></td><td>Use Aave V3 for zero-capital arb</td><td>Disabled initially</td></tr>
                                    <tr><td><strong>Flash Loan Amount</strong></td><td>ETH to borrow (0.09% fee)</td><td>1-10 ETH</td></tr>
                                    <tr class="table-info"><td colspan="3"><strong>MEV Protection (Flashbots)</strong></td></tr>
                                    <tr><td><strong>Enable Flashbots</strong></td><td>Submit via Flashbots relay</td><td>Enabled for LIVE</td></tr>
                                    <tr><td><strong>Priority Fee</strong></td><td>Gwei for bundle inclusion</td><td>3-10 Gwei</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-cogs me-2"></i>How It Works</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <ol>
                                    <li><strong>Price Monitoring:</strong> Every 5 seconds, queries WETH/USDC price from multiple DEX routers</li>
                                    <li><strong>Spread Detection:</strong> Calculates price difference (spread) between best buy and best sell DEX</li>
                                    <li><strong>Opportunity Check:</strong> If spread > 0.5%, opportunity is logged</li>
                                    <li><strong>Flash Swap:</strong> In production, executes atomic swap:
                                        <ul>
                                            <li>Borrow tokens via flash loan (Aave/dYdX)</li>
                                            <li>Buy on low-price DEX</li>
                                            <li>Sell on high-price DEX</li>
                                            <li>Repay flash loan + keep profit</li>
                                        </ul>
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Arbitrage Types -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-exchange-alt me-2"></i>Arbitrage Types</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header"><strong>Spatial Arbitrage</strong></div>
                                    <div class="card-body">
                                        <p class="mb-2"><span class="badge bg-success">Implemented</span></p>
                                        <p class="mb-0">Same token, different DEXs on same chain (e.g., Uniswap vs SushiSwap)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header"><strong>Triangular Arbitrage</strong></div>
                                    <div class="card-body">
                                        <p class="mb-2"><span class="badge bg-secondary">Planned</span></p>
                                        <p class="mb-0">A→B→C→A cycle (e.g., ETH→USDC→WBTC→ETH)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header"><strong>Cross-Chain Arbitrage</strong></div>
                                    <div class="card-body">
                                        <p class="mb-2"><span class="badge bg-secondary">Planned</span></p>
                                        <p class="mb-0">Same token across chains (e.g., ETH price on Ethereum vs Arbitrum)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Implementation Status -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-tasks me-2"></i>Implementation Status</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Feature</th><th>Status</th><th>Notes</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Price Comparison (Uniswap V2)</td><td><span class="badge bg-success">Functional</span></td><td>getAmountsOut via Router ABI</td></tr>
                                    <tr><td>Opportunity Detection</td><td><span class="badge bg-success">Functional</span></td><td>Configurable threshold</td></tr>
                                    <tr><td>Status Logging</td><td><span class="badge bg-success">Functional</span></td><td>Logs to arb_trades table</td></tr>
                                    <tr><td>Trade Execution (DRY RUN)</td><td><span class="badge bg-success">Functional</span></td><td>Full simulation with P&L logging</td></tr>
                                    <tr><td>Trade Execution (LIVE)</td><td><span class="badge bg-success">Functional</span></td><td>Direct swap or flash loan execution</td></tr>
                                    <tr><td>Flash Loan Integration (Aave V3)</td><td><span class="badge bg-success">Functional</span></td><td>FlashLoanExecutor class</td></tr>
                                    <tr><td>Flashbots Bundle Submission</td><td><span class="badge bg-success">Functional</span></td><td>FlashbotsExecutor class with EIP-712 signing</td></tr>
                                    <tr><td>Multi-Chain Support</td><td><span class="badge bg-warning">Partial</span></td><td>Ethereum, Arbitrum (more coming)</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Supported DEXs -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-exchange-alt me-2"></i>Supported DEXs</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>DEX</th><th>Chain</th><th>Router Address</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Uniswap V2</td><td>Ethereum</td><td><code>0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D</code></td></tr>
                                    <tr><td>SushiSwap</td><td>Multi-chain</td><td><code>0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506</code></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Required .env Keys -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-key me-2"></i>Required Environment Variables</h5>
                        <div class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.85rem;">
                            # RPC URLs for arbitrage scanning<br>
                            ARBITRUM_RPC_URLS=https://rpc.ankr.com/arbitrum/...<br>
                            ETHEREUM_RPC_URLS=https://rpc.ankr.com/eth/...<br><br>
                            # For trade execution (required for LIVE)<br>
                            PRIVATE_KEY=... (encrypted)<br>
                            WALLET_ADDRESS=...<br><br>
                            # For Flash Loans (Aave V3)<br>
                            # No additional keys needed - uses same PRIVATE_KEY<br><br>
                            # For Flashbots MEV Protection (recommended for LIVE)<br>
                            FLASHBOTS_SIGNING_KEY=... (separate key for bundle signing)<br>
                            FLASHBOTS_RPC=https://relay.flashbots.net
                        </div>
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Flashbots Key:</strong> Generate a separate private key for Flashbots bundle signing. This can be a new wallet with no funds - it's only used for signing bundles.
                        </div>
                    </div>

                    <!-- Profitability Factors -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-chart-line me-2"></i>Profitability Factors</h5>
                        <div class="alert alert-warning">
                            <p><strong>Arbitrage profit depends on:</strong></p>
                            <ul class="mb-0">
                                <li><strong>Gas Costs:</strong> Must be lower than profit margin</li>
                                <li><strong>Slippage:</strong> Large trades move prices</li>
                                <li><strong>Competition:</strong> Other bots compete for same opportunities</li>
                                <li><strong>Flash Loan Fees:</strong> ~0.09% on Aave</li>
                                <li><strong>DEX Fees:</strong> Usually 0.3% per swap</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Risk Warning -->
                    <div class="mb-4">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Risk Warning</h6>
                            <ul class="mb-0">
                                <li><strong>MEV Competition:</strong> Sophisticated bots may front-run your transactions.</li>
                                <li><strong>Smart Contract Risk:</strong> Flash loan contracts can have vulnerabilities.</li>
                                <li><strong>Gas Wars:</strong> In competitive environments, gas costs can exceed profits.</li>
                                <li><strong>Rare Opportunities:</strong> True arbitrage opportunities on major pairs are rare due to competition.</li>
                                <li><strong>Start with DRY RUN:</strong> Always monitor in simulation mode before going live.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Best Practices -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-lightbulb me-2"></i>Best Practices</h5>
                        <ul>
                            <li><strong>Min Profit Spread:</strong> Account for gas + slippage. 0.5% is minimum, 1%+ is safer.</li>
                            <li><strong>DEX Selection:</strong> Focus on high-liquidity DEXs to reduce slippage.</li>
                            <li><strong>Token Pairs:</strong> Major pairs (ETH/USDC) have more liquidity but more competition.</li>
                            <li><strong>Timing:</strong> Opportunities often appear during high volatility or low gas periods.</li>
                            <li><strong>Flashbots:</strong> Use Flashbots bundles to avoid front-running when going live.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadSettings);

    async function loadSettings() {
        try {
            const response = await fetch('/api/arbitrage/settings');
            const data = await response.json();

            if (data.success) {
                const settings = data.settings;
                // Basic settings
                document.getElementById('enabled').checked = settings.enabled === true;
                document.getElementById('dry_run').checked = settings.dry_run !== false; // Default true
                document.getElementById('min_profit_spread').value = settings.min_profit_spread || 0.5;
                document.getElementById('max_trade_amount').value = settings.max_trade_amount || 1000;
                document.getElementById('primary_dex').value = settings.primary_dex || 'uniswap_v3';

                // DEX checkboxes
                if (settings.secondary_dexs) {
                    document.getElementById('dex_uniswap').checked = settings.secondary_dexs.includes('uniswap_v3');
                    document.getElementById('dex_sushi').checked = settings.secondary_dexs.includes('sushiswap');
                    document.getElementById('dex_curve').checked = settings.secondary_dexs.includes('curve');
                }

                // Flash loan settings
                document.getElementById('use_flash_loans').checked = settings.use_flash_loans === true;
                document.getElementById('flash_loan_amount').value = settings.flash_loan_amount || 1;

                // Flashbots settings
                document.getElementById('use_flashbots').checked = settings.use_flashbots === true;
                document.getElementById('flashbots_priority_fee').value = settings.flashbots_priority_fee || 3;
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    async function saveSettings() {
        // Collect secondary DEXs
        const secondary_dexs = [];
        if (document.getElementById('dex_uniswap').checked) secondary_dexs.push('uniswap_v3');
        if (document.getElementById('dex_sushi').checked) secondary_dexs.push('sushiswap');
        if (document.getElementById('dex_curve').checked) secondary_dexs.push('curve');

        const settings = {
            // Basic settings
            enabled: document.getElementById('enabled').checked,
            dry_run: document.getElementById('dry_run').checked,
            min_profit_spread: parseFloat(document.getElementById('min_profit_spread').value),
            max_trade_amount: parseFloat(document.getElementById('max_trade_amount').value),
            primary_dex: document.getElementById('primary_dex').value,
            secondary_dexs: secondary_dexs,

            // Flash loan settings
            use_flash_loans: document.getElementById('use_flash_loans').checked,
            flash_loan_amount: parseFloat(document.getElementById('flash_loan_amount').value),

            // Flashbots settings
            use_flashbots: document.getElementById('use_flashbots').checked,
            flashbots_priority_fee: parseInt(document.getElementById('flashbots_priority_fee').value)
        };

        try {
            const response = await fetch('/api/arbitrage/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const data = await response.json();
            if(data.success) alert('Settings saved successfully!');
            else alert('Error: ' + data.error);
        } catch (error) {
            alert('Error saving settings');
        }
    }
</script>
{% endblock %}
