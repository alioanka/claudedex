{% extends "base.html" %}

{% block title %}Copy Trading - Trade History{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .page-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-title i { color: #8b5cf6; }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 4px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
    .btn-secondary { background: var(--metric-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 14px;
        margin-bottom: 20px;
    }

    @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 14px;
        text-align: center;
    }

    .stat-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-value.positive { color: #10b981; }
    .stat-value.negative { color: #ef4444; }

    /* Filters */
    .filters-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 120px;
    }

    .filter-group label {
        display: block;
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--metric-bg);
        color: var(--text-primary);
        font-size: 0.85rem;
    }

    /* Mini Charts */
    .chart-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }

    .mini-chart-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }

    .mini-chart-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .mini-chart-title i { color: #8b5cf6; font-size: 0.8rem; }

    .mini-chart-container {
        height: 150px;
        position: relative;
    }

    /* Table Section */
    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title i { color: #8b5cf6; }

    .trade-count {
        background: rgba(139, 92, 246, 0.15);
        color: #8b5cf6;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .table-wrapper {
        overflow-x: auto;
        max-height: 500px;
        overflow-y: auto;
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
    }

    .trades-table th {
        background: var(--metric-bg);
        padding: 10px 8px;
        text-align: left;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        white-space: nowrap;
        position: sticky;
        top: 0;
        cursor: pointer;
    }

    .trades-table th:hover { background: var(--border-color); }

    .trades-table td {
        padding: 12px 8px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .trades-table tr:hover { background: var(--metric-bg); }

    .token-cell {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .token-icon-small {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
    }

    .token-info-cell h5 {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .token-address-small {
        font-family: monospace;
        font-size: 0.65rem;
        color: var(--text-secondary);
    }

    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-chain { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .badge-solana { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .badge-ethereum { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .badge-bsc { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .badge-buy { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .badge-sell { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .badge-open { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .badge-closed { background: rgba(107, 114, 128, 0.15); color: #9ca3af; }
    .badge-dry { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .badge-live { background: rgba(16, 185, 129, 0.15); color: #10b981; }

    .wallet-link {
        font-family: monospace;
        font-size: 0.8rem;
        color: #8b5cf6;
        text-decoration: none;
    }

    .wallet-link:hover { text-decoration: underline; }

    .pnl-cell {
        font-weight: 600;
    }

    .pnl-cell.positive { color: #10b981; }
    .pnl-cell.negative { color: #ef4444; }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.4;
    }

    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 16px;
    }

    .pagination button {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .pagination button:hover { background: var(--metric-bg); }
    .pagination button.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

    .positive { color: #10b981; }
    .negative { color: #ef4444; }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --metric-bg: #111827;
    }

    [data-theme="light"] {
        --card-bg: #ffffff;
        --border-color: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --metric-bg: #f3f4f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-history"></i>
                Trade History
            </h1>
            <p class="page-subtitle">Complete history of copied trades from tracked wallets</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadTrades()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <button class="btn btn-secondary" onclick="exportCSV()">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Winning</div>
            <div class="stat-value positive" id="stat-wins">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Losing</div>
            <div class="stat-value negative" id="stat-losses">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="stat-winrate">0%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="stat-pnl">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Trade</div>
            <div class="stat-value" id="stat-avg">$0.00</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label>Chain</label>
                <select id="filterChain" onchange="applyFilters()">
                    <option value="">All Chains</option>
                    <option value="solana">Solana</option>
                    <option value="ethereum">Ethereum</option>
                    <option value="bsc">BSC</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Side</label>
                <select id="filterSide" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status</label>
                <select id="filterStatus" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Result</label>
                <select id="filterResult" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="profit">Profit</option>
                    <option value="loss">Loss</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Source Wallet</label>
                <select id="filterWallet" onchange="applyFilters()">
                    <option value="">All Wallets</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="resetFilters()" style="height: 38px;">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    </div>

    <!-- Mini Charts -->
    <div class="chart-row">
        <div class="mini-chart-card">
            <div class="mini-chart-title"><i class="fas fa-chart-line"></i> Cumulative P&L</div>
            <div class="mini-chart-container"><canvas id="pnlChart"></canvas></div>
        </div>
        <div class="mini-chart-card">
            <div class="mini-chart-title"><i class="fas fa-chart-bar"></i> Daily Trade Count</div>
            <div class="mini-chart-container"><canvas id="countChart"></canvas></div>
        </div>
    </div>

    <!-- Trades Table -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-list"></i>
                Trade Log
                <span class="trade-count" id="trade-count">0</span>
            </div>
        </div>
        <div id="tradesContainer">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>No Trades Yet</h3>
                <p>Copied trades will appear here when wallets make trades</p>
            </div>
        </div>
        <div class="pagination" id="pagination" style="display: none;"></div>
    </div>
</div>

<script>
let allTrades = [];
let filteredTrades = [];
let currentPage = 1;
const tradesPerPage = 50;
let sortColumn = 'timestamp';
let sortDirection = 'desc';
let pnlChart = null;
let countChart = null;

async function loadTrades() {
    try {
        const response = await fetch('/api/copytrading/trades?limit=2000');
        const data = await response.json();

        if (data.success && data.trades) {
            allTrades = data.trades;
            populateWalletFilter(allTrades);
            applyFilters();
        } else {
            showEmpty();
        }
    } catch (error) {
        console.error('Error loading trades:', error);
        showEmpty();
    }
}

function populateWalletFilter(trades) {
    const select = document.getElementById('filterWallet');
    const wallets = [...new Set(trades.map(t => t.source_wallet).filter(Boolean))];

    select.innerHTML = '<option value="">All Wallets</option>';
    wallets.forEach(w => {
        const short = w.length > 14 ? w.substring(0, 8) + '...' + w.slice(-6) : w;
        select.innerHTML += `<option value="${w}">${short}</option>`;
    });
}

function applyFilters() {
    const chain = document.getElementById('filterChain').value.toLowerCase();
    const side = document.getElementById('filterSide').value.toLowerCase();
    const status = document.getElementById('filterStatus').value.toLowerCase();
    const result = document.getElementById('filterResult').value.toLowerCase();
    const wallet = document.getElementById('filterWallet').value;

    filteredTrades = allTrades.filter(t => {
        if (chain && (t.chain || '').toLowerCase() !== chain) return false;
        if (side && (t.side || '').toLowerCase() !== side) return false;
        if (status && (t.status || '').toLowerCase() !== status) return false;
        if (wallet && t.source_wallet !== wallet) return false;
        if (result === 'profit' && (t.profit_loss || 0) <= 0) return false;
        if (result === 'loss' && (t.profit_loss || 0) >= 0) return false;
        return true;
    });

    // Sort
    filteredTrades.sort((a, b) => {
        let aVal = a[sortColumn], bVal = b[sortColumn];
        if (sortColumn === 'timestamp') {
            aVal = new Date(aVal || 0).getTime();
            bVal = new Date(bVal || 0).getTime();
        }
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });

    currentPage = 1;
    updateStats(filteredTrades);
    updateCharts(filteredTrades);
    renderTrades();
}

function resetFilters() {
    document.getElementById('filterChain').value = '';
    document.getElementById('filterSide').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterResult').value = '';
    document.getElementById('filterWallet').value = '';
    applyFilters();
}

function updateStats(trades) {
    const wins = trades.filter(t => (t.profit_loss || 0) > 0).length;
    const losses = trades.filter(t => (t.profit_loss || 0) < 0).length;
    const totalPnl = trades.reduce((a, t) => a + (t.profit_loss || 0), 0);
    const avgTrade = trades.length > 0 ? totalPnl / trades.length : 0;
    const winRate = trades.length > 0 ? (wins / trades.length) * 100 : 0;

    document.getElementById('stat-total').textContent = trades.length;
    document.getElementById('stat-wins').textContent = wins;
    document.getElementById('stat-losses').textContent = losses;
    document.getElementById('stat-winrate').textContent = winRate.toFixed(1) + '%';

    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + Math.abs(totalPnl).toFixed(2);
    pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

    const avgEl = document.getElementById('stat-avg');
    avgEl.textContent = (avgTrade >= 0 ? '+' : '') + '$' + Math.abs(avgTrade).toFixed(2);
    avgEl.className = 'stat-value ' + (avgTrade >= 0 ? 'positive' : 'negative');
}

function updateCharts(trades) {
    // Group by date
    const dailyData = {};
    trades.forEach(t => {
        if (t.timestamp) {
            const date = new Date(t.timestamp).toLocaleDateString('en-CA');
            if (!dailyData[date]) dailyData[date] = { count: 0, pnl: 0 };
            dailyData[date].count++;
            dailyData[date].pnl += (t.profit_loss || 0);
        }
    });

    const dates = Object.keys(dailyData).sort();
    const counts = dates.map(d => dailyData[d].count);

    let cumPnl = 0;
    const cumPnls = dates.map(d => { cumPnl += dailyData[d].pnl; return cumPnl; });

    // P&L Chart
    const pnlCtx = document.getElementById('pnlChart').getContext('2d');
    if (pnlChart) pnlChart.destroy();
    pnlChart = new Chart(pnlCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                data: cumPnls,
                borderColor: cumPnl >= 0 ? '#10b981' : '#ef4444',
                backgroundColor: cumPnl >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#94a3b8', callback: v => '$' + v } }
            }
        }
    });

    // Count Chart
    const countCtx = document.getElementById('countChart').getContext('2d');
    if (countChart) countChart.destroy();
    countChart = new Chart(countCtx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                data: counts,
                backgroundColor: '#8b5cf6',
                borderRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { beginAtZero: true, grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#94a3b8' } }
            }
        }
    });
}

function renderTrades() {
    const container = document.getElementById('tradesContainer');
    document.getElementById('trade-count').textContent = filteredTrades.length;

    if (filteredTrades.length === 0) {
        showEmpty();
        document.getElementById('pagination').style.display = 'none';
        return;
    }

    const startIdx = (currentPage - 1) * tradesPerPage;
    const pageTrades = filteredTrades.slice(startIdx, startIdx + tradesPerPage);

    let html = `
        <div class="table-wrapper">
            <table class="trades-table">
                <thead>
                    <tr>
                        <th onclick="sortBy('timestamp')">Time</th>
                        <th onclick="sortBy('token_address')">Token</th>
                        <th onclick="sortBy('chain')">Chain</th>
                        <th onclick="sortBy('source_wallet')">Source Wallet</th>
                        <th onclick="sortBy('side')">Side</th>
                        <th onclick="sortBy('entry_usd')">Value</th>
                        <th onclick="sortBy('profit_loss')">P&L</th>
                        <th onclick="sortBy('status')">Status</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody>
    `;

    pageTrades.forEach(t => {
        const pnl = t.profit_loss || 0;
        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
        const chain = (t.chain || 'solana').toLowerCase();
        const side = (t.side || 'buy').toLowerCase();
        const status = (t.status || 'closed').toLowerCase();
        const symbol = t.symbol || (t.token_address ? t.token_address.substring(0, 8) : 'Token');
        const initials = symbol.substring(0, 2).toUpperCase();

        html += `
            <tr>
                <td>${t.timestamp ? formatDate(t.timestamp) : '-'}</td>
                <td>
                    <div class="token-cell">
                        <div class="token-icon-small">${initials}</div>
                        <div class="token-info-cell">
                            <h5>${symbol}</h5>
                            <div class="token-address-small">${t.token_address ? t.token_address.substring(0, 12) + '...' : '-'}</div>
                        </div>
                    </div>
                </td>
                <td><span class="badge badge-${chain}">${chain.toUpperCase()}</span></td>
                <td>
                    <a href="https://solscan.io/account/${t.source_wallet}" target="_blank" class="wallet-link">
                        ${t.source_wallet ? t.source_wallet.substring(0, 8) + '...' : '-'}
                    </a>
                </td>
                <td><span class="badge badge-${side}">${side.toUpperCase()}</span></td>
                <td>$${(t.entry_usd || t.usd_value || 0).toFixed(2)}</td>
                <td class="pnl-cell ${pnlClass}">
                    ${pnl >= 0 ? '+' : ''}$${Math.abs(pnl).toFixed(2)}
                    ${t.profit_pct ? '<small>(' + (t.profit_pct >= 0 ? '+' : '') + t.profit_pct.toFixed(1) + '%)</small>' : ''}
                </td>
                <td><span class="badge badge-${status}">${status.toUpperCase()}</span></td>
                <td><span class="badge ${t.dry_run ? 'badge-dry' : 'badge-live'}">${t.dry_run ? 'DRY RUN' : 'LIVE'}</span></td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
    renderPagination();
}

function renderPagination() {
    const totalPages = Math.ceil(filteredTrades.length / tradesPerPage);
    const pag = document.getElementById('pagination');

    if (totalPages <= 1) { pag.style.display = 'none'; return; }

    pag.style.display = 'flex';
    let html = `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;

    const start = Math.max(1, currentPage - 2);
    const end = Math.min(totalPages, currentPage + 2);
    for (let i = start; i <= end; i++) {
        html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
    }

    html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
    pag.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredTrades.length / tradesPerPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderTrades();
}

function sortBy(col) {
    if (sortColumn === col) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    else { sortColumn = col; sortDirection = 'desc'; }
    applyFilters();
}

function showEmpty() {
    document.getElementById('tradesContainer').innerHTML = `
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No Trades Found</h3>
            <p>Copied trades will appear here when wallets make trades</p>
        </div>
    `;
}

function formatDate(iso) {
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function exportCSV() {
    if (filteredTrades.length === 0) { alert('No trades to export'); return; }

    const headers = ['Timestamp', 'Token', 'Chain', 'Source Wallet', 'Side', 'Value USD', 'P&L', 'P&L %', 'Status', 'Mode'];
    const rows = filteredTrades.map(t => [
        t.timestamp || '',
        t.token_address || '',
        t.chain || 'Solana',
        t.source_wallet || '',
        t.side || 'buy',
        t.entry_usd || 0,
        t.profit_loss || 0,
        t.profit_pct || 0,
        t.status || 'closed',
        t.dry_run ? 'DRY RUN' : 'LIVE'
    ]);

    let csv = headers.join(',') + '\n';
    rows.forEach(r => { csv += r.map(v => `"${v}"`).join(',') + '\n'; });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `copytrading_trades_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Load on page load
loadTrades();

// Auto-refresh every 30 seconds
setInterval(loadTrades, 30000);
</script>
{% endblock %}
