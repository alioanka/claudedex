{% extends "base.html" %}

{% block title %}Copy Trading - Trade History{% endblock %}

{% block extra_head %}
<style>
    .page-container {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Filter Section */
    .filters-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 20px;
    }

    .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 140px;
    }

    .filter-group label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--input-bg);
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 14px;
        text-align: center;
    }

    .stat-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-value.positive { color: #10b981; }
    .stat-value.negative { color: #ef4444; }

    /* Section Card */
    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Table */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
    }

    .trades-table th {
        background: var(--metric-bg);
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.7rem;
        text-transform: uppercase;
        white-space: nowrap;
        cursor: pointer;
    }

    .trades-table th:hover {
        background: var(--border-color);
    }

    .trades-table td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .trades-table tr:hover {
        background: var(--metric-bg);
    }

    .token-cell {
        display: flex;
        flex-direction: column;
    }

    .token-symbol {
        font-weight: 600;
        color: var(--text-primary);
    }

    .token-address {
        font-family: monospace;
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .wallet-address {
        font-family: monospace;
        font-size: 0.8rem;
        color: #8b5cf6;
    }

    .chain-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .chain-solana { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .chain-ethereum { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .chain-bsc { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

    .side-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .side-buy { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .side-sell { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .status-open { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    .dry-run-badge {
        background: rgba(139, 92, 246, 0.2);
        color: #8b5cf6;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
    }

    .positive { color: #10b981; }
    .negative { color: #ef4444; }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-secondary { background: #374151; color: #e5e7eb; }
    .btn-primary { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
    .btn:hover { transform: translateY(-1px); }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
    }

    .pagination button {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
    }

    .pagination button:hover {
        background: var(--metric-bg);
    }

    .pagination button.active {
        background: #8b5cf6;
        color: white;
        border-color: #8b5cf6;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --metric-bg: #111827;
        --input-bg: #374151;
    }

    [data-theme="light"] {
        --card-bg: #ffffff;
        --border-color: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --metric-bg: #f3f4f6;
        --input-bg: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-history"></i>
                Copy Trading History
            </h1>
            <p class="page-subtitle">Complete history of copied trades</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadTrades()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <button class="btn btn-secondary" onclick="exportCSV()">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label>Chain</label>
                <select id="filterChain" onchange="applyFilters()">
                    <option value="">All Chains</option>
                    <option value="solana">Solana</option>
                    <option value="ethereum">Ethereum</option>
                    <option value="bsc">BSC</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Side</label>
                <select id="filterSide" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status</label>
                <select id="filterStatus" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Source Wallet</label>
                <select id="filterWallet" onchange="applyFilters()">
                    <option value="">All Wallets</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Result</label>
                <select id="filterResult" onchange="applyFilters()">
                    <option value="">All</option>
                    <option value="profit">Profit</option>
                    <option value="loss">Loss</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="resetFilters()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Winning</div>
            <div class="stat-value positive" id="stat-wins">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Losing</div>
            <div class="stat-value negative" id="stat-losses">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="stat-winrate">0%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="stat-pnl">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Trade</div>
            <div class="stat-value" id="stat-avg">$0.00</div>
        </div>
    </div>

    <!-- Trades Table -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-list"></i>
            Trade History (<span id="trade-count">0</span> trades)
        </div>
        <div id="tradesContainer">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>No Trades Yet</h3>
                <p>Copied trades will appear here.</p>
            </div>
        </div>
        <div class="pagination" id="pagination" style="display: none;"></div>
    </div>
</div>

<script>
let allTrades = [];
let filteredTrades = [];
let currentPage = 1;
const tradesPerPage = 50;
let sortColumn = 'timestamp';
let sortDirection = 'desc';

async function loadTrades() {
    try {
        const response = await fetch('/api/copytrading/trades?limit=2000');
        const data = await response.json();

        if (data.success && data.trades) {
            allTrades = data.trades;
            populateWalletFilter(allTrades);
            applyFilters();
        } else {
            showEmpty();
        }
    } catch (error) {
        console.error('Error loading trades:', error);
        showEmpty();
    }
}

function populateWalletFilter(trades) {
    const walletSelect = document.getElementById('filterWallet');
    const wallets = [...new Set(trades.map(t => t.source_wallet).filter(Boolean))];

    // Clear and repopulate
    walletSelect.innerHTML = '<option value="">All Wallets</option>';
    wallets.forEach(wallet => {
        const shortWallet = wallet.length > 14 ? wallet.substring(0, 8) + '...' + wallet.slice(-6) : wallet;
        walletSelect.innerHTML += `<option value="${wallet}">${shortWallet}</option>`;
    });
}

function applyFilters() {
    const chain = document.getElementById('filterChain').value.toLowerCase();
    const side = document.getElementById('filterSide').value.toLowerCase();
    const status = document.getElementById('filterStatus').value.toLowerCase();
    const wallet = document.getElementById('filterWallet').value;
    const result = document.getElementById('filterResult').value.toLowerCase();

    filteredTrades = allTrades.filter(trade => {
        if (chain && (trade.chain || '').toLowerCase() !== chain) return false;
        if (side && (trade.side || '').toLowerCase() !== side) return false;
        if (status && (trade.status || '').toLowerCase() !== status) return false;
        if (wallet && trade.source_wallet !== wallet) return false;
        if (result === 'profit' && (trade.profit_loss || 0) <= 0) return false;
        if (result === 'loss' && (trade.profit_loss || 0) >= 0) return false;
        return true;
    });

    // Sort
    filteredTrades.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];

        if (sortColumn === 'timestamp') {
            aVal = new Date(aVal || 0).getTime();
            bVal = new Date(bVal || 0).getTime();
        }

        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

        if (sortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });

    currentPage = 1;
    updateStats(filteredTrades);
    renderTrades();
}

function resetFilters() {
    document.getElementById('filterChain').value = '';
    document.getElementById('filterSide').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterWallet').value = '';
    document.getElementById('filterResult').value = '';
    applyFilters();
}

function updateStats(trades) {
    const wins = trades.filter(t => (t.profit_loss || 0) > 0).length;
    const losses = trades.filter(t => (t.profit_loss || 0) < 0).length;
    const totalPnl = trades.reduce((a, t) => a + (t.profit_loss || 0), 0);
    const avgTrade = trades.length > 0 ? totalPnl / trades.length : 0;
    const winRate = trades.length > 0 ? (wins / trades.length) * 100 : 0;

    document.getElementById('stat-total').textContent = trades.length;
    document.getElementById('stat-wins').textContent = wins;
    document.getElementById('stat-losses').textContent = losses;
    document.getElementById('stat-winrate').textContent = winRate.toFixed(1) + '%';

    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
    pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

    const avgEl = document.getElementById('stat-avg');
    avgEl.textContent = (avgTrade >= 0 ? '+' : '') + '$' + avgTrade.toFixed(2);
    avgEl.className = 'stat-value ' + (avgTrade >= 0 ? 'positive' : 'negative');
}

function renderTrades() {
    const container = document.getElementById('tradesContainer');
    const countEl = document.getElementById('trade-count');

    countEl.textContent = filteredTrades.length;

    if (filteredTrades.length === 0) {
        showEmpty();
        document.getElementById('pagination').style.display = 'none';
        return;
    }

    const startIdx = (currentPage - 1) * tradesPerPage;
    const endIdx = startIdx + tradesPerPage;
    const pageTrades = filteredTrades.slice(startIdx, endIdx);

    let html = `
        <div class="table-responsive">
            <table class="trades-table">
                <thead>
                    <tr>
                        <th onclick="sortBy('timestamp')">Time</th>
                        <th onclick="sortBy('token_address')">Token</th>
                        <th onclick="sortBy('chain')">Chain</th>
                        <th onclick="sortBy('source_wallet')">Source Wallet</th>
                        <th onclick="sortBy('side')">Side</th>
                        <th onclick="sortBy('entry_price')">Entry Price</th>
                        <th onclick="sortBy('entry_usd')">Value (USD)</th>
                        <th onclick="sortBy('profit_loss')">P&L</th>
                        <th onclick="sortBy('status')">Status</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody>
    `;

    pageTrades.forEach(trade => {
        const pnlClass = (trade.profit_loss || 0) >= 0 ? 'positive' : 'negative';
        const chainClass = 'chain-' + (trade.chain || 'solana').toLowerCase();
        const sideClass = 'side-' + (trade.side || 'buy').toLowerCase();
        const statusClass = 'status-' + (trade.status || 'closed').toLowerCase();

        html += `
            <tr>
                <td>${trade.timestamp ? formatDate(trade.timestamp) : '-'}</td>
                <td>
                    <div class="token-cell">
                        <span class="token-symbol">${trade.symbol || 'Token'}</span>
                        <span class="token-address">${trade.token_address?.substring(0, 12) || ''}...</span>
                    </div>
                </td>
                <td><span class="chain-badge ${chainClass}">${trade.chain || 'Solana'}</span></td>
                <td>
                    <span class="wallet-address">
                        ${trade.source_wallet ? trade.source_wallet.substring(0, 8) + '...' : '-'}
                    </span>
                </td>
                <td><span class="side-badge ${sideClass}">${(trade.side || 'BUY').toUpperCase()}</span></td>
                <td>$${(trade.native_price || trade.entry_price || 0).toFixed(2)}</td>
                <td>$${(trade.entry_usd || trade.usd_value || 0).toFixed(2)}</td>
                <td class="${pnlClass}">
                    ${(trade.profit_loss || 0) >= 0 ? '+' : ''}$${(trade.profit_loss || 0).toFixed(2)}
                    ${trade.profit_pct ? '(' + (trade.profit_pct >= 0 ? '+' : '') + trade.profit_pct.toFixed(1) + '%)' : ''}
                </td>
                <td><span class="status-badge ${statusClass}">${(trade.status || 'Closed').toUpperCase()}</span></td>
                <td>${trade.dry_run ? '<span class="dry-run-badge">DRY RUN</span>' : 'LIVE'}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
    renderPagination();
}

function renderPagination() {
    const totalPages = Math.ceil(filteredTrades.length / tradesPerPage);
    const paginationEl = document.getElementById('pagination');

    if (totalPages <= 1) {
        paginationEl.style.display = 'none';
        return;
    }

    paginationEl.style.display = 'flex';

    let html = `
        <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;

    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
        html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
    }

    html += `
        <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;

    paginationEl.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredTrades.length / tradesPerPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderTrades();
}

function sortBy(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'desc';
    }
    applyFilters();
}

function showEmpty() {
    document.getElementById('tradesContainer').innerHTML = `
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No Trades Found</h3>
            <p>Copied trades will appear here.</p>
        </div>
    `;
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString(undefined, {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function exportCSV() {
    if (filteredTrades.length === 0) {
        alert('No trades to export');
        return;
    }

    const headers = ['Timestamp', 'Token', 'Chain', 'Source Wallet', 'Side', 'Entry Price', 'Value USD', 'P&L', 'P&L %', 'Status', 'Mode'];
    const rows = filteredTrades.map(t => [
        t.timestamp || '',
        t.token_address || '',
        t.chain || 'Solana',
        t.source_wallet || '',
        t.side || 'buy',
        t.entry_price || 0,
        t.entry_usd || 0,
        t.profit_loss || 0,
        t.profit_pct || 0,
        t.status || 'closed',
        t.dry_run ? 'DRY RUN' : 'LIVE'
    ]);

    let csv = headers.join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(val => `"${val}"`).join(',') + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `copytrading_trades_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Load on page load
loadTrades();

// Auto-refresh every 30 seconds
setInterval(loadTrades, 30000);
</script>
{% endblock %}
