{% extends "base.html" %}

{% block title %}Full Dashboard - All Modules{% endblock %}

{% block content %}
<style>
    /* Full Dashboard Specific Styles */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    .header-title h1 { margin: 0; font-size: 1.8rem; }
    .header-title .subtitle { color: #94a3b8; margin-top: 4px; }
    .header-controls { display: flex; align-items: center; gap: 16px; }
    .last-updated { color: #64748b; font-size: 0.85rem; }
    .connection-status {
        display: flex; align-items: center; gap: 6px;
        padding: 4px 10px; border-radius: 20px; font-size: 0.75rem;
    }
    .connection-status.connected { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .connection-status.disconnected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .connection-status .pulse {
        width: 8px; height: 8px; border-radius: 50%;
        animation: pulse 2s infinite;
    }
    .connected .pulse { background: #10b981; }
    .disconnected .pulse { background: #ef4444; }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .summary-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #334155;
    }
    .summary-card.primary { border-left: 4px solid #3b82f6; }
    .summary-card.success { border-left: 4px solid #10b981; }
    .summary-card.warning { border-left: 4px solid #f59e0b; }
    .summary-card.info { border-left: 4px solid #8b5cf6; }
    .summary-card .card-icon {
        width: 40px; height: 40px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; margin-bottom: 12px;
    }
    .summary-card.primary .card-icon { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .summary-card.success .card-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .summary-card.warning .card-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .summary-card.info .card-icon { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .summary-card .card-label { color: #94a3b8; font-size: 0.85rem; margin-bottom: 4px; }
    .summary-card .card-value { font-size: 1.5rem; font-weight: 700; color: #f1f5f9; }
    .summary-card .card-sub { color: #64748b; font-size: 0.75rem; margin-top: 4px; }
    .summary-card .card-change { font-size: 0.85rem; margin-top: 8px; }
    .summary-card .card-change.positive { color: #10b981; }
    .summary-card .card-change.negative { color: #ef4444; }

    /* Module Cards Grid */
    .modules-section { margin-bottom: 32px; }
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px;
    }
    .section-header h2 { margin: 0; font-size: 1.3rem; color: #f1f5f9; }
    .modules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }
    .module-card {
        background: #1e293b;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #334155;
        transition: all 0.2s;
    }
    .module-card:hover { border-color: #475569; transform: translateY(-2px); }
    .module-card.active { border-color: #10b981; }
    .module-card.inactive { opacity: 0.6; }
    .module-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px;
    }
    .module-name { display: flex; align-items: center; gap: 10px; }
    .module-icon {
        width: 36px; height: 36px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1rem;
    }
    .module-icon.dex { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .module-icon.futures { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .module-icon.solana { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .module-icon.sniper { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .module-icon.arbitrage { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .module-icon.copytrading { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
    .module-icon.ai { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }
    .module-name h4 { margin: 0; font-size: 1rem; color: #f1f5f9; }
    .module-status {
        padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600;
        text-transform: uppercase;
    }
    .module-status.running { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .module-status.stopped { background: rgba(100, 116, 139, 0.2); color: #64748b; }
    .module-status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .module-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stat-item { }
    .stat-label { color: #64748b; font-size: 0.75rem; margin-bottom: 2px; }
    .stat-value { font-size: 1rem; font-weight: 600; color: #f1f5f9; }
    .stat-value.positive { color: #10b981; }
    .stat-value.negative { color: #ef4444; }
    .module-actions { margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155; }
    .module-actions a {
        display: block; text-align: center; padding: 8px;
        background: rgba(59, 130, 246, 0.1); color: #3b82f6;
        border-radius: 6px; text-decoration: none; font-size: 0.85rem;
        transition: background 0.2s;
    }
    .module-actions a:hover { background: rgba(59, 130, 246, 0.2); }

    /* Charts Grid */
    .charts-section { margin-bottom: 32px; }
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
    .chart-card {
        background: #1e293b;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #334155;
    }
    .chart-card.span-2 { grid-column: span 2; }
    .chart-card.span-3 { grid-column: span 3; }
    .chart-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 12px;
    }
    .chart-header h3 { margin: 0; font-size: 0.95rem; color: #f1f5f9; }
    .chart-body { height: 200px; position: relative; }
    .chart-body.tall { height: 280px; }
    .chart-loading {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #64748b;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .charts-grid { grid-template-columns: repeat(2, 1fr); }
        .chart-card.span-2, .chart-card.span-3 { grid-column: span 2; }
    }
    @media (max-width: 768px) {
        .charts-grid { grid-template-columns: 1fr; }
        .chart-card.span-2, .chart-card.span-3 { grid-column: span 1; }
        .summary-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* Refresh interval selector */
    .refresh-select {
        background: #1e293b; border: 1px solid #334155; color: #f1f5f9;
        padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
    }
</style>

<div class="dashboard-header">
    <div class="header-title">
        <h1><i class="fas fa-tachometer-alt"></i> Full Trading Dashboard</h1>
        <p class="subtitle">Real-time unified view of all trading modules</p>
    </div>
    <div class="header-controls">
        <div id="connectionStatus" class="connection-status disconnected">
            <span class="pulse"></span>
            <span class="status-text">Connecting...</span>
        </div>
        <div class="last-updated">
            <i class="fas fa-clock"></i>
            <span id="lastUpdated">--</span>
        </div>
        <select id="refreshInterval" class="refresh-select" onchange="setRefreshInterval(this.value)">
            <option value="5">5s refresh</option>
            <option value="10" selected>10s refresh</option>
            <option value="30">30s refresh</option>
            <option value="60">60s refresh</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="refreshAllData()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card primary">
        <div class="card-icon"><i class="fas fa-wallet"></i></div>
        <div class="card-label">Total Portfolio Value</div>
        <div class="card-value" id="totalPortfolioValue">$0.00</div>
        <div class="card-change" id="portfolioChange">--</div>
    </div>
    <div class="summary-card success">
        <div class="card-icon"><i class="fas fa-chart-line"></i></div>
        <div class="card-label">Total P&L</div>
        <div class="card-value" id="totalPnL">$0.00</div>
        <div class="card-sub" id="pnlPercent">0.00%</div>
    </div>
    <div class="summary-card warning">
        <div class="card-icon"><i class="fas fa-layer-group"></i></div>
        <div class="card-label">Open Positions</div>
        <div class="card-value" id="openPositions">0</div>
        <div class="card-sub" id="positionsValue">$0.00 value</div>
    </div>
    <div class="summary-card info">
        <div class="card-icon"><i class="fas fa-exchange-alt"></i></div>
        <div class="card-label">Total Trades</div>
        <div class="card-value" id="totalTrades">0</div>
        <div class="card-sub" id="winRate">0.0% win rate</div>
    </div>
    <div class="summary-card success">
        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="card-label">Active Modules</div>
        <div class="card-value" id="activeModules">0/7</div>
        <div class="card-sub" id="moduleHealth">All systems nominal</div>
    </div>
    <div class="summary-card warning">
        <div class="card-icon"><i class="fas fa-bolt"></i></div>
        <div class="card-label">24h Volume</div>
        <div class="card-value" id="dailyVolume">$0.00</div>
        <div class="card-sub" id="volumeChange">--</div>
    </div>
</div>

<!-- Module Overview Section -->
<div class="modules-section">
    <div class="section-header">
        <h2><i class="fas fa-cubes"></i> Module Overview</h2>
    </div>
    <div class="modules-grid" id="modulesGrid">
        <!-- Module cards will be injected here -->
        <div class="loading-placeholder" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading modules...</p>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
    <div class="section-header">
        <h2><i class="fas fa-chart-area"></i> Performance Analytics</h2>
    </div>
    <div class="charts-grid">
        <!-- Row 1: Equity & PnL -->
        <div class="chart-card span-2">
            <div class="chart-header"><h3>Equity Curve</h3></div>
            <div class="chart-body tall"><canvas id="chartEquity"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>P&L Distribution</h3></div>
            <div class="chart-body tall"><canvas id="chartPnlDist"></canvas></div>
        </div>

        <!-- Row 2: Module Comparison -->
        <div class="chart-card">
            <div class="chart-header"><h3>P&L by Module</h3></div>
            <div class="chart-body"><canvas id="chartModulePnl"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Win Rate by Module</h3></div>
            <div class="chart-body"><canvas id="chartModuleWinRate"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Trade Count by Module</h3></div>
            <div class="chart-body"><canvas id="chartModuleTrades"></canvas></div>
        </div>

        <!-- Row 3: Asset & Chain -->
        <div class="chart-card">
            <div class="chart-header"><h3>Asset Allocation</h3></div>
            <div class="chart-body"><canvas id="chartAssetAlloc"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Chain ROI</h3></div>
            <div class="chart-body"><canvas id="chartChainRoi"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Chain Volume</h3></div>
            <div class="chart-body"><canvas id="chartChainVol"></canvas></div>
        </div>

        <!-- Row 4: Time Analysis -->
        <div class="chart-card span-3">
            <div class="chart-header"><h3>Hourly Profitability</h3></div>
            <div class="chart-body"><canvas id="chartHourlyHeatmap"></canvas></div>
        </div>

        <!-- Row 5: Risk Metrics -->
        <div class="chart-card">
            <div class="chart-header"><h3>Avg Trade Duration</h3></div>
            <div class="chart-body"><canvas id="chartDuration"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Fee Analysis</h3></div>
            <div class="chart-body"><canvas id="chartFees"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Drawdown</h3></div>
            <div class="chart-body"><canvas id="chartDrawdown"></canvas></div>
        </div>

        <!-- Row 6: Strategy & Risk -->
        <div class="chart-card">
            <div class="chart-header"><h3>Risk/Reward Ratio</h3></div>
            <div class="chart-body"><canvas id="chartRR"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Slippage Impact</h3></div>
            <div class="chart-body"><canvas id="chartSlippage"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-header"><h3>Win/Loss Streaks</h3></div>
            <div class="chart-body"><canvas id="chartStreaks"></canvas></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
    // =============== CONFIGURATION ===============
    const ALL_MODULES = [
        { id: 'dex_trading', name: 'DEX Trading', icon: 'fa-cube', color: 'dex', dashboard: '/dashboard' },
        { id: 'futures_trading', name: 'Futures', icon: 'fa-chart-line', color: 'futures', dashboard: '/futures/dashboard' },
        { id: 'solana_strategies', name: 'Solana', icon: 'fa-coins', color: 'solana', dashboard: '/solana/dashboard' },
        { id: 'sniper', name: 'Sniper', icon: 'fa-crosshairs', color: 'sniper', dashboard: '/sniper/dashboard' },
        { id: 'arbitrage', name: 'Arbitrage', icon: 'fa-balance-scale', color: 'arbitrage', dashboard: '/arbitrage/dashboard' },
        { id: 'copy_trading', name: 'Copy Trading', icon: 'fa-user-friends', color: 'copytrading', dashboard: '/copytrading/dashboard' },
        { id: 'ai_analysis', name: 'AI Analysis', icon: 'fa-brain', color: 'ai', dashboard: '/ai/dashboard' }
    ];

    // =============== STATE ===============
    let socket = null;
    let refreshInterval = 10000;
    let refreshTimer = null;
    let charts = {};
    let moduleData = {};
    let isConnected = false;

    // =============== INITIALIZATION ===============
    document.addEventListener('DOMContentLoaded', function() {
        initializeSocketIO();
        initializeCharts();
        loadAllData();
        startRefreshTimer();
    });

    function initializeSocketIO() {
        try {
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000
            });

            socket.on('connect', () => {
                console.log('Socket.IO connected');
                isConnected = true;
                updateConnectionStatus(true);
            });

            socket.on('disconnect', () => {
                console.log('Socket.IO disconnected');
                isConnected = false;
                updateConnectionStatus(false);
            });

            socket.on('connect_error', (err) => {
                console.warn('Socket.IO connection error:', err.message);
                isConnected = false;
                updateConnectionStatus(false);
            });

            // Real-time data handlers
            socket.on('initial_data', (data) => {
                console.log('Received initial data:', data);
                if (data.portfolio) updatePortfolioSummary(data.portfolio);
            });

            socket.on('dashboard_update', (data) => {
                console.log('Dashboard update:', data);
                updateDashboardFromSocket(data);
            });

            socket.on('wallet_update', (data) => {
                console.log('Wallet update:', data);
                if (data.total_portfolio) {
                    document.getElementById('totalPortfolioValue').textContent = formatCurrency(data.total_portfolio);
                }
            });

            socket.on('performance_update', (data) => {
                console.log('Performance update:', data);
                updatePerformanceFromSocket(data);
            });

        } catch (e) {
            console.warn('Socket.IO init failed, using polling only:', e);
        }
    }

    function updateConnectionStatus(connected) {
        const el = document.getElementById('connectionStatus');
        if (connected) {
            el.className = 'connection-status connected';
            el.querySelector('.status-text').textContent = 'Live';
        } else {
            el.className = 'connection-status disconnected';
            el.querySelector('.status-text').textContent = 'Reconnecting...';
        }
    }

    function updateDashboardFromSocket(data) {
        if (data.portfolio_value !== undefined) {
            document.getElementById('totalPortfolioValue').textContent = formatCurrency(data.portfolio_value);
        }
        if (data.daily_pnl !== undefined) {
            const pnlEl = document.getElementById('totalPnL');
            pnlEl.textContent = formatCurrency(data.daily_pnl);
            pnlEl.className = data.daily_pnl >= 0 ? 'card-value positive' : 'card-value negative';
        }
        if (data.open_positions !== undefined) {
            document.getElementById('openPositions').textContent = data.open_positions;
        }
        if (data.timestamp) {
            document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleTimeString();
        }
    }

    function updatePerformanceFromSocket(data) {
        if (data.total_trades !== undefined) {
            document.getElementById('totalTrades').textContent = data.total_trades;
        }
        if (data.win_rate !== undefined) {
            document.getElementById('winRate').textContent = data.win_rate.toFixed(1) + '% win rate';
        }
    }

    // =============== DATA LOADING ===============
    async function loadAllData() {
        try {
            await Promise.all([
                loadPortfolioData(),
                loadModulesData(),
                loadChartsData()
            ]);
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        } catch (e) {
            console.error('Error loading dashboard data:', e);
        }
    }

    async function loadPortfolioData() {
        try {
            const res = await fetch('/api/wallets/aggregated-balances');
            const data = await res.json();

            if (data.success && data.data) {
                document.getElementById('totalPortfolioValue').textContent = formatCurrency(data.data.total_usd || 0);
            }

            // Also get performance summary
            const perfRes = await fetch('/api/dashboard/summary');
            const perfData = await perfRes.json();

            if (perfData.success && perfData.data) {
                const d = perfData.data;

                const pnlEl = document.getElementById('totalPnL');
                const pnl = d.total_pnl || d.realized_pnl || 0;
                pnlEl.textContent = formatCurrency(pnl);
                pnlEl.className = pnl >= 0 ? 'card-value' : 'card-value negative';

                const initial = 400;
                const pnlPct = initial > 0 ? (pnl / initial * 100) : 0;
                const pnlPctEl = document.getElementById('pnlPercent');
                pnlPctEl.textContent = (pnl >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
                pnlPctEl.className = pnl >= 0 ? 'card-sub positive' : 'card-sub negative';

                document.getElementById('openPositions').textContent = d.open_positions || 0;
                document.getElementById('totalTrades').textContent = d.total_trades || 0;
                document.getElementById('winRate').textContent = (d.win_rate || 0).toFixed(1) + '% win rate';
            }
        } catch (e) {
            console.error('Error loading portfolio data:', e);
        }
    }

    async function loadModulesData() {
        try {
            const res = await fetch('/api/modules');
            const data = await res.json();

            if (data.success) {
                moduleData = data.data?.modules || data.data || {};
                renderModuleCards(moduleData);
            }
        } catch (e) {
            console.error('Error loading modules data:', e);
            renderModuleCards({});
        }
    }

    function renderModuleCards(modulesData) {
        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        let activeCount = 0;
        let totalTrades = 0;
        let totalPnl = 0;

        ALL_MODULES.forEach(mod => {
            const data = modulesData[mod.id] || {};
            const metrics = data.metrics || { pnl: 0, total_trades: 0, win_rate: 0, positions: 0 };
            const isRunning = data.status === 'RUNNING' || data.enabled;
            const status = data.status || (isRunning ? 'RUNNING' : 'STOPPED');

            if (status === 'RUNNING') activeCount++;
            totalTrades += metrics.total_trades || 0;
            totalPnl += metrics.pnl || 0;

            const pnlClass = metrics.pnl >= 0 ? 'positive' : 'negative';

            const card = document.createElement('div');
            card.className = `module-card ${status === 'RUNNING' ? 'active' : 'inactive'}`;
            card.innerHTML = `
                <div class="module-header">
                    <div class="module-name">
                        <div class="module-icon ${mod.color}"><i class="fas ${mod.icon}"></i></div>
                        <h4>${mod.name}</h4>
                    </div>
                    <span class="module-status ${status.toLowerCase()}">${status}</span>
                </div>
                <div class="module-stats">
                    <div class="stat-item">
                        <div class="stat-label">P&L</div>
                        <div class="stat-value ${pnlClass}">${formatCurrency(metrics.pnl || 0)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value">${(metrics.win_rate || 0).toFixed(1)}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Trades</div>
                        <div class="stat-value">${metrics.total_trades || 0}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Positions</div>
                        <div class="stat-value">${metrics.positions || 0}</div>
                    </div>
                </div>
                <div class="module-actions">
                    <a href="${mod.dashboard}"><i class="fas fa-external-link-alt"></i> View Dashboard</a>
                </div>
            `;
            grid.appendChild(card);
        });

        document.getElementById('activeModules').textContent = `${activeCount}/${ALL_MODULES.length}`;
        document.getElementById('moduleHealth').textContent = activeCount === ALL_MODULES.length ? 'All systems operational' : `${ALL_MODULES.length - activeCount} module(s) offline`;
    }

    // =============== CHARTS ===============
    function initializeCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            },
            scales: {
                x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
            }
        };

        const pieOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
        };

        // Initialize empty charts
        const chartConfigs = {
            chartEquity: { type: 'line', options: { ...commonOptions, plugins: { ...commonOptions.plugins, legend: { display: true, labels: { color: '#94a3b8' } } } } },
            chartPnlDist: { type: 'doughnut', options: pieOptions },
            chartModulePnl: { type: 'bar', options: commonOptions },
            chartModuleWinRate: { type: 'bar', options: commonOptions },
            chartModuleTrades: { type: 'bar', options: commonOptions },
            chartAssetAlloc: { type: 'pie', options: pieOptions },
            chartChainRoi: { type: 'bar', options: commonOptions },
            chartChainVol: { type: 'bar', options: commonOptions },
            chartHourlyHeatmap: { type: 'bar', options: commonOptions },
            chartDuration: { type: 'bar', options: commonOptions },
            chartFees: { type: 'bar', options: commonOptions },
            chartDrawdown: { type: 'line', options: { ...commonOptions, elements: { line: { fill: true } } } },
            chartRR: { type: 'bar', options: commonOptions },
            chartSlippage: { type: 'bar', options: commonOptions },
            chartStreaks: { type: 'bar', options: commonOptions }
        };

        for (const [id, config] of Object.entries(chartConfigs)) {
            const el = document.getElementById(id);
            if (el) {
                charts[id] = new Chart(el, {
                    type: config.type,
                    data: { labels: [], datasets: [] },
                    options: config.options
                });
            }
        }
    }

    async function loadChartsData() {
        try {
            const res = await fetch('/api/dashboard/charts/full');
            const result = await res.json();

            if (result.success && result.data) {
                const data = result.data;

                // Update each chart with data
                for (const [chartId, chartData] of Object.entries(data)) {
                    if (charts[chartId] && chartData && chartData.labels) {
                        charts[chartId].data = chartData;
                        charts[chartId].update('none');
                    }
                }
            }
        } catch (e) {
            console.error('Error loading charts data:', e);
        }
    }

    // =============== REFRESH & UTILITIES ===============
    function setRefreshInterval(seconds) {
        refreshInterval = parseInt(seconds) * 1000;
        startRefreshTimer();
    }

    function startRefreshTimer() {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(() => {
            if (!isConnected) {
                // If WebSocket disconnected, use polling
                loadAllData();
            } else {
                // Just update charts periodically even with WebSocket
                loadChartsData();
            }
        }, refreshInterval);
    }

    function refreshAllData() {
        loadAllData();
    }

    function updatePortfolioSummary(portfolio) {
        if (portfolio.total_value !== undefined) {
            document.getElementById('totalPortfolioValue').textContent = formatCurrency(portfolio.total_value);
        }
        if (portfolio.realized_pnl !== undefined) {
            const pnlEl = document.getElementById('totalPnL');
            pnlEl.textContent = formatCurrency(portfolio.realized_pnl);
            pnlEl.className = portfolio.realized_pnl >= 0 ? 'card-value' : 'card-value negative';
        }
        if (portfolio.open_positions !== undefined) {
            document.getElementById('openPositions').textContent = portfolio.open_positions;
        }
    }

    function formatCurrency(val) {
        if (val === null || val === undefined) return '$0.00';
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(val);
    }
</script>
{% endblock %}
