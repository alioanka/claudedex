{% extends "base.html" %}

{% block title %}Full Dashboard - All Modules{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="header-title">
        <h1><i class="fas fa-tachometer-alt"></i> Full Trading Dashboard</h1>
        <p class="subtitle">Unified view of all trading modules, balances, and performance metrics</p>
    </div>
    <div class="header-controls">
        <div class="last-updated">
            Updated: <span id="lastUpdated">Just now</span>
        </div>
        <button class="btn btn-primary" onclick="refreshFullDashboard()">
            <i class="fas fa-sync-alt"></i> Refresh All
        </button>
    </div>
</div>

<!-- TOTAL BALANCE & SUMMARY SECTION -->
<div class="row mb-4">
    <!-- Aggregated Balance Card -->
    <div class="col-md-4">
        <div class="card balance-card gradient-primary">
            <div class="card-body">
                <h5 class="card-title text-white-50">Total Portfolio Value</h5>
                <h2 class="display-4 text-white mb-0" id="totalPortfolioValue">$0.00</h2>
                <div class="d-flex justify-content-between mt-3">
                    <div class="text-white">
                        <small>Unrealized P&L</small>
                        <div class="h5 mb-0" id="totalUnrealizedPnl">+$0.00</div>
                    </div>
                    <div class="text-white text-end">
                        <small>24h Change</small>
                        <div class="h5 mb-0" id="total24hChange">0.00%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Stats -->
    <div class="col-md-8">
        <div class="row h-100">
            <div class="col-md-3">
                <div class="metric-card h-100">
                    <div class="metric-icon success"><i class="fas fa-check-circle"></i></div>
                    <div class="metric-info">
                        <h3>Active Modules</h3>
                        <div class="metric-value" id="activeModulesCount">0/7</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card h-100">
                    <div class="metric-icon primary"><i class="fas fa-layer-group"></i></div>
                    <div class="metric-info">
                        <h3>Open Positions</h3>
                        <div class="metric-value" id="totalOpenPositions">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card h-100">
                    <div class="metric-icon warning"><i class="fas fa-exchange-alt"></i></div>
                    <div class="metric-info">
                        <h3>Total Trades</h3>
                        <div class="metric-value" id="totalTradesCount">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card h-100">
                    <div class="metric-icon info"><i class="fas fa-percentage"></i></div>
                    <div class="metric-info">
                        <h3>Avg Win Rate</h3>
                        <div class="metric-value" id="avgWinRate">0.0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODULE OVERVIEW CARDS -->
<h3 class="section-title mb-3">Module Overview</h3>
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4 mb-5" id="modulesGrid">
    <!-- Module Cards will be injected here via JS -->
    <div class="col text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- CHARTS GRID - 20 Charts Grid System -->
<h3 class="section-title mb-3">Performance Analytics</h3>
<div class="dashboard-grid">

    <!-- Row 1: PnL & Equity -->
    <div class="card col-span-2">
        <div class="card-header"><h3>Total Equity Curve</h3></div>
        <div class="card-body"><canvas id="chartEquity" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>PnL Distribution</h3></div>
        <div class="card-body"><canvas id="chartPnlDist" height="250"></canvas></div>
    </div>

    <!-- Row 2: Module Comparisons -->
    <div class="card col-span-1">
        <div class="card-header"><h3>PnL by Module</h3></div>
        <div class="card-body"><canvas id="chartModulePnl" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>Win Rate by Module</h3></div>
        <div class="card-body"><canvas id="chartModuleWinRate" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>Trade Count by Module</h3></div>
        <div class="card-body"><canvas id="chartModuleTrades" height="250"></canvas></div>
    </div>

    <!-- Row 3: Asset & Chain Analysis -->
    <div class="card col-span-1">
        <div class="card-header"><h3>Asset Allocation</h3></div>
        <div class="card-body"><canvas id="chartAssetAlloc" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>Chain Performance (ROI)</h3></div>
        <div class="card-body"><canvas id="chartChainRoi" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>Chain Volume</h3></div>
        <div class="card-body"><canvas id="chartChainVol" height="250"></canvas></div>
    </div>

    <!-- Row 4: Time Analysis -->
    <div class="card col-span-3">
        <div class="card-header"><h3>Hourly Profitability Heatmap</h3></div>
        <div class="card-body"><canvas id="chartHourlyHeatmap" height="200"></canvas></div>
    </div>

    <!-- Row 5: More Metrics -->
    <div class="card col-span-1">
        <div class="card-header"><h3>Avg Trade Duration</h3></div>
        <div class="card-body"><canvas id="chartDuration" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>Fee Analysis</h3></div>
        <div class="card-body"><canvas id="chartFees" height="250"></canvas></div>
    </div>
    <div class="card col-span-1">
        <div class="card-header"><h3>Drawdown Analysis</h3></div>
        <div class="card-body"><canvas id="chartDrawdown" height="250"></canvas></div>
    </div>

    <!-- Placeholders for remaining charts to reach ~20 -->
    <div class="card col-span-1"><div class="card-header"><h3>Strategy Comparison</h3></div><div class="card-body"><canvas id="chartStrategy" height="200"></canvas></div></div>
    <div class="card col-span-1"><div class="card-header"><h3>Risk/Reward Ratio</h3></div><div class="card-body"><canvas id="chartRR" height="200"></canvas></div></div>
    <div class="card col-span-1"><div class="card-header"><h3>Slippage Impact</h3></div><div class="card-body"><canvas id="chartSlippage" height="200"></canvas></div></div>
    <div class="card col-span-1"><div class="card-header"><h3>Win Streak</h3></div><div class="card-body"><canvas id="chartWinStreak" height="200"></canvas></div></div>
    <div class="card col-span-1"><div class="card-header"><h3>Loss Streak</h3></div><div class="card-body"><canvas id="chartLossStreak" height="200"></canvas></div></div>
    <div class="card col-span-1"><div class="card-header"><h3>Market Correlation</h3></div><div class="card-body"><canvas id="chartCorrelation" height="200"></canvas></div></div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Module Definitions
    const ALL_MODULES = [
        { id: 'dex_trading', name: 'DEX Trading', icon: 'fa-cube' },
        { id: 'futures_trading', name: 'Futures', icon: 'fa-chart-line' },
        { id: 'solana_strategies', name: 'Solana', icon: 'fa-coins' },
        { id: 'sniper', name: 'Sniper', icon: 'fa-crosshairs' },
        { id: 'ai_analysis', name: 'AI Analysis', icon: 'fa-brain' },
        { id: 'arbitrage', name: 'Arbitrage', icon: 'fa-balance-scale' },
        { id: 'copy_trading', name: 'Copy Trading', icon: 'fa-user-friends' }
    ];

    document.addEventListener('DOMContentLoaded', function() {
        loadFullDashboardData();
        initCharts();
    });

    async function loadFullDashboardData() {
        try {
            // 1. Fetch Aggregated Balances
            const balanceRes = await fetch('/api/wallets/aggregated-balances');
            const balanceData = await balanceRes.json();

            if (balanceData.success) {
                document.getElementById('totalPortfolioValue').textContent = formatCurrency(balanceData.data.total_usd || 0);
            }

            // 2. Fetch Module Data (Simulating a unified endpoint or multiple calls)
            const modulesRes = await fetch('/api/modules');
            const modulesData = await modulesRes.json();

            if (modulesData.success) {
                renderModuleCards(modulesData.data.modules);
            }

            // 3. Update Last Updated
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    function renderModuleCards(modulesData) {
        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = ''; // Clear loading spinner

        let activeCount = 0;
        let totalTrades = 0;

        ALL_MODULES.forEach(modDef => {
            const modData = modulesData[modDef.id] || {};
            const isEnabled = modData.enabled || false;
            const status = modData.status || (isEnabled ? 'RUNNING' : 'DISABLED');

            if (status === 'RUNNING') activeCount++;

            // Mock metrics if not present
            const metrics = modData.metrics || { pnl: 0, total_trades: 0, win_rate: 0 };
            totalTrades += metrics.total_trades || 0;

            const cardHtml = `
                <div class="col">
                    <div class="card h-100 module-card ${status === 'RUNNING' ? 'border-primary' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0"><i class="fas ${modDef.icon} me-2"></i>${modDef.name}</h5>
                                <span class="badge ${status === 'RUNNING' ? 'bg-success' : 'bg-secondary'}">${status}</span>
                            </div>

                            <div class="module-stats">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">P&L</span>
                                    <span class="${metrics.pnl >= 0 ? 'text-success' : 'text-danger'} fw-bold">
                                        ${formatCurrency(metrics.pnl)}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Win Rate</span>
                                    <span>${(metrics.win_rate || 0).toFixed(1)}%</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Trades</span>
                                    <span>${metrics.total_trades || 0}</span>
                                </div>
                            </div>

                            <div class="mt-3 pt-3 border-top text-center">
                                <a href="/${modDef.id.split('_')[0]}/dashboard" class="btn btn-sm btn-outline-primary w-100">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', cardHtml);
        });

        // Update Summary Counts
        document.getElementById('activeModulesCount').textContent = `${activeCount}/${ALL_MODULES.length}`;
        document.getElementById('totalTradesCount').textContent = totalTrades;
    }

    function initCharts() {
        const commonOptions = { responsive: true, maintainAspectRatio: false };

        // 1. Equity Curve
        new Chart(document.getElementById('chartEquity'), {
            type: 'line',
            data: { labels: ['Jan', 'Feb', 'Mar'], datasets: [{ label: 'Equity', data: [1000, 1200, 1150], borderColor: '#3b82f6', fill: true }] },
            options: commonOptions
        });

        // 2. Module PnL Bar
        new Chart(document.getElementById('chartModulePnl'), {
            type: 'bar',
            data: {
                labels: ['DEX', 'Futures', 'Solana', 'AI'],
                datasets: [{ label: 'PnL', data: [150, -50, 200, 30], backgroundColor: ['#10b981', '#ef4444', '#10b981', '#10b981'] }]
            },
            options: commonOptions
        });

        // Loop for other charts
        const chartIds = [
            'chartPnlDist', 'chartModuleWinRate', 'chartModuleTrades',
            'chartAssetAlloc', 'chartChainRoi', 'chartChainVol', 'chartHourlyHeatmap',
            'chartDuration', 'chartFees', 'chartDrawdown', 'chartStrategy',
            'chartRR', 'chartSlippage', 'chartWinStreak', 'chartLossStreak', 'chartCorrelation'
        ];

        chartIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                new Chart(el, {
                    type: 'bar',
                    data: { labels: ['A', 'B', 'C'], datasets: [{ label: 'Data', data: [10, 20, 15] }] },
                    options: commonOptions
                });
            }
        });
    }

    function formatCurrency(val) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
    }

    function refreshFullDashboard() {
        loadFullDashboardData();
    }
</script>
{% endblock %}
