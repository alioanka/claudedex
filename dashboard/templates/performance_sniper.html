{% extends "base.html" %}

{% block title %}Futures Performance{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .page-container {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
        font-weight: 500;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-value.positive { color: #10b981; }
    .stat-value.negative { color: #ef4444; }

    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-container {
        position: relative;
        height: 350px;
        margin-top: 20px;
    }

    .chart-container-small {
        position: relative;
        height: 280px;
        margin-top: 20px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
    }

    .grid-3 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 24px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }

    .loading-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    /* Per-Pair Table Styles */
    .pair-table {
        width: 100%;
        border-collapse: collapse;
    }

    .pair-table th {
        background: var(--metric-bg);
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        white-space: nowrap;
        cursor: pointer;
    }

    .pair-table th:hover {
        background: var(--border-color);
    }

    .pair-table th .sort-icon {
        margin-left: 4px;
        opacity: 0.5;
    }

    .pair-table th.sorted .sort-icon {
        opacity: 1;
    }

    .pair-table td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    .pair-table tr:hover {
        background: var(--metric-bg);
    }

    .pair-symbol {
        font-weight: 600;
        color: var(--text-primary);
    }

    .win-rate-bar {
        height: 8px;
        border-radius: 4px;
        background: var(--border-color);
        overflow: hidden;
        width: 80px;
        display: inline-block;
        vertical-align: middle;
        margin-left: 8px;
    }

    .win-rate-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
        transition: width 0.3s;
    }

    .table-responsive {
        overflow-x: auto;
    }

    [data-theme="dark"] {
        --card-bg: #1f2937;
        --border-color: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --metric-bg: #111827;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-chart-bar"></i>
                Futures Performance
            </h1>
            <p class="page-subtitle">Performance metrics calculated from trade history</p>
        </div>
        <button class="btn btn-secondary" onclick="loadPerformance()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <!-- Overall Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="stat-pnl">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="stat-winrate">0%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Profit Factor</div>
            <div class="stat-value" id="stat-profit-factor">0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Sharpe Ratio</div>
            <div class="stat-value" id="stat-sharpe">0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Max Drawdown</div>
            <div class="stat-value negative" id="stat-drawdown">0.00%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Sortino Ratio</div>
            <div class="stat-value" id="stat-sortino">0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Win</div>
            <div class="stat-value positive" id="stat-avg-win">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Loss</div>
            <div class="stat-value negative" id="stat-avg-loss">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Best Trade</div>
            <div class="stat-value positive" id="stat-best-trade">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Worst Trade</div>
            <div class="stat-value negative" id="stat-worst-trade">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value" id="stat-total-trades">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Current Streak</div>
            <div class="stat-value" id="stat-streak">0</div>
        </div>
    </div>

    <!-- Charts Row 1: Equity & Daily PnL -->
    <div class="grid-2">
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-area"></i>
                Equity Curve
            </div>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                Daily P&L
            </div>
            <div class="chart-container">
                <canvas id="dailyPnlChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Per-Pair Performance Section -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-coins"></i>
            Performance by Pair
        </div>
        <div class="table-responsive">
            <table class="pair-table" id="pairTable">
                <thead>
                    <tr>
                        <th onclick="sortPairTable('symbol')">Symbol <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('trades')">Trades <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('wins')">Wins <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('losses')">Losses <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('winRate')">Win Rate <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('pnl')">Total P&L <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('avgPnl')">Avg P&L <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('profitFactor')">Profit Factor <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('bestTrade')">Best Trade <span class="sort-icon">↕</span></th>
                        <th onclick="sortPairTable('worstTrade')">Worst Trade <span class="sort-icon">↕</span></th>
                    </tr>
                </thead>
                <tbody id="pairTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Row 2: Per-Pair Charts -->
    <div class="grid-3">
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                P&L by Pair
            </div>
            <div class="chart-container-small">
                <canvas id="pairPnlChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-percentage"></i>
                Win Rate by Pair
            </div>
            <div class="chart-container-small">
                <canvas id="pairWinRateChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-pie"></i>
                Trade Distribution
            </div>
            <div class="chart-container-small">
                <canvas id="pairDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Exit Reasons Analysis -->
    <div class="grid-2">
        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-chart-pie"></i>
                Win/Loss Distribution
            </div>
            <div class="chart-container" style="height: 250px; max-width: 400px; margin: 0 auto;">
                <canvas id="winLossChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="fas fa-sign-out-alt"></i>
                Exit Reasons
            </div>
            <div class="chart-container" style="height: 250px; max-width: 400px; margin: 0 auto;">
                <canvas id="exitReasonsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let equityChart = null;
let dailyPnlChart = null;
let winLossChart = null;
let pairPnlChart = null;
let pairWinRateChart = null;
let pairDistributionChart = null;
let exitReasonsChart = null;
let allTrades = [];
let pairStats = [];
let currentSort = { column: 'pnl', direction: 'desc' };

async function loadPerformance() {
    try {
        // Fetch trades from the futures module API
        const response = await fetch('/api/futures/trades?limit=1000');
        if (!response.ok) throw new Error('Failed to fetch trades');
        const data = await response.json();

        if (data.success && data.trades && data.trades.length > 0) {
            allTrades = data.trades;
            calculateAndDisplayMetrics(data.trades);
            calculatePairMetrics(data.trades);
        } else {
            // Try fallback to simulator data
            const fallbackResponse = await fetch('/api/simulator/data');
            if (fallbackResponse.ok) {
                const fallbackData = await fallbackResponse.json();
                if (fallbackData.futures && fallbackData.futures.trades && fallbackData.futures.trades.length > 0) {
                    allTrades = fallbackData.futures.trades;
                    calculateAndDisplayMetrics(fallbackData.futures.trades);
                    calculatePairMetrics(fallbackData.futures.trades);
                } else {
                    showEmptyState();
                }
            }
        }
    } catch (error) {
        console.error('Error loading performance:', error);
        showEmptyState();
    }
}

function showEmptyState() {
    document.getElementById('stat-pnl').textContent = '$0.00';
    document.getElementById('stat-winrate').textContent = '0%';
    document.getElementById('stat-profit-factor').textContent = '0.00';
    document.getElementById('stat-sharpe').textContent = '0.00';
    document.getElementById('stat-drawdown').textContent = '0.00%';
    document.getElementById('stat-sortino').textContent = '0.00';
    document.getElementById('stat-avg-win').textContent = '$0.00';
    document.getElementById('stat-avg-loss').textContent = '$0.00';
    document.getElementById('stat-best-trade').textContent = '$0.00';
    document.getElementById('stat-worst-trade').textContent = '$0.00';
    document.getElementById('stat-total-trades').textContent = '0';
    document.getElementById('stat-streak').textContent = '0';
    document.getElementById('pairTableBody').innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-secondary);padding:20px;">No trades yet</td></tr>';
}

function calculateAndDisplayMetrics(trades) {
    // Sort trades by time (oldest first)
    trades.sort((a, b) => new Date(a.closed_at || a.time || a.exit_time) - new Date(b.closed_at || b.time || b.exit_time));

    // Calculate basic stats
    const pnls = trades.map(t => t.pnl || t.net_pnl || 0);
    const wins = pnls.filter(p => p > 0);
    const losses = pnls.filter(p => p < 0);

    const totalPnl = pnls.reduce((a, b) => a + b, 0);
    const winRate = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
    const avgWin = wins.length > 0 ? wins.reduce((a, b) => a + b, 0) / wins.length : 0;
    const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((a, b) => a + b, 0) / losses.length) : 0;
    const bestTrade = pnls.length > 0 ? Math.max(...pnls) : 0;
    const worstTrade = pnls.length > 0 ? Math.min(...pnls) : 0;

    // Profit Factor
    const grossProfit = wins.reduce((a, b) => a + b, 0);
    const grossLoss = Math.abs(losses.reduce((a, b) => a + b, 0));
    const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 999.99 : 0;

    // Calculate equity curve and drawdown
    let equity = 10000; // Starting capital
    let peak = equity;
    let maxDrawdown = 0;
    const equityCurve = [equity];

    pnls.forEach(pnl => {
        equity += pnl;
        equityCurve.push(equity);
        if (equity > peak) peak = equity;
        const drawdown = (peak - equity) / peak * 100;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
    });

    // Sharpe Ratio (annualized, assuming 252 trading days)
    const avgReturn = pnls.length > 0 ? pnls.reduce((a, b) => a + b, 0) / pnls.length : 0;
    const stdDev = calculateStdDev(pnls);
    const sharpeRatio = stdDev > 0 ? (avgReturn / stdDev) * Math.sqrt(252) : 0;

    // Sortino Ratio (downside deviation only)
    const negativeReturns = pnls.filter(p => p < 0);
    const downsideDev = calculateStdDev(negativeReturns);
    const sortinoRatio = downsideDev > 0 ? (avgReturn / downsideDev) * Math.sqrt(252) : 0;

    // Current streak
    let streak = 0;
    for (let i = pnls.length - 1; i >= 0; i--) {
        if (i === pnls.length - 1) {
            streak = pnls[i] > 0 ? 1 : -1;
        } else if ((pnls[i] > 0 && streak > 0) || (pnls[i] < 0 && streak < 0)) {
            streak = streak > 0 ? streak + 1 : streak - 1;
        } else {
            break;
        }
    }

    // Update UI
    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = `$${totalPnl.toFixed(2)}`;
    pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

    document.getElementById('stat-winrate').textContent = winRate.toFixed(1) + '%';
    document.getElementById('stat-profit-factor').textContent = profitFactor >= 999 ? '∞' : profitFactor.toFixed(2);
    document.getElementById('stat-sharpe').textContent = sharpeRatio.toFixed(2);
    document.getElementById('stat-drawdown').textContent = maxDrawdown.toFixed(2) + '%';
    document.getElementById('stat-sortino').textContent = sortinoRatio.toFixed(2);
    document.getElementById('stat-avg-win').textContent = `$${avgWin.toFixed(2)}`;
    document.getElementById('stat-avg-loss').textContent = `$${avgLoss.toFixed(2)}`;
    document.getElementById('stat-best-trade').textContent = `$${bestTrade.toFixed(2)}`;
    document.getElementById('stat-worst-trade').textContent = `$${worstTrade.toFixed(2)}`;
    document.getElementById('stat-total-trades').textContent = trades.length;
    document.getElementById('stat-streak').textContent = streak > 0 ? `+${streak} wins` : streak < 0 ? `${streak} losses` : '0';

    // Update charts
    updateEquityChart(trades, equityCurve);
    updateDailyPnlChart(trades);
    updateWinLossChart(wins.length, losses.length);
    updateExitReasonsChart(trades);
}

function calculatePairMetrics(trades) {
    // Group trades by symbol
    const pairMap = {};

    trades.forEach(trade => {
        const symbol = trade.symbol;
        if (!pairMap[symbol]) {
            pairMap[symbol] = {
                symbol: symbol,
                trades: 0,
                wins: 0,
                losses: 0,
                totalPnl: 0,
                grossProfit: 0,
                grossLoss: 0,
                pnls: [],
                bestTrade: -Infinity,
                worstTrade: Infinity
            };
        }

        const pnl = trade.pnl || trade.net_pnl || 0;
        pairMap[symbol].trades++;
        pairMap[symbol].totalPnl += pnl;
        pairMap[symbol].pnls.push(pnl);

        if (pnl > 0) {
            pairMap[symbol].wins++;
            pairMap[symbol].grossProfit += pnl;
        } else {
            pairMap[symbol].losses++;
            pairMap[symbol].grossLoss += Math.abs(pnl);
        }

        if (pnl > pairMap[symbol].bestTrade) pairMap[symbol].bestTrade = pnl;
        if (pnl < pairMap[symbol].worstTrade) pairMap[symbol].worstTrade = pnl;
    });

    // Calculate derived metrics
    pairStats = Object.values(pairMap).map(pair => ({
        symbol: pair.symbol,
        trades: pair.trades,
        wins: pair.wins,
        losses: pair.losses,
        winRate: pair.trades > 0 ? (pair.wins / pair.trades) * 100 : 0,
        pnl: pair.totalPnl,
        avgPnl: pair.trades > 0 ? pair.totalPnl / pair.trades : 0,
        profitFactor: pair.grossLoss > 0 ? pair.grossProfit / pair.grossLoss : (pair.grossProfit > 0 ? 999.99 : 0),
        bestTrade: pair.bestTrade === -Infinity ? 0 : pair.bestTrade,
        worstTrade: pair.worstTrade === Infinity ? 0 : pair.worstTrade
    }));

    // Sort and display
    sortPairStats();
    updatePairTable();
    updatePairCharts();
}

function sortPairStats() {
    pairStats.sort((a, b) => {
        let aVal = a[currentSort.column];
        let bVal = b[currentSort.column];

        if (typeof aVal === 'string') {
            return currentSort.direction === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        }

        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });
}

function sortPairTable(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
    }

    sortPairStats();
    updatePairTable();

    // Update sort indicators
    document.querySelectorAll('.pair-table th').forEach(th => th.classList.remove('sorted'));
}

function updatePairTable() {
    const tbody = document.getElementById('pairTableBody');

    if (pairStats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-secondary);padding:20px;">No trades yet</td></tr>';
        return;
    }

    tbody.innerHTML = pairStats.map(pair => `
        <tr>
            <td class="pair-symbol">${pair.symbol}</td>
            <td>${pair.trades}</td>
            <td class="positive">${pair.wins}</td>
            <td class="negative">${pair.losses}</td>
            <td>
                ${pair.winRate.toFixed(1)}%
                <div class="win-rate-bar">
                    <div class="win-rate-bar-fill" style="width: ${pair.winRate}%"></div>
                </div>
            </td>
            <td class="${pair.pnl >= 0 ? 'positive' : 'negative'}">$${pair.pnl.toFixed(2)}</td>
            <td class="${pair.avgPnl >= 0 ? 'positive' : 'negative'}">$${pair.avgPnl.toFixed(2)}</td>
            <td>${pair.profitFactor >= 999 ? '∞' : pair.profitFactor.toFixed(2)}</td>
            <td class="positive">$${pair.bestTrade.toFixed(2)}</td>
            <td class="negative">$${pair.worstTrade.toFixed(2)}</td>
        </tr>
    `).join('');
}

function updatePairCharts() {
    // Sort by P&L for charts
    const sortedByPnl = [...pairStats].sort((a, b) => b.pnl - a.pnl);
    const symbols = sortedByPnl.map(p => p.symbol);
    const pnls = sortedByPnl.map(p => p.pnl);
    const winRates = sortedByPnl.map(p => p.winRate);
    const tradeCounts = sortedByPnl.map(p => p.trades);

    // P&L by Pair Chart
    const pnlCtx = document.getElementById('pairPnlChart').getContext('2d');
    if (pairPnlChart) pairPnlChart.destroy();

    pairPnlChart = new Chart(pnlCtx, {
        type: 'bar',
        data: {
            labels: symbols,
            datasets: [{
                label: 'P&L',
                data: pnls,
                backgroundColor: pnls.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: pnls.map(p => p >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `$${ctx.raw.toFixed(2)}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value}`
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });

    // Win Rate by Pair Chart
    const winRateCtx = document.getElementById('pairWinRateChart').getContext('2d');
    if (pairWinRateChart) pairWinRateChart.destroy();

    pairWinRateChart = new Chart(winRateCtx, {
        type: 'bar',
        data: {
            labels: symbols,
            datasets: [{
                label: 'Win Rate',
                data: winRates,
                backgroundColor: winRates.map(wr => {
                    if (wr >= 60) return 'rgba(16, 185, 129, 0.7)';
                    if (wr >= 40) return 'rgba(245, 158, 11, 0.7)';
                    return 'rgba(239, 68, 68, 0.7)';
                }),
                borderColor: winRates.map(wr => {
                    if (wr >= 60) return '#10b981';
                    if (wr >= 40) return '#f59e0b';
                    return '#ef4444';
                }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.raw.toFixed(1)}%`
                    }
                }
            },
            scales: {
                x: {
                    max: 100,
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `${value}%`
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });

    // Trade Distribution Pie Chart
    const distCtx = document.getElementById('pairDistributionChart').getContext('2d');
    if (pairDistributionChart) pairDistributionChart.destroy();

    const colors = [
        '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6',
        '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
    ];

    pairDistributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: symbols,
            datasets: [{
                data: tradeCounts,
                backgroundColor: colors.slice(0, symbols.length),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#94a3b8',
                        boxWidth: 12,
                        padding: 8
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const pct = ((ctx.raw / total) * 100).toFixed(1);
                            return `${ctx.label}: ${ctx.raw} trades (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateExitReasonsChart(trades) {
    const exitReasons = {};

    trades.forEach(t => {
        const reason = t.close_reason || t.exit_reason || 'unknown';
        exitReasons[reason] = (exitReasons[reason] || 0) + 1;
    });

    const labels = Object.keys(exitReasons).map(formatExitReasonLabel);
    const data = Object.values(exitReasons);

    const colors = {
        'take_profit': '#10b981',
        'take_profit_1': '#10b981',
        'take_profit_2': '#22c55e',
        'take_profit_3': '#34d399',
        'take_profit_4': '#6ee7b7',
        'stop_loss': '#ef4444',
        'trailing_stop': '#8b5cf6',
        'manual_close': '#f59e0b',
        'signal_reversal': '#6b7280',
        'signal': '#6b7280',
        'liquidation_protection': '#dc2626',
        'unknown': '#374151'
    };

    const bgColors = Object.keys(exitReasons).map(r => colors[r] || '#6b7280');

    const ctx = document.getElementById('exitReasonsChart').getContext('2d');
    if (exitReasonsChart) exitReasonsChart.destroy();

    exitReasonsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: bgColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#94a3b8' }
                }
            }
        }
    });
}

function formatExitReasonLabel(reason) {
    const labels = {
        'take_profit': 'TP Hit',
        'take_profit_1': 'TP1',
        'take_profit_2': 'TP2',
        'take_profit_3': 'TP3',
        'take_profit_4': 'TP4',
        'stop_loss': 'Stop Loss',
        'trailing_stop': 'Trailing Stop',
        'manual_close': 'Manual Close',
        'signal_reversal': 'Signal Reversal',
        'signal': 'Signal',
        'liquidation_protection': 'Liq Protection',
        'unknown': 'Unknown'
    };
    return labels[reason] || reason;
}

function calculateStdDev(arr) {
    if (arr.length === 0) return 0;
    const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
    const squaredDiffs = arr.map(x => Math.pow(x - mean, 2));
    return Math.sqrt(squaredDiffs.reduce((a, b) => a + b, 0) / arr.length);
}

function updateEquityChart(trades, equityCurve) {
    const ctx = document.getElementById('equityChart').getContext('2d');

    const labels = ['Start', ...trades.map((t, i) => {
        const date = new Date(t.closed_at || t.time || t.exit_time);
        return date.toLocaleDateString();
    })];

    if (equityChart) {
        equityChart.destroy();
    }

    equityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Equity',
                data: equityCurve,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value.toLocaleString()}`
                    }
                }
            }
        }
    });
}

function updateDailyPnlChart(trades) {
    const ctx = document.getElementById('dailyPnlChart').getContext('2d');

    // Group by date
    const dailyPnl = {};
    trades.forEach(t => {
        const date = new Date(t.closed_at || t.time || t.exit_time).toLocaleDateString();
        if (!dailyPnl[date]) dailyPnl[date] = 0;
        dailyPnl[date] += t.pnl || t.net_pnl || 0;
    });

    const dates = Object.keys(dailyPnl);
    const pnls = Object.values(dailyPnl);

    if (dailyPnlChart) {
        dailyPnlChart.destroy();
    }

    dailyPnlChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily P&L',
                data: pnls,
                backgroundColor: pnls.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: pnls.map(p => p >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value}`
                    }
                }
            }
        }
    });
}

function updateWinLossChart(wins, losses) {
    const ctx = document.getElementById('winLossChart').getContext('2d');

    if (winLossChart) {
        winLossChart.destroy();
    }

    winLossChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Wins', 'Losses'],
            datasets: [{
                data: [wins, losses],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#94a3b8' }
                }
            }
        }
    });
}

// Load on page load
loadPerformance();

// Auto-refresh every 30 seconds
setInterval(loadPerformance, 30000);
</script>
{% endblock %}
