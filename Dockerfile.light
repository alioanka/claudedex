# Lightweight Dockerfile (without TensorFlow, PyTorch)
# Use this for faster builds when you don't need deep learning features
# Build: docker build -f Dockerfile.light -t trading-bot:light .

FROM python:3.11-slim

WORKDIR /app

ENV PYTHONPATH=/app
ENV PIP_DEFAULT_TIMEOUT=100
ENV PIP_RETRIES=5

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip install --upgrade pip setuptools wheel

COPY requirements.txt .

# Core dependencies
RUN pip install --no-cache-dir \
    python-dotenv==1.0.0 \
    pyyaml==6.0.1 \
    aiohttp==3.9.1 \
    aiohttp-cors==0.7.0 \
    python-socketio==5.10.0 \
    aiofiles==23.2.1 \
    numpy==1.26.3 \
    pandas==2.1.4 \
    scipy==1.11.4 \
    TA-Lib==0.6.7 \
    && echo "✅ Core installed"

# Blockchain
RUN pip install --no-cache-dir \
    web3==6.11.4 \
    eth-account==0.10.0 \
    eth-utils==4.0.0 \
    eth-typing==4.1.0 \
    eth_abi \
    hexbytes==0.3.1 \
    hdwallet==2.2.1 \
    mnemonic==0.20 \
    solders==0.18.1 \
    base58==2.1.1 \
    && echo "✅ Blockchain installed"

# Database
RUN pip install --no-cache-dir \
    sqlalchemy==2.0.25 \
    asyncpg==0.29.0 \
    psycopg2-binary==2.9.9 \
    alembic==1.13.1 \
    redis==5.0.1 \
    aioredis \
    && echo "✅ Database installed"

# ML (lightweight - sklearn only, no deep learning)
RUN pip install --no-cache-dir \
    scikit-learn==1.4.0 \
    joblib==1.3.2 \
    lightgbm \
    xgboost \
    && echo "✅ ML installed"

# Security
RUN pip install --no-cache-dir \
    cryptography==41.0.7 \
    pynacl==1.5.0 \
    bcrypt==4.1.2 \
    pyotp==2.9.0 \
    PyJWT \
    && echo "✅ Security installed"

# Web Framework
RUN pip install --no-cache-dir \
    fastapi==0.108.0 \
    uvicorn==0.25.0 \
    websockets==12.0 \
    jinja2==3.1.3 \
    openpyxl==3.1.2 \
    && echo "✅ Web framework installed"

# Monitoring
RUN pip install --no-cache-dir \
    prometheus-client==0.19.0 \
    loguru==0.7.2 \
    python-telegram-bot==20.7 \
    tenacity==8.2.3 \
    cachetools==5.3.2 \
    python-dateutil==2.8.2 \
    pytz==2024.1 \
    pydantic==2.5.3 \
    aiohttp-sse-client \
    aiohttp-sse \
    jsonschema \
    orjson \
    psutil \
    && echo "✅ Monitoring installed"

# Verify
RUN python -c "import talib; import web3; import asyncpg; import bcrypt; print('✅ All dependencies OK')"

COPY . .

CMD ["python", "main.py", "--mode", "production"]
